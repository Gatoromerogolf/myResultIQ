<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>myResultIQ | Ind Asig</title>
    <!--begin::Primary Meta Tags-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="title" content="AdminLTE v4 | Dashboard" />
    <meta name="author" content="ColorlibHQ" />
    <meta name="description"
        content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
    <meta name="keywords"
        content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard" />

    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
        integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />

    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
        integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />

    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />

    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="../css/estilos-custom.css">

    <!-- apexcharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
        integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- jsvectormap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
        integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- AdminLTE se basa en Bootstrap, as√≠ que hay que incluirlo primero:-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--  Bootstrap Icons (Para que <i class="bi bi-..."> funcione) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!--  AdminLTE CSS (Estilos del template)-->
    <link rel="stylesheet" href="../css/adminlte.css" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- üö´üö´üö´ üö´üö´üö´  control de roles-->
    <script src="/js/auth-guard.js"></script>
    <script>
        authGuard({
            rolesPermitidos: ['administrador', 'directivo', 'responsable']
        });
    </script>
</head>
<style>
    .brand-image {
        opacity: 1 !important;
        width: 40px;
        height: auto;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
        border-radius: 6px;
        object-fit: contain;
    }

    .app-sidebar {
        height: 100vh;
        /* que ocupe toda la altura de la ventana */
        overflow-y: auto;
        /* permite scroll vertical */
        overflow-x: hidden;
        /* evita scroll horizontal */
    }

    .nav-item .nav-link {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .nav-item {
        margin-bottom: 0;
    }

    .table tbody tr {
        border-bottom: 2px solid #dee2e6;
        /* gris bootstrap */
    }

    :root {
        --bg: #c75509;
        --card: #3c0de6;
        --muted: #01050c;
        --accent: #2563eb;
    }

    body {
        background: #f4f6f9;
        font-family: Inter, ui-sans-serif, system-ui, Arial;
        color: var(--muted);
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
    }

    .card-outline-primary {
        border-top: 3px solid var(--accent) !important;
    }

    h5 {
        color: var(--muted);
        font-weight: 600;
    }

    /* --- Filtros globales --- */
    .filters-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        background: white;
        border-radius: 8px;
        padding: 10px 15px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }

    .filters-bar select {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.9rem;
    }

    .filters-bar button {
        border-radius: 6px;
        font-size: 0.9rem;
    }

    /* --- Tendencias globales --- */
    .trend-box {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-top: 10px;
        border-top: 1px solid #dee2e6;
        padding-top: 10px;
    }

    .trend-item {
        flex: 1;
    }

    .trend-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--accent);
    }

    .trend-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    /* --- Barras horizontales --- */
    .destination-row {
        margin-bottom: 12px;
    }

    .destination-label {
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .bar-container {
        width: 100%;
        background-color: #e9ecef;
        border-radius: 8px;
        height: 10px;
        overflow: hidden;
    }

    .bar-fill {
        height: 10px;
        border-radius: 8px;
        background: linear-gradient(90deg, var(--accent), #66b0ff);
    }

    /* --- Botones finales --- */
    .actions-bar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
    }

    .actions-bar button {
        border-radius: 6px;
        font-size: 0.9rem;
    }

    /* --- Insights autom√°ticos --- */
    .insight-box {
        background: #fff;
        border-left: 4px solid var(--accent);
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 12px;
    }

    .insight-title {
        font-weight: 600;
        color: var(--accent);
    }

    .insight-text {
        font-size: 0.9rem;
        color: #333;
    }

    .fila-indicador {
        cursor: pointer;
    }

    .fila-indicador:hover {
        background-color: #f0f4ff;
    }

    #chartContainer {
        width: 100%;
        max-width: 900px;
        margin: 30px auto;
    }

    /* Contenedor general */
    .indicador-meta {
        margin-top: .75rem;
        font-size: .88rem;
        color: #444;
    }

    /* ----- CONTENEDOR GENERAL ----- */
    .indicador-meta {
        margin-top: .75rem;
        font-size: .88rem;
        color: #444;
    }

    /* ----- MINI TARJETAS ----- */
    .mini-card {
        border-radius: 14px;
        padding: 14px 16px;
        min-height: 110px;
        position: relative;
        overflow: hidden;

        color: #000;
        display: flex;
        flex-direction: column;
        justify-content: space-between;

        /* Sombra suave */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .mini-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
    }

    /* ----- √çCONO DECORATIVO ----- */
    .mini-card::before {
        content: attr(data-icon);
        position: absolute;
        right: 12px;
        top: 8px;
        font-size: 2.4rem;
        opacity: 0.18;
    }

    /* ----- T√çTULO ----- */
    .mini-card h6 {
        font-size: 0.95rem;
        font-weight: 700;
        margin: 0 0 6px 0;
    }

    /* ----- CANTIDAD ----- */
    .mini-card strong {
        font-weight: 600;
    }

    /* ----- PROMEDIO ----- */
    .mini-card .value {
        font-size: 1.4rem;
        font-weight: 800;
        text-align: right;
        margin-top: 4px;
    }

    /*=========================================================
    COLORES DE TARJETAS (tipo, categor√≠a, criticidad)
    =========================================================*/

    /* 1 ‚Äî Primera columna */
    .colored-1 {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        /* azul */
    }

    /* 2 ‚Äî Segunda columna */
    .colored-2 {
        background: linear-gradient(135deg, #10b981, #065f46);
        /* verde */
    }

    /* 3 ‚Äî Tercera columna */
    .colored-3 {
        background: linear-gradient(135deg, #f59e0b, #b45309);
        /* amarillo/naranja */
    }

    /* Avatar en navbar */
    .user-avatar {
        width: 50px;
        height: 50px;
        cursor: pointer;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s;
        object-fit: cover;
        margin-top: 5px;
    }

    .user-avatar:hover {
        transform: scale(1.05);
    }

    .user-dropdown-header {
        padding: 28px 20px;
        /* M√°s espacio vertical */
    }

    .user-dropdown-header img {
        margin-bottom: 15px;
        /* M√°s separaci√≥n del texto */
    }

    /* Ajuste de texto en m√≥viles */
    @media (max-width: 576px) {
        #globalPercentText {
            font-size: 1rem !important;
        }

        #ringGlobal {
            max-width: 140px !important;
        }
    }

    .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        margin-right: 6px;
        border: 2px solid #0d6efd;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
                        </a>
                    </li>

                    <li class="nav-item d-none d-md-block">
                        <a href="#" id="btnReactivarIntro" class="nav-link"
                            title="Volver a escuchar la introducci√≥n general">
                            <i class="bi bi-soundwave me-1"></i> Reproducir introducci√≥n
                        </a>
                    </li>

                    <div class="avatar-container d-flex align-items-center gap-2 me-2">
                        <div style="position: relative;">
                            <img id="avatarAudio" src="/dist/images/avatar-neutral.svg" alt="Asistente KPI" style="width:50px; height:50px; cursor:pointer; border-radius:50%; 
                                            box-shadow:0 0 6px rgba(0,0,0,0.25); transition:transform 0.2s;"
                                title="Haz clic para escuchar la explicaci√≥n" />
                            <button id="btnDetenerVoz"
                                style="display:none; position:absolute; bottom:-5px; right:-5px; border:none; border-radius:50%; 
                                            width:26px; height:26px; background:#dc3545; color:white; font-weight:bold; cursor:pointer;">
                                ‚úï
                            </button>
                        </div>
                        <span class="fw-semibold text-secondary small">Tu Asistente personal</span>
                    </div>
                </ul>

                <ul class="navbar-nav ms-auto">
                    <!-- Usuario -->
                    <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <img id="userAvatar" src="/dist/images/default_user.jpg" class="user-avatar" alt="Usuario">
                            <span id="userName" class="d-none d-md-inline ms-2">Usuario</span>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                            <!-- Header -->
                            <li class="user-dropdown-header  text-center px-3 py-3">
                                <img id="userAvatarDropdown" style="width:150px " src="/dist/images/default_user.jpg"
                                    alt="Usuario">
                                <p id="userNameDropdown" class="mb-0 user-name" style="font-size: 18px;">
                                    Usuario
                                    <br>
                                    <small id="userRole" class="text-muted">Rol</small>
                                </p>
                            </li>
                            <!-- Body -->
                            <li class="user-dropdown-body px-2">
                                <a href="/miPerfil.html" class="dropdown-item text-start" style="font-size:16px;">
                                    <i class="fas fa-user me-2"></i> Mis datos
                                </a>

                                <a href="/cambiar-password.html" class="dropdown-item text-start"
                                    style="font-size:16px;">
                                    <i class="fas fa-key me-2"></i> Cambiar contrase√±a
                                </a>
                            </li>

                            <li>
                                <hr class="dropdown-divider">
                            </li>

                            <!-- Logout -->
                            <li>
                                <a href="#" class="dropdown-item text-start"
                                    style="font-size:18px; color:#dc3545; /* rojo Bootstrap */" data-bs-toggle="modal"
                                    data-bs-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt me-2"></i> Salir
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button"
                            title="Oculta el menu de la izquierda ampliando la pantalla central">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    <li class="nav-item d-none d-md-block">
                        <a href="#" id="btnReactivarIntro" class="nav-link"
                            title="Volver a escuchar la introducci√≥n general">
                            <i class="bi bi-soundwave me-1"></i> Reproducir introducci√≥n
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
                        </a>
                    </li>
                    <li class="nav-item dropdown1 user-menu">

                        <span class="nav-link dropdown-toggle">
                            <span class="nav-link d-none d-md-inline">Bienvenido, <strong>Daniel Gonz√°lez
                                    (ADM)</strong></span>
                            <img src="/dist/images/user6-128x128.jpg" class="user-image rounded-circle shadow"
                                style="width: 40px; height: 40px;" alt="User Image" />
                        </span>
                    </li>
                    <li>
                        <a href="#" class="nav-link " data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="fas fa-sign-out-alt me-1"></i> Salir
                        </a>
                    </li>
                </ul>
            </div>
        </nav> -->

        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="light" id="asideContainer"></aside>
        <script>
            async function cargarAside() {
                const res = await fetch('aside.html');
                const html = await res.text();
                document.getElementById('asideContainer').innerHTML = html;

                // Marcar activo seg√∫n la p√°gina actual
                const links = document.querySelectorAll('#asideContainer a');
                links.forEach(link => {
                    if (link.href === window.location.href) {
                        link.classList.add('active');
                    }
                });
            }
            cargarAside();
        </script>

        <main class="app-main">
            <!-- <body class="hold-transition layout-top-nav"> -->
            <div class="app-content-header">
                <div class="container-fluid">

                    <!-- üîπ Barra superior de filtros + Asistente -->
                    <div class="filters-bar d-flex align-items-center justify-content-between mb-3 px-3">
                        <!-- üî∏ Filtros -->
                        <div class="d-flex gap-3">
                            <h3 class="mb-0">Panel General</h3>
                        </div>
                    </div>

                    <div id="alertaCondicional" class="card border-warning mb-3 col-md-12 mt-4" style="display:none;">
                        <div class="d-flex align-items-center justify-content-center p-4">
                            <div class="d-flex align-items-center">

                                <!-- Imagen -->
                                <img src="https://cdn-icons-png.flaticon.com/512/463/463612.png" alt="Alerta"
                                    style="width: 40px; height: 40px;" class="me-3">

                                <!-- Texto -->
                                <div class="card-body p-0">
                                    <p class="card-text mb-0">
                                        <a href="kpi-ponderado.html" class="nav-link d-inline">
                                            Revisar <strong>Valoraci√≥n %</strong> por entidad y/o indicador.
                                        </a>
                                        <i class="bi bi-info-circle-fill text-primary ms-2" role="button"
                                            data-bs-toggle="modal" data-bs-target="#infoModal"></i>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Informaci√≥n para revisar Valoraci√≥n % -->
                    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="infoModalLabel">¬øPor qu√© aparece esta advertencia?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Cerrar"></button>
                                </div>
                                <div class="modal-body">
                                    Esta advertencia se√±ala que alguna modificaci√≥n en los destinos o indicadores
                                    (agregado, eliminaci√≥n o modificaci√≥n de valores), ha
                                    provocado que la valoraci√≥n porcentual no totalice el 100% por nivel.<br>
                                    Se pueden consultar los indicadores afectados en el detalle, en el siguiente bot√≥n.
                                </div>
                                <div class="modal-footer">
                                    <a href="kpi-ponderado.html" class="btn btn-primary">
                                        Ir a Valoraci√≥n %
                                    </a>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- === Cumplimiento Global + Evoluci√≥n === -->
                    <!-- Tarjeta Cumplimiento Global -->
                    <div class="row">
                        <!-- Tarjeta Cumplimiento Global -->
                        <div class="col-12 col-md-4 mb-4 mt-3">
                            <div class="card card-primary card-outline card-shadow">
                                <div class="card-body">
                                    <h5 class="card-title mb-4 text-start">
                                        üåê Cumplimiento Global de la Organizaci√≥n
                                    </h5>
                                    <div class="d-flex justify-content-center my-4 w-100">
                                        <svg id="ringGlobal" viewBox="0 0 300 300"
                                            style="width:100%; max-width:300px; height:auto;"></svg>
                                    </div>
                                    <!-- Link a vista completa alineado a la derecha -->
                                    <div class="d-flex justify-content-end mt-3">
                                        <a href="kpi-dashboard-global.html" class="btn btn-sm btn-outline-primary">
                                            Ver detalle completo
                                        </a>
                                    </div>
                                </div>

                                <!-- Trend box -->
                                <div class="trend-box d-flex justify-content-around p-3 border-top">
                                    <div class="trend-item text-center">
                                        <div class="trend-value text-success" id="vsMesAnterior">+3.2%</div>
                                        <div class="trend-label">vs. mes anterior</div>
                                    </div>
                                    <div class="trend-item text-center">
                                        <div class="trend-value text-primary" id="promHistorico">84%</div>
                                        <div class="trend-label">Promedio hist√≥rico</div>
                                    </div>
                                    <div class="trend-item text-center">
                                        <div class="trend-value text-primary" id="promAnual">84%</div>
                                        <div class="trend-label">Promedio anual</div>
                                    </div>
                                    <div class="trend-item text-center">
                                        <div class="trend-value text-danger" id="tendencia">‚Äì1.1%</div>
                                        <div class="trend-label">Tendencia</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta Evoluci√≥n del Cumplimiento Global -->
                        <div class="col-12 col-md-8 mb-4 mt-3">
                            <div class="card card-primary card-outline card-shadow">
                                <div class="card-body">
                                    <h5 class="card-title mb-4 text-start">
                                        üìà Evoluci√≥n del Cumplimiento Global
                                    </h5>
                                    <div id="chartContainer" style="height: 400px;">
                                        <canvas id="evolucionChart"></canvas>
                                    </div>
                                </div>
                                <div class="text-center mb-3">
                                    <button id="btnActualizar" class="btn btn-outline-primary">
                                        üîÑ Actualizar gr√°fico
                                    </button>
                                </div>
                                <script>document.getElementById("btnActualizar").addEventListener("click", () => {
                                        location.reload(); // üîÅ recarga completa
                                    });
                                </script>
                            </div>
                        </div>
                    </div>

                    <!--Panel Balance Scorecard-->
                    <div class="row">
                        <!-- <div class="card mt-4 shadow-sm border-0"> -->
                        <div class="col-md-12">
                            <!-- <div class="card-body"> -->
                            <div class="card card-primary card-outline">
                                <div class="card-header">
                                    <h5 class="card-title">üìà <strong>BALANCE SCORECARD</strong> - Cumplimiento Promedio
                                        por Perspectiva.
                                    </h5>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                                            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        </button>
                                        <button type="button" class="btn btn-tool" data-lte-toggle="card-remove">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Spinner -->
                                <div id="spinnerCarga"
                                    style="display:none; position:fixed; top:40%; left:50%; transform:translate(-50%, -50%); z-index:9999;">
                                    <div class="spinner-border text-primary" role="status"
                                        style="width:4rem; height:4rem;">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>

                                <!-- Contenedor de gr√°ficos -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body">
                                                <!-- <h6 class="text-center text-muted mb-3">Gr√°fico de Barras</h6> -->
                                                <div id="chartBarDimensiones" style="height: 350px;"></div>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="col-md-5 mt-5">
                                        <div class="card shadow-sm border-0 m-3">
                                            <div class="card-body" style="border-top: 3px solid #28a745;">
                                                <h6 class="text-center text-muted mb-3">Tabla de Perspectivas</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Perspectiva</th>
                                                                <th class="text-center">Ind.</th>
                                                                <th class="text-center">Promedio</th>
                                                                <th class="text-center">Ponderado</th>
                                                                <th class="text-center">Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tbodyDimensiones"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- <div class="card card-outline" style="border-top: 3px solid #28a745;"></div> -->

                                <div class="row mt-4">

                                    <!-- üü© Columna 2: detalle de indicadores -->
                                    <div class="col-md-12" id="detalleIndicadoresContainer" style="display:none;">
                                        <div class="card shadow-sm border-0 m-3">
                                            <div class="card-body" style="border-top: 3px solid #1E90FF;">
                                                <h5 id="detalleIndicadoresTitulo"></h5>
                                                <div class="table-responsive mt-2">
                                                    <table class="table table-striped table-bordered">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Indicador</th>
                                                                <th class="text-center">Destino</th>
                                                                <th class="text-center">Responsable</th>
                                                                <th class="text-center">Meta</th>
                                                                <th class="text-center">Cumplimiento</th>
                                                                <th class="text-center">Peso BSC</th>
                                                                <th class="text-center">Ponderado</th>
                                                                <th>Estado</th>
                                                                <th>Ver</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tbodyDetalleIndicadores"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                        <!--end::Row-->
                    </div>


                    <!-- Cumplimiento por Destino -->
                    <div class="card card-primary card-outline col-12 mb-4 mt-3 card-shadow">
                        <div class="card-header">
                            <h5 class="card-title mb-3">
                                üìç Cumplimiento por Destino
                            </h5>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                                    <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                    <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Spinner mientras carga -->
                        <div id="spinnerCumplimientoDestinos" class="text-center my-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <div class="mt-2 fw-semibold text-secondary">Cargando...</div>
                        </div>

                        <div class="card-body">
                            <div class="row">
                                <!-- Tabla -->
                                <div class="col-6 col-md-5 card-body me-md-1">
                                    <div id="tablaCumplimientoContainer" class="table-responsive px-3"
                                        style="display:none;">
                                        <table
                                            class="table table-sm table-striped table-hover table-bordered rounded-5 shadow-sm align-middle mx-auto"
                                            style="max-width:95%;">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Destino</th>
                                                    <th class="text-center">KPI's</th>
                                                    <th class="text-center">Cumplimiento</th>
                                                    <th class="text-center text-success">En Meta</th>
                                                    <th class="text-center text-danger">Cr√≠ticos</th>
                                                    <th class="text-center">Evoluci√≥n</th> <!-- Nueva columna -->
                                                </tr>
                                            </thead>
                                            <tbody id="tablaCumplimientoDestinos"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="col-6 col-md-6 mt-3" style="margin-right: 5px;">
                                    <div id="grafico-evolucion" style="display: none;">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="card-title">Evoluci√≥n del destino</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="col-md-12">
                                                    <div id="chartEvolucionArea"></div>
                                                </div>
                                            </div>

                                            <!-- ./card-body -->
                                            <div class="card-footer">
                                                <div class="row">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- üìã Indicadores del destino seleccionado -->
                                <div id="indicadores-destino" class="mt-3" style="display:none;">
                                    <div class="card card-outline card-secondary">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                Indicadores del destino:
                                                <span id="nombreDestino" class="text-primary ms-2"></span>
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-striped table-sm" id="tablaIndicadoresDestino">
                                                <thead>
                                                    <tr>
                                                        <th>Indicador</th>
                                                        <th>Objetivo</th>
                                                        <th>Meta</th>
                                                        <th>Un Med</th>
                                                        <th>Ult Valor</th>
                                                        <th>Cumpl (%)</th>
                                                        <th>Peso (%)</th>
                                                        <th>Tenden.</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Indicadores-->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-primary card-outline mt-3 mb-4 card-shadow" id="cardResumen">
                                <!-- üìä PANEL RESUMEN DE INDICADORES -->
                                <div id="panelIndicadoresResumen"
                                    class="card-header d-flex justify-content-between align-items-center flex-wrap"
                                    style="display:none;">
                                    <h5 class="card-title mb-3">üìå Resumen de Indicadores</h5>
                                    <div class="card-tools ms-auto">
                                        <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                                            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <!-- üîπ Barra de filtros -->
                                    <div class="d-flex flex-wrap mb-3 gap-2 align-items-end">
                                        <div>
                                            <label class="form-label mb-1">Destino</label>
                                            <select id="filtroSector" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label mb-1">Responsable</label>
                                            <select id="filtroResponsable" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label mb-1">Indicador</label>
                                            <select id="filtroIndicador" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label mb-1">Cumplimiento</label>
                                            <select id="filtroCumplimiento" class="form-select form-select-sm">
                                                <option value="">Todos</option>
                                                <option value="alto">Alto (&gt;= 90%)</option>
                                                <option value="medio">Medio (60‚Äì89%)</option>
                                                <option value="bajo">Bajo (&lt; 60%)</option>
                                            </select>
                                        </div>
                                        <div class="flex-grow-1">
                                            <label class="form-label mb-1">Buscar</label>
                                            <input id="filtroTexto" type="text" class="form-control form-control-sm"
                                                placeholder="Nombre o descripci√≥n...">
                                        </div>
                                        <button class="btn btn-primary btn-sm"
                                            onclick="aplicarFiltrosIndicadores()">Filtrar</button>
                                        <button class="btn btn-secondary btn-sm"
                                            onclick="resetFiltrosIndicadores()">Limpiar</button>
                                    </div>

                                    <!-- üîπ Contenedor de tarjetas y spinner -->
                                    <div id="listaIndicadoresResumen" class="row position-relative"
                                        style="min-height: 50px;">
                                        <!-- Spinner inicial -->
                                        <div id="spinnerCarga" class="text-center my-5" style="display: block;">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p id="spinnerTexto" class="mt-2" style="color: blue;">Cargando
                                                indicadores...</p>
                                        </div>
                                    </div>

                                    <div id="graficoIndicadorFull"></div>
                                    <div id="kpiTarjetasFull"></div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- === Destacados === -->
                    <div class="row">
                        <div class="card card-success card-outline col-12 mt-3 mb-4 card-shadow">
                            <div class="card-header">
                                <h5 class="card-title mb-3 d-flex align-items-center flex-wrap" style="gap: 6px;">
                                    <i class="fa fa-star text-warning"></i>
                                    <label for="valorCorteDestacados" class="mb-0 fw-semibold text-gray-700">
                                        Destacados: cumplimiento mayor al:
                                    </label>
                                    <div class="input-group input-group-sm" style="width: 80px;">
                                        <input type="number" id="valorCorteDestacados" value="90" min="0" max="100"
                                            step="1" class="form-control text-end" style="
                                                            border: 1px solid #dee2e6;
                                                            border-radius: 6px;
                                                            background-color: #f8f9fa;
                                                            transition: all 0.2s ease;
                                                            box-shadow: none;
                                                            font-size: 1rem;
                                                            font-weight: 500;
                                                            padding: 4px 6px;
                                                            height: auto;
                                                        "
                                            onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                                            onblur="this.style.borderColor='#dee2e6'; this.style.backgroundColor='#f8f9fa';" />
                                        <span class="input-group-text fw-semibold" style="
                                                        background-color: #f8f9fa; 
                                                        border: 1px solid #dee2e6;
                                                        font-size: 1rem;
                                                    ">%</span>
                                    </div>
                                </h5>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tablaDestacados" class="table table-sm table-borderless mb-0">
                                        <thead>
                                            <tr>
                                                <th>Indicador</th>
                                                <th>Destino</th>
                                                <th>Responsable</th>
                                                <th>Meta</th>
                                                <th>Unidad</th>
                                                <th>UltMed</th>
                                                <th>Cumpl.</th>
                                                <th>Tendencia</th>
                                                <!-- <th>Variaci√≥n</th> -->
                                                <th>Medici√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyDestacados">
                                            <!-- JS llena ac√° -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- === Cr√≠ticos === -->
                    <div class="row">
                        <!-- <div class="card card-danger card-outline col-md-7 mt-3 mb-4 card-shadow"> -->
                        <div class="col-md-7 mt-3 mb-4">
                            <div class="card card-danger card-outline card-shadow">
                                <div class="card-header">
                                    <h5 class="card-title mb-3 d-flex align-items-center flex-wrap" style="gap: 6px;">
                                        <i class="fa fa-arrow-down text-danger"></i>
                                        <label for="valorCorteCriticos" class="mb-0 fw-semibold text-gray-700">
                                            Cr√≠ticos: cumplimiento menor al
                                        </label>
                                        <div class="input-group input-group-sm" style="width: 80px;">
                                            <input type="number" id="valorCorteCriticos" value="50" min="0" max="100"
                                                step="1" class="form-control text-end" style="
                                                            border: 1px solid #dee2e6;
                                                            border-radius: 6px;
                                                            background-color: #f8f9fa;
                                                            transition: all 0.2s ease;
                                                            box-shadow: none;
                                                            font-size: 1rem;
                                                            font-weight: 500;
                                                            padding: 4px 6px;
                                                            height: auto;
                                                        "
                                                onfocus="this.style.borderColor='#0d6efd'; this.style.backgroundColor='#fff';"
                                                onblur="this.style.borderColor='#dee2e6'; this.style.backgroundColor='#f8f9fa';" />
                                            <span class="input-group-text fw-semibold" style="
                                                        background-color: #f8f9fa; 
                                                        border: 1px solid #dee2e6;
                                                        font-size: 1rem;
                                                    ">%</span>
                                        </div>
                                    </h5>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                                            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                                            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-borderless mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th>Destino</th>
                                                    <!-- <th>Responsable</th> -->
                                                    <th>Meta</th>
                                                    <th>Unidad</th>
                                                    <!-- <th>UltMed</th> -->
                                                    <th>Cumpl.</th>
                                                    <th>Tendencia</th>
                                                    <!-- <th>Variaci√≥n</th> -->
                                                    <th>Medici√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbodyCriticos"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- === Sin √∫ltima medici√≥n === -->
                        <div class="col-md-5 mt-3">
                            <div class="card card-warning card-outline">
                                <div class="card-body">
                                    <h5 class="mb-2 d-flex align-items-center flex-wrap" style="gap: 6px;">
                                        <i class="fa fa-question-circle"></i>
                                        <label for="valorCorteCriticos" class="mb-0 fw-semibold text-gray-700">
                                            Indicadores sin medici√≥n informada
                                        </label>
                                    </h5>
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table id="tablaPendientes" class="table table-sm table-borderless mb-0">
                                            <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                                                <tr>
                                                    <th>Indicador</th>
                                                    <th>Destino</th>
                                                    <th>Responsable</th>
                                                    <!-- <th>Situaci√≥n</th> -->
                                                </tr>
                                            </thead>
                                            <tbody id="tbodyPendientes">
                                                <!-- JS llena ac√° -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- === Insights Autom√°ticos === -->
                <div class="row">
                    <div class="col-md-6 mt-3">
                        <div class="card card-outline card-info">
                            <div class="card-body">
                                <h5 class="mb-3">üîç Insights Autom√°ticos</h5>
                                <div id="insightsAuto"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mt-3 indicador-meta">
                        <div class="card shadow-sm p-3 mb-3">
                            <h5 class="mb-3"><i class="bi bi-diagram-2"></i> Cumplimiento por Tipo</h5>
                            <div id="tarjetaTipos"></div>
                        </div>

                        <div class="card shadow-sm p-3 mb-3">
                            <h5 class="mb-3"><i class="bi bi-tags"></i> Cumplimiento por Categor√≠a</h5>
                            <div id="tarjetaCategorias"></div>
                        </div>

                        <div class="card shadow-sm p-3 mb-3">
                            <h5 class="mb-3"><i class="bi bi-exclamation-triangle"></i> Cumplimiento por
                                Criticidad</h5>
                            <div id="tarjetaCriticidad"></div>
                        </div>
                    </div>
                </div>

                <!-- === Botones de acci√≥n === -->
                <div class="actions-bar">
                    <!-- <a href="informePDF.html" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i> Ver formato previo PDF
                    </a> -->


                    <button id="btnPreviewPDF" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i> Ver formato previo PDF
                    </button>
                    <div class="actions-bar">
                        <button id="btnPDF" class="btn btn-outline-primary" disabled>
                            <span id="iconPDF" class="spinner"></span>
                            <span id="textPDF">Preparando informe final</span>
                        </button>
                    </div>

                    <!-- <a href="kpi-conclusiones.html" class="btn btn-outline-primary">
                        <i class="fas fa-chart-line"></i> Ver conclusiones generales
                    </a>
                    <button id="btnDescargarPDF" class="btn btn-outline-primary">
                        <i class="fas fa-file-pdf"></i> Descargar PDF
                    </button> -->
                    <button class="btn btn-primary" onclick="location.reload();"><i class="fas fa-sync"></i>
                        Actualizar
                        Datos</button>
                </div>

                <footer class="main-footer text-center">
                    <strong>¬© 2025 - myResultIQ 1.0</strong>
                </footer>
            </div>
        </main>
    </div>
    <!--end::App Wrapper-->

    <!-- Modal Evolucion cumplimiento global -->
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="detalleModalLabel">Indicadores inclu√≠dos en el mes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Mes:</strong> <span id="detalleMes"></span></p>
                    <div class="d-flex justify-content-end gap-2 mb-2">
                        <button class="btn btn-sm btn-outline-primary" id="btnVistaDestino">Agrupar por destino</button>
                        <button class="btn btn-sm btn-outline-secondary" id="btnVistaContribucion">Ordenar por
                            contribuci√≥n</button>
                    </div>

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Destino</th>
                                <th>Indicador</th>
                                <th>Cumplim (%)</th>
                                <th>Peso (%)</th>
                                <th>Contrib (%)</th>
                            </tr>
                        </thead>
                        <tbody id="detalleTabla"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
        integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="../js/adminlte.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
        integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <script>
        let evolucionGlobal = []; // üîπ Variable global en memoria
        let chartInstance = null;
        let medicionesGral = [];

        let cacheSectores = new Map(); // Cache para sectores
        let cacheUsuarios = new Map(); // Cache para usuarios

        let chartEvolucion = null;  // --- Modal y gr√°fico de evoluci√≥n ---

        // Escuchar clics en cualquier fila de indicador
        document.querySelectorAll('.fila-indicador').forEach(fila => {
            fila.addEventListener('click', e => {
                const id = fila.getAttribute('data-id');
                const indicador = indicadoresConDatos.find(ind => ind.id == id);

                if (indicador) {
                    // Cargar datos en el modal
                    document.getElementById('detalleNombre').textContent = indicador.nombre;
                    document.getElementById('detalleSector').textContent = indicador.sector;
                    document.getElementById('detalleUsuario').textContent = indicador.usuario || '‚Äî';
                    document.getElementById('detalleUltimaMedicion').textContent = indicador.ultimaMedicion ?? 'Sin medici√≥n';
                    document.getElementById('detallePorcentaje').textContent = indicador.porcentaje !== null ? indicador.porcentaje + '%' : '‚Äî';
                    document.getElementById('detalleMeta').textContent = indicador.meta ?? '‚Äî';
                    document.getElementById('detalleFrecuencia').textContent = indicador.frecuencia ?? '‚Äî';

                    // Mostrar modal (Bootstrap)
                    const modal = new bootstrap.Modal(document.getElementById('modalDetalleIndicador'));
                    modal.show();
                }
            });
        });

        // üìåüìå obtenerEvolucionGlobal() // üîπ Cargar los datos desde el backend
        async function obtenerEvolucionGlobal() {
            console.log('üí´üõ¥Iniciando obtenerEvolucionGlobal...');
            const res = await fetch('/api/evolucion-global');
            console.log('üßØüß∫ Finalizo obtenerEvolucionGlobal...');
            if (!res.ok) throw new Error('Error obteniendo datos');
            const data = await res.json();
            return data
        }

        // üìåüìå renderizarGrafico() üîπ Renderizar gr√°fico
        async function renderizarGrafico() {
            console.log('üí´üõ¥Iniciando renderizarGrafico...');
            const data = await obtenerEvolucionGlobal();
            evolucionGlobal = data; // ‚úÖ guardamos todo el dataset

            const resumen = analizarEvolucionGlobal(evolucionGlobal);
            document.getElementById('vsMesAnterior').textContent = (resumen.diferencia >= 0 ? '+' : '') + resumen.diferencia + '%';
            document.getElementById('promHistorico').textContent = resumen.promedioHistorico + '%';
            document.getElementById('promAnual').textContent = resumen.promedioAnual + '%';
            document.getElementById('tendencia').textContent = (resumen.tendencia >= 0 ? '+' : '') + resumen.tendencia + '%';

            // Validar que haya datos
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("‚ö†Ô∏è No hay datos para graficar.");
                return;
            }

            // Filtrar valores v√°lidos (cumplimiento num√©rico)
            const dataFiltrada = data.filter(d => typeof d.cumplimiento === 'number' && !isNaN(d.cumplimiento));

            if (dataFiltrada.length === 0) {
                console.warn("‚ö†Ô∏è Ning√∫n dato tiene cumplimiento v√°lido.");
                return;
            }


            // ===============================
            // üìå Guardar SIEMPRE el √∫ltimo mes del gr√°fico para el PDF
            // ===============================
            const ultimoEntryGrafico = dataFiltrada[dataFiltrada.length - 1];

            if (ultimoEntryGrafico && ultimoEntryGrafico.detalle) {
                const detallePDF = prepararDetalleParaPDF(ultimoEntryGrafico);

                if (detallePDF) {
                    localStorage.setItem(
                        'detalleUltimoMesPDF',
                        JSON.stringify(detallePDF)
                    );
                    console.log('üì¶ Detalle del √∫ltimo mes guardado para PDF:', detallePDF.month);
                }
            }



            // Preparar datos para Chart.js
            const labels = dataFiltrada.map(d => d.month);
            const valores = dataFiltrada.map(d => d.cumplimiento);

            // Obtener el canvas
            const ctx = document.getElementById("evolucionChart");
            if (!ctx) {
                console.error("‚ùå No se encontr√≥ el elemento canvas con id 'evolucionChart'");
                return;
            }

            // Si ya existe un gr√°fico previo, destruirlo antes de crear uno nuevo
            if (window.globalChartInstance) {
                window.globalChartInstance.destroy();
            }

            // Crear gr√°fico
            window.globalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumplimiento Global (%)',
                        data: valores,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgb(54, 162, 235)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const chart = elements[0].element.$context.chart;
                            const index = elements[0].index;
                            const entry = dataFiltrada[index]; // obtenemos el mes correspondiente

                            if (entry && entry.detalle && entry.detalle.length > 0) {

                                // üî• Guardar el √∫ltimo entry globalmente para "vista destino / vista contribuci√≥n"
                                window.__ultimoEntry = entry;

                                // Mostrar detalle
                                mostrarDetalleMes(entry);

                            } else {
                                console.warn("‚ÑπÔ∏è No hay detalle disponible para este mes:", entry?.month);
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,       // eje Y comienza en 0
                            max: 110,     // eje Y llega hasta 100
                            ticks: {
                                stepSize: 10  // marcas cada 10%
                            },
                            title: {
                                display: true,
                                text: '% Cumplimiento'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mes'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: context => `Cumplimiento: ${context.parsed.y.toFixed(2)}%`
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Guardar como PNG en Base64
            setTimeout(() => {
                try {
                    const imgBase64 = window.globalChartInstance.toBase64Image();
                    localStorage.setItem("graficoCumplimientoGlobal", imgBase64);
                    console.log("üìå Gr√°fico guardado en localStorage");
                } catch (e) {
                    console.error("No se pudo convertir el gr√°fico a imagen:", e);
                }
            }, 1000);

            // Despu√©s de crear el gr√°fico y antes de actualizar el resumen:
            const cumplimientoGlobalActual = valores[valores.length - 1]; // o promedio, seg√∫n tu preferencia
            window.valorCumplimientoGlobal = cumplimientoGlobalActual;

            actualizarResumenGlobal();

            const insights = generarInsightsAutomaticos(dataFiltrada);
            renderizarInsights(insights);
        }

        // üìåüìå renderizarInsights
        function renderizarInsights(insights) {
            const cont = document.getElementById("insightsAuto");
            if (!cont) return;

            cont.innerHTML = "";

            insights.forEach(i => {
                cont.innerHTML += `
            <div class="insight-box">
                <div class="insight-title">${i.titulo}</div>
                <div class="insight-text">${i.texto}</div>
            </div>
        `;
            });
        }

        // üìåüìå actualizarResumenGlobal
        function actualizarResumenGlobal() {
            const vsMesAnterior = parseFloat(document.getElementById('vsMesAnterior').textContent) || 0;
            const promHistorico = parseFloat(document.getElementById('promHistorico').textContent) || 0;
            const promAnual = parseFloat(document.getElementById('promAnual').textContent) || 0;
            const tendencia = document.getElementById('tendencia').textContent.trim();
            const cumplimiento = window.valorCumplimientoGlobal || 0; // el valor actual del ring

            const resumenGlobal = {
                variacion: vsMesAnterior,
                promHistorico,
                promAnual,
                tendencia,
                cumplimiento
            };
            localStorage.setItem('resumenGlobal', JSON.stringify(resumenGlobal));
        }

        // üìåüìå analizarEvolucionGlobal(evolucionGlobal)
        function analizarEvolucionGlobal(evolucionGlobal) {
            if (!Array.isArray(evolucionGlobal) || evolucionGlobal.length === 0) {
                return {
                    diferencia: 0,
                    promedioHistorico: 0,
                    promedioAnual: 0,
                    tendencia: 'Sin datos'
                };
            }

            // Ordenar por fecha (por si no viene ordenado)
            const serie = [...evolucionGlobal].sort((a, b) => a.month.localeCompare(b.month));

            // üî∏ a) Diferencia entre la √∫ltima y la ante√∫ltima medici√≥n
            const ult = serie[serie.length - 1]?.cumplimiento || 0;
            const penult = serie[serie.length - 2]?.cumplimiento || 0;
            const diferencia = parseFloat((ult - penult).toFixed(2));

            // üî∏ b) Promedio hist√≥rico
            const promedioHistorico = parseFloat(
                (serie.reduce((acc, d) => acc + d.cumplimiento, 0) / serie.length).toFixed(2)
            );

            // üî∏ c) Promedio anual (√∫ltimos 12 meses)
            const ultimos12 = serie.slice(-12);
            const promedioAnual = parseFloat(
                (ultimos12.reduce((acc, d) => acc + d.cumplimiento, 0) / ultimos12.length).toFixed(2)
            );

            // üî∏ d) Tendencia (creciente / decreciente / estable)
            let tendencia = 'Estable';
            if (serie.length >= 3) {
                // calculamos pendiente de una regresi√≥n lineal simple
                const n = serie.length;
                const x = serie.map((_, i) => i + 1);
                const y = serie.map(d => d.cumplimiento);
                const xMean = x.reduce((a, b) => a + b) / n;
                const yMean = y.reduce((a, b) => a + b) / n;
                const num = x.reduce((sum, xi, i) => sum + (xi - xMean) * (y[i] - yMean), 0);
                const den = x.reduce((sum, xi) => sum + (xi - xMean) ** 2, 0);
                const pendiente = num / den;

                if (pendiente > 0.2) tendencia = 'Creciente';
                else if (pendiente < -0.2) tendencia = 'Decreciente';
            }

            return { diferencia, promedioHistorico, promedioAnual, tendencia };
        }

        // üìåüìå mostrarDetalleMes(entry)   // üîπ Mostrar modal con detalle del mes marcado en evoluci√≥n global
        let modoDetalle = "destino";         // "destino" | "contribucion"
        function mostrarDetalleMes(entry) {
            document.getElementById('detalleMes').textContent = entry.month;
            const tbody = document.getElementById('detalleTabla');
            tbody.innerHTML = '';

            if (!entry || !Array.isArray(entry.detalle)) return;

            // Funciones auxiliares definidas una vez
            function getColorClass(valor) {
                if (valor >= 90) return "text-success fw-bold";
                if (valor >= 70) return "text-warning fw-bold";
                return "text-danger fw-bold";
            }

            function getStatusIcon(valor) {
                if (valor >= 90) return "üü¢‚úî";
                if (valor >= 70) return "üü°‚ö†";
                return "üî¥‚úò";
            }

            // Calculamos contribuciones
            const detalles = entry.detalle.map(d => {
                const cumplimiento = Number(d.cumplimiento) || 0;
                const peso = Number(d.peso) || 0;
                const contribucion = (cumplimiento * peso) / 100;

                return {
                    ...d,
                    cumplimiento,
                    peso,
                    contribucion
                };
            });

            let totalContribucion = detalles.reduce((acc, d) => acc + d.contribucion, 0);

            // üöÄ üöÄ üöÄ  MODO 1: AGRUPADO POR DESTINO
            if (modoDetalle === "destino") {

                // 1) Ordenar por destino
                const detallesOrdenados = [...detalles].sort((a, b) => Number(a.destino) - Number(b.destino));

                // 2) Agrupar
                const grupos = detallesOrdenados.reduce((acc, d) => {
                    const key = Number(d.destino);
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(d);
                    return acc;
                }, {});

                Object.keys(grupos).forEach(destinoId => {
                    const destinoNum = Number(destinoId);
                    const nombreDestino = window.destinosMap[destinoNum] || `Destino ${destinoNum}`;

                    // Fila de encabezado
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `
                <td colspan="5" class="fw-bold bg-light" style="border-top: 2px solid #999;">
                    ${nombreDestino}
                </td>
            `;
                    tbody.appendChild(headerRow);

                    // Filas de indicadores
                    grupos[destinoId].forEach(d => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${getStatusIcon(d.cumplimiento)}</td>
                    <td>${d.indicador}</td>
                    <td class="${getColorClass(d.cumplimiento)}">${d.cumplimiento.toFixed(2)}%</td>
                    <td>${d.peso.toFixed(2)}%</td>
                    <td class="fw-bold">${d.contribucion.toFixed(2)}%</td>
                `;
                        tbody.appendChild(row);
                    });
                });

            }
            // üöÄüöÄüöÄ  MODO 2: ORDENADO POR CONTRIBUCI√ìN
            else if (modoDetalle === "contribucion") {

                // Orden descendente
                const lista = [...detalles].sort((a, b) => b.contribucion - a.contribucion);

                const maxContrib = lista[0]?.contribucion || 0;

                // Encabezado de la secci√≥n
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
            <td colspan="5" class="fw-bold bg-light" style="border-top: 2px solid #999;">
                Indicadores ordenados por contribuci√≥n
            </td>
        `;
                tbody.appendChild(headerRow);

                // Filas
                lista.forEach(d => {
                    const isTop = d.contribucion === maxContrib;
                    const highlight = isTop ? 'style="background:#e8f7ff;"' : '';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td ${highlight}>${getStatusIcon(d.cumplimiento)}</td>
                <td ${highlight}><strong>${d.indicador}</strong></td>
                <td ${highlight} class="${getColorClass(d.cumplimiento)}">${d.cumplimiento.toFixed(2)}%</td>
                <td ${highlight}>${d.peso.toFixed(2)}%</td>
                <td ${highlight} class="fw-bold">${d.contribucion.toFixed(2)}%</td>
            `;
                    tbody.appendChild(row);
                });
            }

            // TOTAL AL FINAL
            const total = document.createElement('tr');
            total.innerHTML = `
        <td colspan="4" class="fw-bold text-end">TOTAL</td>
        <td class="fw-bold fs-5">${totalContribucion.toFixed(2)}%</td>
    `;
            tbody.appendChild(total);

            // Mostrar modal
            // const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            // modal.show();
            window.modalDetalleMes.show();
        }

        // üéõ BOTONES PARA ALTERNAR MODO
        document.getElementById('btnVistaDestino').addEventListener('click', () => {
            modoDetalle = "destino";
            mostrarDetalleMes(window.__ultimoEntry);
        });

        document.getElementById('btnVistaContribucion').addEventListener('click', () => {
            modoDetalle = "contribucion";
            mostrarDetalleMes(window.__ultimoEntry);
        });


        // üìåüìå prepararDetalleParaPDF()
        function prepararDetalleParaPDF(entry) {
            if (!entry || !Array.isArray(entry.detalle)) return null;

            const indicadores = entry.detalle.map(d => {
                const cumplimiento = Number(d.cumplimiento) || 0;
                const peso = Number(d.peso) || 0;
                const contribucion = (cumplimiento * peso) / 100;

                return {
                    destinoId: Number(d.destino),
                    destinoNombre: window.destinosMap?.[Number(d.destino)] || `Destino ${d.destino}`,
                    indicador: d.indicador,
                    cumplimiento,
                    peso,
                    contribucion
                };
            });

            const totalContribucion = indicadores.reduce(
                (acc, d) => acc + d.contribucion,
                0
            );

            return {
                month: entry.month,
                indicadores,
                totalContribucion
            };
        }


        // üìåüìå generarInsightsAutomaticos()
        function generarInsightsAutomaticos(serie) {

            if (!serie || serie.length < 2) return [];

            const insights = [];

            // --- Datos esenciales ---
            const ultimo = serie[serie.length - 1];
            const anterior = serie[serie.length - 2];

            const variacion = (ultimo.cumplimiento - anterior.cumplimiento).toFixed(2);

            // ============================
            // 1) Insight: Tendencia general
            // ============================
            if (variacion > 0) {
                insights.push({
                    titulo: "üìà Mejora sostenida",
                    texto: `El cumplimiento global creci√≥ un ${variacion}% respecto al per√≠odo anterior,
                    consolidando una tendencia positiva.`
                });
            } else if (variacion < 0) {
                insights.push({
                    titulo: "üìâ Ca√≠da reciente",
                    texto: `El cumplimiento global cay√≥ ${Math.abs(variacion)}% respecto al per√≠odo anterior,
                    se√±alando un deterioro que deber√≠a investigarse.`
                });
            }

            // ============================
            // 2) Mejor y peor sector (destino)
            // ============================
            const destinos = {};

            ultimo.detalle.forEach(d => {
                if (!destinos[d.destino]) destinos[d.destino] = { suma: 0, count: 0 };
                destinos[d.destino].suma += d.cumplimiento;
                destinos[d.destino].count++;
            });

            const destinosProm = Object.keys(destinos).map(id => ({
                id,
                prom: destinos[id].suma / destinos[id].count
            }));

            const destinoTop = destinosProm.reduce((a, b) => a.prom > b.prom ? a : b);
            const destinoLow = destinosProm.reduce((a, b) => a.prom < b.prom ? a : b);

            insights.push({
                titulo: "üèÜ Sector destacado",
                texto: `El sector "${window.destinosMap[destinoTop.id] || destinoTop.id}" presenta el mejor desempe√±o,
                con un promedio de ${destinoTop.prom.toFixed(1)}%.`
            });

            insights.push({
                titulo: "‚ö†Ô∏è Sector cr√≠tico",
                texto: `El sector "${window.destinosMap[destinoLow.id] || destinoLow.id}" muestra el menor cumplimiento,
                con apenas ${destinoLow.prom.toFixed(1)}%.`
            });

            // ============================
            // 3) Indicador m√°s fuerte y m√°s d√©bil
            // ============================
            const porIndicador = ultimo.detalle.map(d => ({
                nom: d.indicador,
                contrib: (d.cumplimiento * d.peso) / 100
            }));

            const best = porIndicador.reduce((a, b) => a.contrib > b.contrib ? a : b);
            const worst = porIndicador.reduce((a, b) => a.contrib < b.contrib ? a : b);

            insights.push({
                titulo: "üî• Indicador l√≠der",
                texto: `El KPI "${best.nom}" fue el que mayor contribuci√≥n realiz√≥ al resultado global del per√≠odo.`
            });

            insights.push({
                titulo: "üìâ Indicador con menor aporte",
                texto: `El KPI "${worst.nom}" tuvo la contribuci√≥n m√°s baja del per√≠odo, lo que podr√≠a indicar un foco de mejora.`
            });

            return insights;
        }

        // üìåüìå loadGlobalCompliance()
        async function loadGlobalCompliance() {
            try {
                const [sectoresRes, indicadoresRes] = await Promise.all([
                    fetch('/api/sectores'),
                    fetch('/api/indicadores')
                ]);

                const sectores = await sectoresRes.json();
                const indicadores = await indicadoresRes.json();

                const indicadoresConCumplimiento = indicadores.map(ind => {
                    const cumplimiento = calcularCumplimiento(
                        ind.ultimo_valor,
                        ind.unico_valor,
                        ind.unico_acepta,
                        ind.unico_riesgo,
                        ind.unico_critico
                    );

                    // üîπ Mostramos solo si el c√°lculo es v√°lido
                    if (cumplimiento !== null && !isNaN(cumplimiento)) {
                        // console.log(`Indicador: ${ind.nombre}, Valor: ${ind.ultimo_valor}, Cumplimiento calculado: ${cumplimiento}`);
                    }

                    return {
                        ...ind,
                        cumplimiento,
                        peso: Number(ind.peso_porcentual) || 0
                    };
                });

                const orgHierarchy = buildHierarchyMinimal(sectores, indicadoresConCumplimiento);
                const globalPercent = computeCompliance(orgHierarchy);

                // Actualizar ring
                drawRing('ringGlobal', globalPercent);
                // Actualizar texto
                // document.getElementById('globalPercentText').innerText = globalPercent.toFixed(1) + '%';

            } catch (err) {
                console.error('Error al calcular cumplimiento global:', err);
            }
        }

        // üìåüìå buildHierarchyMinimal(sectores, indicadores)   // Funciones auxiliares
        function buildHierarchyMinimal(sectores, indicadores) {
            const map = {};
            const roots = [];

            sectores.forEach(s => {
                map[s.id] = { id: s.id, weight: s.sector_porcentual ?? 100, children: [] };
            });

            sectores.forEach(s => {
                if (s.sector_padre_id && map[s.sector_padre_id]) {
                    map[s.sector_padre_id].children.push(map[s.id]);
                } else {
                    roots.push(map[s.id]);
                }
            });

            indicadores.forEach(ind => {
                const sector = map[ind.destino];
                if (sector) {
                    sector.children.push({
                        type: 'indicator',
                        cumplimiento: ind.cumplimiento,
                        weight: ind.peso
                    });
                }
            });

            return { id: 'root', weight: 100, children: roots };
        }

        // üìåüìå computeCompliance(node)        // Funciones auxiliares
        function computeCompliance(node) {
            if (!node) return 0;
            if (!node.children || node.children.length === 0) return node.cumplimiento ?? 0;

            let total = 0, sumWeights = 0;
            node.children.forEach(child => {
                const childComp = computeCompliance(child) ?? 0;
                const weight = Number(child.weight ?? 0);
                total += childComp * weight;
                sumWeights += weight;
            });
            return sumWeights > 0 ? total / sumWeights : 0;
        }

        // üìåüìå drawRing(id, percent)        // Funciones auxiliares
        function drawRing(id, percent) {
            const svg = document.getElementById(id);
            const size = 300, r = 140, stroke = 24, c = 2 * Math.PI * r;
            svg.innerHTML = '';

            // C√≠rculo de fondo
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bg.setAttribute('cx', size / 2);
            bg.setAttribute('cy', size / 2);
            bg.setAttribute('r', r);
            bg.setAttribute('fill', 'none');
            bg.setAttribute('stroke', '#eee');
            bg.setAttribute('stroke-width', stroke);
            svg.appendChild(bg);

            // C√≠rculo de progreso
            const fg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            fg.setAttribute('cx', size / 2);
            fg.setAttribute('cy', size / 2);
            fg.setAttribute('r', r);
            fg.setAttribute('fill', 'none');
            fg.setAttribute('stroke-width', stroke);
            fg.setAttribute('stroke-linecap', 'round');
            fg.setAttribute('stroke-dasharray', `${(percent / 100) * c} ${c}`);
            fg.setAttribute('transform', `rotate(-90 ${size / 2} ${size / 2})`);
            fg.setAttribute('stroke', 'url(#gradGlobal)');
            svg.appendChild(fg);

            // Gradiente
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            grad.id = 'gradGlobal';
            grad.setAttribute('x1', '0%'); grad.setAttribute('x2', '100%');
            const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            s1.setAttribute('offset', '0%'); s1.setAttribute('stop-color', '#2563eb');
            const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            s2.setAttribute('offset', '100%'); s2.setAttribute('stop-color', '#60a5fa');
            grad.appendChild(s1); grad.appendChild(s2);
            defs.appendChild(grad); svg.appendChild(defs);

            // Texto
            const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            txt.setAttribute('x', size / 2);
            txt.setAttribute('y', size / 2 + 8);
            txt.setAttribute('text-anchor', 'middle');
            txt.setAttribute('font-size', '36');
            txt.setAttribute('font-weight', '700');
            txt.textContent = percent.toFixed(1) + '%';
            svg.appendChild(txt);

            // =========================
            // üìå GUARDAR PNG PARA PDF
            // =========================
            guardarSVGComoPNG(svg, 'ringGlobalPNG', 180);
        }

        // üéØüéØüéØ guardarSVGComoPNG(svgElement, storageKey, size = 180)
        function guardarSVGComoPNG(svgElement, storageKey, size = 180) {
            const serializer = new XMLSerializer();
            const svgStr = serializer.serializeToString(svgElement);

            const svgBlob = new Blob([svgStr], {
                type: 'image/svg+xml;charset=utf-8'
            });

            const url = URL.createObjectURL(svgBlob);

            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, size, size);
                ctx.drawImage(img, 0, 0, size, size);

                const pngBase64 = canvas.toDataURL('image/png');
                localStorage.setItem(storageKey, pngBase64);

                URL.revokeObjectURL(url);
            };

            img.src = url;
        }


        // üìåüìå calcularCumplimiento(valor, meta, acepta, riesgo, critico) - // Reutiliza tu funci√≥n de c√°lculo de cumplimiento      
        function calcularCumplimiento(valor, meta, acepta, riesgo, critico) {
            if (valor === null || meta === null || meta == 0 || valor == 0) return null;
            if (valor > 0) {
                // console.log(`valor encontrado valor ${valor} y meta ${meta}`)
            }
            return (valor / meta) * 100;
        }

        // üìåüìå cargarIndicadores(indicadores)    // Funciones auxiliares
        async function cargarIndicadores(indicadores) {
            const tbodyPendientes = document.getElementById('tbodyPendientes');
            tbodyPendientes.innerHTML = '';
            const tbodyDestacados = document.getElementById('tbodyDestacados');
            tbodyDestacados.innerHTML = '';
            const tbodyCriticos = document.getElementById('tbodyCriticos');
            tbodyCriticos.innerHTML = '';

            const valorCorteDestacados = Number(document.getElementById('valorCorteDestacados').value);
            const valorCorteCriticos = Number(document.getElementById('valorCorteCriticos').value);

            for (const ind of indicadores) {

                // Transformamos los datos para que DataTable los entienda
                const datosTabla = await Promise.all(indicadores.map(async (ind) => {
                    const usuario = await obtenerUsuarioPorLegajo(ind.responsable);

                    // lee la ultima medici√≥n del indicadltimaMedicionPorIndicador(ind.id);
                    const sector = await obtenerSectoresPorUnidad(ind.destino);

                    let fecha = '';
                    let resultadoActualizacion = 0;
                    let botones = '';
                    let ultimoValorPeriodo = '';
                    let ultimaMedicion = 0

                    if (ultima) {
                        let anio = 0;
                        let segunda = 0;
                        let tercera = 0;

                        ultimoValorPeriodo = ultima.med_valor_periodo;  //AAAA y lo que sigue √≥ AAAA-MM-DD
                        ultimaMedicion = ultima.med_valor; // valor num√©rico

                        switch (ind.freq_medicion) {
                            case '0201': // diaria (d√≠a h√°bil anterior)
                                const partes = ultima.med_valor_periodo.split("-"); // [2025,08,04]
                                fecha = `${partes[2]}/${partes[1]}/${partes[0]}`;   // 04/08/2025
                                break;

                            case '0202': // semanal
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 2
                                fecha = "Sem. " + segunda + ' de ' + anio
                                break;

                            case '0203': // quincenal con quincenas 1-24
                                anio = ultima.med_valor_periodo.substring(0, 4);        // AAAA
                                let quincenaGlobal = parseInt(ultima.med_valor_periodo.substring(4, 6)); // 1 a 24

                                // Determinar el mes
                                let mesNum = Math.ceil(quincenaGlobal / 2); // 1-12
                                let quincenaDelMes = (quincenaGlobal % 2 === 0) ? 2 : 1;

                                // Array con nombres de meses abreviados
                                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                                let mesTexto = meses[mesNum - 1]; // restamos 1 porque el array es base 0

                                // Componer fecha
                                fecha = quincenaDelMes + 'a.' + ' Quin. de ' + mesTexto + ' de ' + anio + ' (' + quincenaGlobal + ')';
                                break;

                            case '0204': // mensual
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 2
                                switch (segunda) {
                                    case '01':
                                        fecha = 'Enero de ' + anio;
                                        break;
                                    case '02':
                                        fecha = 'Febrero de ' + anio;
                                        break;
                                    case '03':
                                        fecha = 'Marzo de ' + anio;
                                        break;
                                    case '04':
                                        fecha = 'Abril de ' + anio;
                                        break;
                                    case '05':
                                        fecha = 'Mayo de ' + anio;
                                        break;
                                    case '06':
                                        fecha = 'Junio de ' + anio;
                                        break;
                                    case '07':
                                        fecha = 'Julio de ' + anio;
                                        break;
                                    case '08':
                                        fecha = 'Agosto de ' + anio;
                                        break;
                                    case '09':
                                        fecha = 'Setiembre de ' + anio;
                                        break;
                                    case '10':
                                        fecha = 'Octubre de ' + anio;
                                        break;
                                    case '11':
                                        fecha = 'Noviembre de ' + anio;
                                        break;
                                    case '12':
                                        fecha = 'Diciembre de ' + anio;
                                        break;
                                };
                                break;

                            case '0205': // bimestral
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 1
                                fecha = segunda + ' Bimestre de ' + ultima.med_anio;
                                break;

                            case '0206': // trimestral
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 1
                                fecha = segunda + ' Trimestre de ' + ultima.med_anio
                                break;

                            case '0207': // cuatrimestral
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 2
                                fecha = segunda + ' Cuatrimestre de ' + anio
                                break;

                            case '0208': // semestral
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 2
                                fecha = segunda + ' Semestre de ' + anio
                                break;

                            case '0209': // anual
                                fecha = 'A√±o ' + ultima.med_valor_periodo
                                break;

                            case '0210': // anual
                                anio = ultima.med_valor_periodo.substring(0, 4);  // primeros 4
                                segunda = ultima.med_valor_periodo.substring(4, 6);  // siguientes 2
                                fecha = segunda + ' de ' + anio;
                                break;
                        }

                        //  calcula cual deber√≠a ser la ultima fecha de medici√≥n seg√∫n la fecha del d√≠a y la frecuencia de medici√≥n
                        const freqMedi = ind.freq_medicion.substring(2, 4);
                        const hoy = new Date();
                        const fechaFormateada = hoy.toISOString().split('T')[0];
                        const resultado = await calcularFechaEsperada(fechaFormateada, freqMedi);

                        //  si la que deber√≠a ser no es igual a la ultima que tiene, pone marca de demorado
                        if (resultado !== ultima.med_valor_periodo) {
                            // Crear filas
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                        <td>${ind.nombre}</td>
                                        <td>${sector.nombre || '-'}</td>
                                        <td>${usuario.nombres} ${usuario.apellido} </td>
                                        <td>Demorado</td>
                                    `;
                            tbodyPendientes.appendChild(tr);
                        };

                        //  calcula cumplimiento
                        //  considera   unico_valor como meta
                        //  toma   med_valor como valor de medici√≥n
                        const porcentaje = (ultimaMedicion / ind.unico_valor * 100).toFixed(1);

                        // Tabla destacados
                        if (porcentaje >= valorCorteDestacados) {
                            const trDest = document.createElement('tr');
                            trDest.innerHTML = `
                                <td>${ind.nombre}</td>
                                <td>${sector?.nombre || '-'}</td>
                                <td>${usuario && usuario.nombres && usuario.apellidos
                                    ? `${usuario.nombres} ${usuario.apellidos}`
                                    : '-'}</td> 
                                <td>${ind.unico_valor}</td>
                                <td>${ind.unidad_desc || ''}</td>   <!-- ‚úÖ nueva columna -->
                                <td>${porcentaje}%</td>
                            `;
                            tbodyDestacados.appendChild(trDest);
                        }

                        // Tabla cr√≠ticos
                        if (porcentaje <= valorCorteCriticos) {
                            const trCrit = document.createElement('tr');
                            trCrit.innerHTML = `
                                <td>${ind.nombre}</td>
                                <td>${sector?.nombre || '-'}</td>
                                <td>${usuario && usuario.nombres && usuario.apellidos
                                    ? `${usuario.nombres} ${usuario.apellidos}`
                                    : '-'}</td> 
                                <td>${ind.unico_valor}</td>
                                <td>${porcentaje}%</td>
                            `;
                            tbodyCriticos.appendChild(trCrit);
                        }
                    }

                    // si no tiene ninguna medici√≥n:
                    else {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                        <td>${ind.nombre}</td>
                                        <td>${sector.nombre || '-'}</td>
                                        <td>${usuario && usuario.nombres && usuario.apellidos
                                ? `${usuario.nombres} ${usuario.apellidos}`
                                : '-'}</td>
                                        <td>Sin med.</td>
                                    `;
                        tbodyPendientes.appendChild(tr);
                    }
                }))
            }
        }

        // üìåüìå handleClickIndicador(e)  //  Funci√≥n com√∫n para manejar clics
        function handleClickIndicador(e) {
            const link = e.target.closest('.link-indicador');
            if (link) {
                e.preventDefault();
                const idIndicador = Number(link.dataset.id);
                const nombre = link.dataset.nombre;
                const unicoValor = link.dataset.unico;
                const descripcion = link.dataset.descripcion;

                // Obtenemos las mediciones globales desde el m√≥dulo
                const mediciones = getMediciones();
                console.table(mediciones)

                // Filtramos solo las del indicador clickeado
                const medicionesIndicador = mediciones.data.filter(m => m.med_indicador_id == idIndicador);

                if (!medicionesIndicador.length) {
                    alert("‚ö†Ô∏è No hay mediciones para este indicador.");
                    return;
                }

                // Extraemos los datos para el gr√°fico
                const labels = medicionesIndicador.map(m => m.med_valor_periodo);
                const valores = medicionesIndicador.map(m => parseFloat(m.med_valor) || 0);

                // Calcula tendencia
                const resultado = evaluarTendenciaIndicador(valores);

                // mostrarEvolucionIndicador(idIndicador, labels, valores);
                // verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}');
                // Llamada correcta a la funci√≥n del gr√°fico
                verGraficoIndicador(idIndicador, nombre, unicoValor, descripcion);
            }
        }

        // ‚úÖ Asociar el evento a las tres tablas
        ['tbodyPendientes', 'tbodyDestacados', 'tbodyCriticos'].forEach(id => {
            const tbody = document.getElementById(id);
            if (tbody) {
                tbody.addEventListener('click', handleClickIndicador);
            }
        });

        // üìåüìå evaluarTendenciaIndicador(mediciones, umbral = 2)    
        /**
  * @param {number[]} mediciones - Array con los valores del indicador (orden cronol√≥gico)
  * @param {number} umbral - Umbral de variaci√≥n (%) para considerar "estable" (default = 2)
  * @returns {object} { tendencia, variacion, pendiente, color, icono }
  */
        function evaluarTendenciaIndicador(mediciones, umbral = 2) {
            if (!Array.isArray(mediciones) || mediciones.length < 2) {
                return {
                    tendencia: "datos insuficientes",
                    variacion: 0,
                    pendiente: 0,
                    color: "gray",
                    icono: "‚ö™"
                };
            }

            const n = mediciones.length;
            const x = Array.from({ length: n }, (_, i) => i + 1);
            const y = mediciones;

            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            let num = 0, den = 0;
            for (let i = 0; i < n; i++) {
                num += (x[i] - meanX) * (y[i] - meanY);
                den += (x[i] - meanX) ** 2;
            }
            const pendiente = num / den;
            const variacion = ((y[n - 1] - y[0]) / y[0]) * 100;

            let tendencia, color, icono;
            if (variacion > umbral && pendiente > 0) {
                tendencia = "En alza";
                color = "#28a745"; // verde
                icono = "üìà";
            } else if (variacion < -umbral && pendiente < 0) {
                tendencia = "En baja";
                color = "#dc3545"; // rojo
                icono = "üìâ";
            } else {
                tendencia = "Estable";
                color = "#ffc107"; // amarillo
                icono = "‚ûñ";
            }

            return {
                tendencia,
                variacion: variacion.toFixed(2),
                pendiente: pendiente.toFixed(3),
                color,
                icono
            };
        }

        // üìåüìå mostrarEvolucionIndicador(id, labels, valores)   // ‚úÖ Ejemplo de funci√≥n de acci√≥n
        function mostrarEvolucionIndicador(id, labels, valores) {
            indicador = window.indicadores.find(i => i.id == id);
            document.getElementById('modalNombre').textContent = indicador.nombre;
            document.getElementById('modalSector').textContent = indicador.sector;
            document.getElementById('modalUsuario').textContent = indicador.usuario;
            document.getElementById('modalMedicion').textContent = indicador.ultimaMedicion ?? 'Sin medici√≥n';

            // Destruir gr√°fico anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            const modal = new bootstrap.Modal(document.getElementById('indicadorModal'));
            modal.show();

            // ‚úÖ Esperar a que el modal est√© visible para dibujar el gr√°fico
            const modalEl = document.getElementById('indicadorModal');
            modalEl.addEventListener('shown.bs.modal', () => {
                const ctx = document.getElementById('graficoIndicador').getContext('2d');

                const data = valores;

                console.log(`valores ${valores} y labels ${labels}`)

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Cumplimiento (%)',
                            data,
                            fill: false,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 4,
                            borderColor: '#007bff',
                            pointBackgroundColor: '#007bff',
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'category', // ‚ö†Ô∏è importante si us√°s strings no fechas
                                title: {
                                    display: true,
                                    text: 'Periodo'
                                }
                            },
                            y: {
                                min: 0,
                                title: { display: true, text: '% de Cumplimiento' }
                            }
                        }
                    }
                });
            }, { once: true });
            // Ac√° podr√≠as abrir un modal o mostrar un gr√°fico din√°mico
        }

        // üìåüìå getUltimaMedicionPorIndicador(indicadorId)
        async function getUltimaMedicionPorIndicador(indicadorId) {
            // Filtrar por el indicador
            const mediciones = await leerMediciones();
            // Guardar total de mediciones registradas (antes del filtro)
            localStorage.setItem('totalMediciones', mediciones.length);

            //üìÆüìÆüìÆ Obtiene rango de fechas.üìÆüìÆüìÆ
            let fechaMin = null;
            let fechaMax = null;

            for (const m of mediciones) {
                const rango = obtenerRangoFechaDesdePeriodo(
                    m.med_valor_periodo,
                    m.med_tipo_periodo
                );

                if (!rango) continue;

                if (!fechaMin || rango.desde < fechaMin) {
                    fechaMin = rango.desde;
                }

                if (!fechaMax || rango.hasta > fechaMax) {
                    fechaMax = rango.hasta;
                }
            }

            if (fechaMin && fechaMax) {
                localStorage.setItem('fechaDesde', fechaMin.toISOString());
                localStorage.setItem('fechaHasta', fechaMax.toISOString());
            }
            //üìÆüìÆüìÆ fin Obtiene rango de fechas.üìÆüìÆüìÆ

            const filtradas = mediciones.filter(m => m.med_indicador_id == indicadorId);

            if (filtradas.length === 0) return null;

            // Ver el tipo de periodo (asumo que todas las mediciones del indicador tienen el mismo)
            const tipoPeriodo = filtradas[0].med_tipo_periodo;

            if (tipoPeriodo === '0201') {
                // Caso diario: comparar por fecha
                return filtradas.reduce((ultima, actual) =>
                    actual.med_valor_periodo > ultima.med_valor_periodo
                        ? actual
                        : ultima
                );
            } else {
                // Otros casos: comparar por med_valor_periodo (aseguramos que sea n√∫mero)
                return filtradas.reduce((ultima, actual) =>
                    Number(actual.med_valor_periodo) > Number(ultima.med_valor_periodo)
                        ? actual
                        : ultima
                );
            }
        }

        // üìåüìå leerMediciones
        async function leerMediciones() {
            try {
                const res = await fetch('/api/mediciones');
                const json = await res.json();

                if (Array.isArray(json)) {
                    return json;
                } else if (json.success) {
                    return json.data || [];
                } else {
                    console.error("Error en la respuesta:", json);
                    return [];
                }
            } catch (err) {
                console.error("Error leyendo mediciones:", err);
                return [];
            }
        }

        // üìåüìå obtenerUsuarioPorLegajo(responsable)
        async function obtenerUsuarioPorLegajo(responsable) {
            try {
                const response = await fetch(`/usuarios/${responsable}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn('Usuario no encontrado');
                        return null;
                    }
                    throw new Error(`Error al obtener usuario: ${response.statusText}`);
                }
                const usuario = await response.json();
                return usuario;
            } catch (err) {
                console.error('Error en fetch:', err);
                return null;
            }
        }

        // üìåüìå obtenerSectoresPorUnidad(unidad)
        async function obtenerSectoresPorUnidad(unidad) {
            try {
                const response = await fetch(`/sectores/${unidad}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn('Sector no encontrado');
                        return null;
                    }
                    throw new Error(`Error al obtener usuario: ${response.statusText}`);
                }
                const sector = await response.json();
                return sector;
            } catch (err) {
                console.error('Error en fetch:', err);
                return null;
            }
        }

        // üìåüìå calcularFechaEsperada(fechaConsulta, tipoPeriodo)
        function calcularFechaEsperada(fechaConsulta, tipoPeriodo) {
            // segun la fecha del dia determina qu√© fecha deberia ya haber informado el usuario
            const partes = fechaConsulta.split('-'); // "2025-09-16" ‚Üí ["2025","09","16"]
            const fecha = new Date(partes[0], partes[1] - 1, partes[2]); // a√±o, mesIndex, d√≠a
            let resultado;
            let dia = fecha.getDate();
            let mes = fecha.getMonth() + 1; // 1-12
            let anio = fecha.getFullYear();

            switch (tipoPeriodo) {
                case '01': // diaria (d√≠a h√°bil anterior)
                    const diaHabil = getDiaHabilAnterior(fecha);
                    resultado = diaHabil.toISOString().split('T')[0]; // yyyy-mm-dd
                    break;

                case '02': // semanal
                    // Obtener semana ISO y a√±o ISO
                    const { anioISO, semanaISO } = getSemanaISO(fecha);

                    // Semana anterior
                    let semanaAnterior = semanaISO - 1;
                    let anioSemanaAnterior = anioISO;

                    // Si la semana anterior cae en el a√±o anterior
                    if (semanaAnterior === 0) {
                        // √öltima semana ISO del a√±o anterior (52 o 53 seg√∫n el a√±o)
                        anioSemanaAnterior = anioISO - 1;
                        semanaAnterior = getSemanaISO(new Date(anioSemanaAnterior, 11, 31)).semanaISO;
                    }

                    // Guardar resultado en formato uniforme: "AAAA+semana"
                    resultado = `${anioSemanaAnterior}${semanaAnterior}`;
                    break;

                case '03': // quincenal 1-24
                    let quincenaGlobal;
                    if (dia < 16) {
                        // Segunda quincena del mes anterior
                        let mesAnterior = mes - 1;
                        let anioAnterior = anio;
                        if (mesAnterior === 0) {
                            mesAnterior = 12;
                            anioAnterior -= 1;
                        }
                        quincenaGlobal = (mesAnterior - 1) * 2 + 2; // segunda quincena del mes anterior
                        anio = anioAnterior;
                    } else {
                        // Primera quincena del mes actual
                        quincenaGlobal = (mes - 1) * 2 + 1;
                    }

                    // Guardar resultado como AAAA + quincena en 2 d√≠gitos
                    resultado = `${anio}${String(quincenaGlobal).padStart(2, "0")}`;
                    break;


                case '04': // mensual
                    if (mes === 1) {
                        // si enero, el mes anterior es diciembre del a√±o anterior
                        resultado = `${anio - 1}12`;
                    } else {
                        // cualquier otro mes: calcular mes anterior
                        let mesAnterior = mes - 1;                  // primero restamos
                        mesAnterior = String(mesAnterior).padStart(2, "0"); // luego lo formateamos
                        resultado = `${anio}${mesAnterior}`;
                    }
                    break;

                case '05': // bimestral
                    if (mes === 1 || mes === 2) {
                        // ene-feb ‚Üí a√±o anterior + 6 (√∫ltimo bimestre del a√±o anterior)
                        resultado = `${anio - 1}6`;
                    } else if (mes === 3 || mes === 4) {
                        // mar-abr ‚Üí a√±o actual + 1
                        resultado = `${anio}1`;
                    } else if (mes === 5 || mes === 6) {
                        // may-jun ‚Üí a√±o actual + 2
                        resultado = `${anio}2`;
                    } else if (mes === 7 || mes === 8) {
                        // jul-ago ‚Üí a√±o actual + 3
                        resultado = `${anio}3`;
                    } else if (mes === 9 || mes === 10) {
                        // sep-oct ‚Üí a√±o actual + 4
                        resultado = `${anio}4`;
                    } else if (mes === 11 || mes === 12) {
                        // nov-dic ‚Üí a√±o actual + 5
                        resultado = `${anio}5`;
                    }
                    break;

                case '06': // trimestral
                    if (mes >= 1 && mes <= 3) {
                        // meses 1-3 ‚Üí a√±o anterior + sufijo 4
                        resultado = `${anio - 1}4`;
                    } else if (mes >= 4 && mes <= 6) {
                        // meses 4-6 ‚Üí a√±o actual + sufijo 1
                        resultado = `${anio}1`;
                    } else if (mes >= 7 && mes <= 9) {
                        // meses 7-9 ‚Üí a√±o actual + sufijo 2
                        resultado = `${anio}2`;
                    } else if (mes >= 10 && mes <= 12) {
                        // meses 10-12 ‚Üí a√±o actual + sufijo 3
                        resultado = `${anio}3`;
                    }
                    break;

                case '07': // cuatrimestral
                    if (mes >= 1 && mes <= 4) {
                        // meses 1-4 ‚Üí a√±o anterior + sufijo 3
                        resultado = `${anio - 1}3`;
                    } else if (mes >= 5 && mes <= 8) {
                        // meses 5-8 ‚Üí a√±o actual + sufijo 1
                        resultado = `${anio}1`;
                    } else if (mes >= 9 && mes <= 12) {
                        // meses 9-12 ‚Üí a√±o actual + sufijo 2
                        resultado = `${anio}2`;
                    }
                    break;

                case '08': // semestral
                    if (mes < 7) {
                        // primer semestre ya pas√≥ ‚Üí ap√©ndice 2, a√±o anterior
                        resultado = `${anio - 1}2`;
                    } else {
                        // segundo semestre ‚Üí ap√©ndice 1, a√±o actual
                        resultado = `${anio}1`;
                    }
                    break;

                case '09': // anual
                    resultado = anio - 1; // a√±o anterior
                    break;

                default:
                    resultado = null;
            }
            return resultado;
        }

        // üìåüìå valorCorteDestacados
        document.getElementById('valorCorteDestacados').addEventListener('input', async () => {
            await reconstruirTablas(); // funci√≥n que recalcula y recarga la tabla
        });

        // üìåüìå valorCorteCriticos
        document.getElementById('valorCorteCriticos').addEventListener('input', async () => {
            await reconstruirTablas(); // funci√≥n que recalcula y recarga la tabla
        });


        // üìåüìå obtener Fecha desde Periodo
        function obtenerRangoFechaDesdePeriodo(valorPeriodo, tipoPeriodo) {
            const year = parseInt(valorPeriodo.substring(0, 4), 10);
            const xx = parseInt(valorPeriodo.substring(4, 6), 10);

            let mesInicio = 1;
            let mesFin = 12;

            switch (tipoPeriodo) {
                case '0204': // mes
                case '0210': // mes
                    mesInicio = xx;
                    mesFin = xx;
                    break;

                case '0205': // bimestre
                    mesInicio = (xx - 1) * 2 + 1;
                    mesFin = mesInicio + 1;
                    break;

                case '0206': // trimestre
                    mesInicio = (xx - 1) * 3 + 1;
                    mesFin = mesInicio + 2;
                    break;

                case '0207': // cuatrimestre
                    mesInicio = (xx - 1) * 4 + 1;
                    mesFin = mesInicio + 3;
                    break;

                case '0208': // semestre
                    mesInicio = (xx - 1) * 6 + 1;
                    mesFin = mesInicio + 5;
                    break;

                case '0209': // a√±o
                    mesInicio = 1;
                    mesFin = 12;
                    break;

                default:
                    return null;
            }

            return {
                desde: new Date(year, mesInicio - 1, 1),
                hasta: new Date(year, mesFin, 0) // √∫ltimo d√≠a del mes
            };
        }


        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        async function XXXcargarIndicadoresBSC() {
            const spinner = document.getElementById("spinnerCarga");
            if (spinner) spinner.style.display = "block"; // Mostrar spinner

            try {
                // const res = await fetch('/api/indicadores');
                // if (!res.ok) throw new Error('Error al obtener indicadores');
                // const data = await res.json();

                data = indicadoresConDatos;

                // Traer cumplimiento de cada indicador
                const indicadoresConCumplimiento = await Promise.all(
                    data.map(async (ind) => {
                        try {
                            const r = await fetch(`/api/indicadores/${ind.codigo_id}/cumplimiento`);
                            const cumplimientoData = await r.json();
                            return { ...ind, cumplimiento: cumplimientoData?.porcentaje || 0 };
                        } catch {
                            return { ...ind, cumplimiento: 0 };
                        }
                    })
                );

                const resumenPorDimension = agruparPorDimension(indicadoresConCumplimiento);

                renderGraficos(resumenPorDimension);
                renderTabla(resumenPorDimension);

            } catch (err) {
                console.error("Error cargando indicadores:", err);
                alert("‚ùå No se pudieron cargar los indicadores");
            } finally {
                if (spinner) spinner.style.display = "none"; // Ocultar spinner
            }
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function XXXagruparPorDimension(indicadores) {
            const grupos = {};
            indicadores.forEach(ind => {
                const dimension = ind.dimension_nombre || "Sin Dimensi√≥n";
                if (!grupos[dimension]) grupos[dimension] = [];
                grupos[dimension].push(ind);
            });

            return Object.keys(grupos).map(dimension => {
                const inds = grupos[dimension];
                const promedio = inds.reduce((acc, ind) => acc + (Number(ind.cumplimiento) || 0), 0) / inds.length;
                const promedioPon = inds.reduce((acc, ind) => acc + ((Number(ind.cumplimiento) * (Number(ind.dimension_porcentual)) / 100) || 0), 0);
                // console.log(`ind cumplimiento ${ind.cumplimiento}, dimension: ${ind.dimension_porcentual}`)
                return { dimension, indicadores: inds, promedio: promedio.toFixed(2), promedioPon: promedioPon.toFixed(2) };
            });
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function XXXmostrarIndicadoresDeDimension(dimension, resumen) {
            if (!resumen) return;

            const dimensionData = resumen.find(d => d.dimension === dimension);
            if (!dimensionData) return;

            const contenedor = document.getElementById("detalleIndicadoresContainer");
            const titulo = document.getElementById("detalleIndicadoresTitulo");
            const tbody = document.getElementById("tbodyDetalleIndicadores");
            if (!contenedor || !tbody || !titulo) return;

            titulo.textContent = `Indicadores de Perspectiva ${dimension}`;
            tbody.innerHTML = '';

            dimensionData.indicadores.forEach(ind => {
                const estado = ind.cumplimiento >= 80 ? '‚úÖ Alto' :
                    ind.cumplimiento >= 50 ? '‚ö†Ô∏è Medio' : '‚ùå Bajo';
                const cumplimiento = ind.cumplimiento * ind.dimension_porcentual / 100;

                // const unidad = CodigosService.getNombreCodigo(ind.unidad_medida)

                tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td class="text-center">${ind.nombre}</td>
                    <td class="text-center">${ind.sector}</td>
                    <td class="text-center">${ind.usuario}</td>
                    <td class="text-center">${ind.unico_valor} ${ind.unidad_desc || ''}</td>
                    <td class="text-center">${Number(ind.cumplimiento).toFixed(1)} %</td>
                    <td class="text-center">${ind.dimension_porcentual != null ? ind.dimension_porcentual + ' %' : '-'}</td>
                    <td class="text-center">${cumplimiento.toFixed(1)} %</td>
                    <td>${estado}</td>
                    <td>

                    <!-- üìà Ver evoluci√≥n -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver evoluci√≥n"
                        onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}')">
                        <i class="fas fa-chart-line text-primary"></i>
                    </button>

                    <!-- ‚ÑπÔ∏è Detalle del indicador -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver detalle del indicador"
                        onclick="verDetalleIndicador('${ind.codigo_id}')">
                        <i class="fas fa-info-circle text-secondary"></i>
                    </button>

                    <!-- üóÉÔ∏è Mediciones -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver mediciones registradas"
                        onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}', '${ind.freq_medicion}', '${ind.unico_eval}')">
                        <i class="fas fa-database text-success"></i>
                    </button>
                    </td>

                </tr>
                `);
            });

            contenedor.style.display = 'block';
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function XXXverGraficoIndicador(key_id, nombre, meta, descripcion, metodo) {
            // Guardar en sessionStorage
            sessionStorage.setItem('indicador_seleccionado', key_id);
            document.getElementById('grafico-evolucion-Full').style.display = 'block';
            // Llama a la funci√≥n que renderiza el gr√°fico
            console.log('Renderizando gr√°fico para indicador:', key_id, 'con metodo', metodo);

            renderIndicadorChart(key_id, nombre, meta, descripcion, metodo)

        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        // let chartBSC = null;
        // let graficosListos = 0;
        // const TOTAL_GRAFICOS = 1; // ajust√° si hay m√°s

        function XXXrenderGraficos(resumenPorDimension) {

            const COLORES_DIMENSIONES = [
                "#0d6efd", "#198754", "#ffc107", "#dc3545",
                "#6f42c1", "#20c997", "#fd7e14", "#0dcaf0"
            ];

            const barVerticalDiv = document.querySelector("#chartBarDimensiones");
            if (barVerticalDiv) barVerticalDiv.innerHTML = '';

            const valores = resumenPorDimension.map(d => parseFloat(d.promedio));
            const labels = resumenPorDimension.map(d => d.dimension);

            if (barVerticalDiv) {

                // üëâ GUARD√ÅS la instancia del gr√°fico
                chartBSC = new ApexCharts(barVerticalDiv, {
                    chart: {
                        type: 'bar',
                        height: 350,
                        toolbar: { show: false },
                        events: {
                            mounted: () => {
                                graficosListos++;
                                verificarGraficos();
                            },
                            dataPointSelection: (e, ctx, config) => {
                                const dim = labels[config.dataPointIndex];
                                mostrarIndicadoresDeDimension(dim, resumenPorDimension);
                            }
                        }
                    },
                    series: [{
                        name: "Cumplimiento promedio",
                        data: valores
                    }],
                    xaxis: { categories: labels },
                    yaxis: {
                        min: 0,
                        max: 100,
                        title: { text: "Cumplimiento (%)" }
                    },
                    plotOptions: {
                        bar: {
                            distributed: true,
                            borderRadius: 5,
                            columnWidth: "55%"
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: v => v.toFixed(1) + "%"
                    },
                    colors: COLORES_DIMENSIONES
                });

                chartBSC.render();

                // // üëâ AHORA s√≠ existe
                // setTimeout(async () => {
                //     try {
                //         const { imgURI } = await chartBSC.dataURI({ scale: 2 });
                //         localStorage.setItem("graficoBSC_Barras", imgURI);
                //         console.log("Gr√°fico BSC guardado en localStorage");
                //     } catch (e) {
                //         console.error("Error al exportar gr√°fico BSC", e);
                //     }
                // }, 5000);
            }
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function XXXrenderTabla(resumenPorDimension) {
            const tbody = document.getElementById("tbodyDimensiones");
            if (!tbody) return;
            tbody.innerHTML = '';
            resumenPorDimension.forEach(d => {
                console.log(`valor de d: ${d}`)

                const estado = d.promedioPon >= 80 ? '‚úÖ Alto' :
                    d.promedioPon >= 50 ? '‚ö†Ô∏è Medio' : '‚ùå Bajo';

                console.log(`valores promedio: ${d.promedioPon}`)

                tbody.insertAdjacentHTML('beforeend', `
                    <tr style="cursor:pointer" onclick="mostrarIndicadoresDeDimension('${d.dimension}', resumenPorDimension)">
                        <td>${d.dimension}</td>
                        <td class="text-center">${d.indicadores.length}</td>
                        <td class="text-center">${d.promedio}%</td>
                        <td class="text-center">${d.promedioPon}%</td>
                        <td class="text-center">${estado}</td>
                    </tr>
                `);
            });
        }


        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function mostrarPanelIndicadoresResumen() {
            try {
                document.getElementById('panelIndicadoresResumen').style.display = 'block';
                if (document.getElementById('tablaIndicadoresContainer'))
                    document.getElementById('tablaIndicadoresContainer').style.display = 'none';
                if (document.getElementById('posicionGlobalContainer'))
                    document.getElementById('posicionGlobalContainer').style.display = 'none';

                const contenedor = document.getElementById('listaIndicadoresResumen');
                const spinner = document.getElementById('spinnerCarga');
                const spinnerTexto = document.getElementById('spinnerTexto');

                // üîπ Limpiar contenedor y MOSTRAR spinner (sin await todav√≠a)
                contenedor.innerHTML = '';
                spinner.style.display = 'block';
                spinnerTexto.textContent = 'Cargando indicadores...';

                // üîπ Cargar indicadores
                const response = await fetch('/api/indicadores');
                const indicadores = await response.json();
                indicadoresGlobal = indicadores;

                spinnerTexto.textContent = 'Preparando filtros...';

                // üîπ Cargar filtros de forma PARALELA
                await cargarOpcionesFiltros(indicadores);

                contenedor.innerHTML = `
                <div class="mensaje-filtros-sutil">
                    <div class="text-center texto-principal">
                        <i class="fas fa-info-circle me-2"></i>
                        Seleccionar los filtros y presionar <b>Filtrar</b> para ver los resultados
                    </div>
                </div>
            `;


            } catch (err) {
                console.error('Error cargando resumen de indicadores:', err);
                document.getElementById('listaIndicadoresResumen').innerHTML = `
                <div class="mensaje-filtros-sutil">
                    <div class="text-center texto-principal">
                        <i class="fas fa-info-circle me-2"></i>
                        Seleccionar los filtros y presionar <b>Filtrar</b> para ver los resultados
                    </div>
                </div>
            `;
            } finally {
                // Usar setTimeout para asegurar que se ejecute despu√©s de renderizar
                setTimeout(() => {
                    const spinner = document.getElementById('spinnerCarga');
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                }, 0);
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function cargarOpcionesFiltros(indicadores) {
            const selectSector = document.getElementById('filtroSector');
            const selectResponsable = document.getElementById('filtroResponsable');
            const selectIndicador = document.getElementById('filtroIndicador');

            // Limpiar selects
            selectSector.innerHTML = '<option value="">Todos</option>';
            selectResponsable.innerHTML = '<option value="">Todos</option>';
            selectIndicador.innerHTML = '<option value="">Todos</option>';

            const sectorMap = new Map();
            const responsableMap = new Map();

            // üîπ Recolectar claves √∫nicas
            for (const ind of indicadores) {
                const claveSector = normalizeKey(ind.destino);
                if (claveSector && !sectorMap.has(claveSector)) {
                    sectorMap.set(claveSector, { raw: ind.destino, label: null });
                }

                const claveResp = normalizeKey(ind.responsable);
                if (claveResp && !responsableMap.has(claveResp)) {
                    responsableMap.set(claveResp, { raw: ind.responsable, label: null });
                }
            }

            // üöÄ OPTIMIZACI√ìN: Cargar todos los sectores y responsables en paralelo
            const promesasSectores = Array.from(sectorMap.entries()).map(async ([clave, entry]) => {
                const sectorObj = await obtenerSectorConCache(entry.raw);
                entry.label = sectorObj?.nombre || sectorObj?.name || String(entry.raw || clave) || clave;
            });

            const promesasResponsables = Array.from(responsableMap.entries()).map(async ([clave, entry]) => {
                const usuario = await obtenerUsuarioConCache(entry.raw);
                const label = usuario?.nombres || usuario?.nombre
                    ? `${usuario.nombres || usuario.nombre} ${usuario.apellido || ''}`.trim()
                    : String(entry.raw || clave);
                entry.label = label;
            });

            await Promise.all([...promesasSectores, ...promesasResponsables]);

            // üîπ Ordenar alfabeticamente (ignorando acentos y may√∫sculas)
            const collator = new Intl.Collator('es', { sensitivity: 'base' });

            const sectoresOrdenados = Array.from(sectorMap.entries())
                .sort((a, b) => collator.compare(a[1].label || a[0], b[1].label || b[0]));

            const responsablesOrdenados = Array.from(responsableMap.entries())
                .sort((a, b) => collator.compare(a[1].label || a[0], b[1].label || b[0]));

            const indicadoresOrdenados = [...indicadores].sort((a, b) =>
                collator.compare(a.nombre || '', b.nombre || '')
            );

            // üîπ Agregar sectores
            for (const [clave, entry] of sectoresOrdenados) {
                const opt = document.createElement('option');
                opt.value = clave;
                opt.textContent = entry.label || clave;
                selectSector.appendChild(opt);
            }

            // üîπ Agregar responsables
            for (const [clave, entry] of responsablesOrdenados) {
                const opt = document.createElement('option');
                opt.value = clave;
                opt.textContent = entry.label || clave;
                selectResponsable.appendChild(opt);
            }

            // üîπ Agregar indicadores (ordenados por nombre)
            for (const ind of indicadoresOrdenados) {
                const opt = document.createElement('option');
                opt.value = ind.codigo_id || '';
                opt.textContent = `${ind.nombre || ''} (${ind.codigo_id || ''})`;
                selectIndicador.appendChild(opt);
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        function normalizeKey(v) {
            if (v === null || v === undefined) return '';
            if (typeof v === 'object') {
                try {
                    if (v.id !== undefined) return String(v.id).trim();
                    if (v.codigo !== undefined) return String(v.codigo).trim();
                    if (v._id !== undefined) return String(v._id).trim();
                    if (v.nombre !== undefined) return String(v.nombre).trim();
                    return JSON.stringify(v);
                } catch (e) {
                    return String(v);
                }
            }
            return String(v).trim();
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function obtenerSectorConCache(destino) {
            const key = normalizeKey(destino);
            if (!key) return null;

            if (cacheSectores.has(key)) {
                return cacheSectores.get(key);
            }

            try {
                const sector = await obtenerSectoresPorUnidad(destino);
                cacheSectores.set(key, sector);
                return sector;
            } catch (e) {
                cacheSectores.set(key, null);
                return null;
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function obtenerUsuarioConCache(legajo) {
            const key = normalizeKey(legajo);
            if (!key) return null;

            if (cacheUsuarios.has(key)) {
                return cacheUsuarios.get(key);
            }

            try {
                const usuario = await obtenerUsuarioPorLegajo(legajo);
                cacheUsuarios.set(key, usuario);
                return usuario;
            } catch (e) {
                cacheUsuarios.set(key, null);
                return null;
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî        
        async function aplicarFiltrosIndicadores() {
            const contenedor = document.getElementById('listaIndicadoresResumen');
            const spinner = document.getElementById('spinnerCarga');
            const spinnerTexto = document.getElementById('spinnerTexto');

            // 1Ô∏è‚É£ Mostrar spinner
            if (spinner) {
                spinner.style.display = 'block';
                spinnerTexto.textContent = 'Filtrando indicadores...';
            }
            if (contenedor) contenedor.innerHTML = '';

            // 2Ô∏è‚É£ Dejar que el navegador pinte
            await new Promise(resolve => setTimeout(resolve, 50));

            const sectorSel = document.getElementById('filtroSector').value;
            const responsableSel = document.getElementById('filtroResponsable').value;
            const indicadorSel = document.getElementById('filtroIndicador').value;
            const cumplimiento = document.getElementById('filtroCumplimiento').value;
            const texto = document.getElementById('filtroTexto').value.toLowerCase();

            try {
                // 3Ô∏è‚É£ Preparar indicadores NO preparados EN PARALELO
                const pendientes = indicadoresGlobal
                    .filter(ind => !ind._preparado)
                    .map(async ind => {
                        ind._destinoKey = normalizeKey(ind.destino);
                        ind._responsableKey = normalizeKey(ind.responsable);

                        const [usuario, sector, cumplimientoInfo] = await Promise.all([
                            obtenerUsuarioConCache(ind.responsable),
                            obtenerSectorConCache(ind.destino),
                            obtenerCumplimientoIndicador(ind.codigo_id).catch(() => ({ porcentaje: 0 }))
                        ]);

                        ind._usuario = usuario;
                        ind._sector = sector;
                        ind._cumplimiento = cumplimientoInfo;
                        ind._preparado = true;
                    });

                if (pendientes.length > 0) {
                    await Promise.all(pendientes);
                }

                // 4Ô∏è‚É£ Filtrar indicadores
                const filtrados = indicadoresGlobal.filter(ind => {
                    if (sectorSel && ind._destinoKey !== sectorSel) return false;
                    if (responsableSel && ind._responsableKey !== responsableSel) return false;
                    if (indicadorSel && indicadorSel !== '' && (ind.codigo_id || '') !== indicadorSel) return false;

                    if (cumplimiento) {
                        const p = (ind._cumplimiento?.porcentaje ?? 0);
                        if (cumplimiento === 'alto' && p < 90) return false;
                        if (cumplimiento === 'medio' && (p < 60 || p >= 90)) return false;
                        if (cumplimiento === 'bajo' && p >= 60) return false;
                    }

                    if (texto) {
                        const nombre = (ind.nombre || '').toLowerCase();
                        const desc = (ind.descripcion || '').toLowerCase();
                        if (!nombre.includes(texto) && !desc.includes(texto)) return false;
                    }

                    return true;
                });

                // 5Ô∏è‚É£ Renderizar tarjetas
                renderIndicadoresFiltrados(filtrados);

            } catch (err) {
                console.error('Error aplicando filtros:', err);
                contenedor.innerHTML = `
            <div class="alert alert-danger w-100 text-center my-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Ocurri√≥ un error al filtrar los indicadores.
            </div>`;
            } finally {
                // 6Ô∏è‚É£ Ocultar spinner
                if (spinner) spinner.style.display = 'none';
                if (contenedor) contenedor.style.display = 'flex';
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        function resetFiltrosIndicadores() {
            document.getElementById('filtroSector').value = '';
            document.getElementById('filtroResponsable').value = '';
            document.getElementById('filtroIndicador').value = '';
            document.getElementById('filtroCumplimiento').value = '';
            document.getElementById('filtroTexto').value = '';

            const contenedor = document.getElementById('listaIndicadoresResumen');

            contenedor.innerHTML = `
                <div class="mensaje-filtros-sutil">
                    <div class="text-center texto-principal">
                        <i class="fas fa-info-circle me-2"></i>
                        Seleccionar los filtros y presionar <b>Filtrar</b> para ver los resultados
                    </div>
                </div>
            `;

            document.getElementById('grafico-evolucion-indicador').style.display = 'none';
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî        
        async function obtenerCumplimientoIndicador(codigo) {
            try {
                const res = await fetch(`/api/indicadores/${codigo}/cumplimiento`);
                if (!res.ok) throw new Error('Error en la respuesta del servidor');

                const data = await res.json();
                return data; // <-- devolvemos todo el objeto
            } catch (err) {
                console.error('Error obteniendo cumplimiento del indicador:', err);
                return {
                    porcentaje: 0,
                    objetivo: null,
                    meta_tipo: null,
                    unico_valor: null,
                    rango_desde: null,
                    rango_hasta: null,
                    id: null
                };
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function renderIndicadoresFiltrados(lista = indicadoresGlobal) {
            const contenedor = document.getElementById('listaIndicadoresResumen');
            contenedor.innerHTML = '';

            if (!lista || lista.length === 0) {
                contenedor.innerHTML = `
            <div class="alert alert-warning w-100 text-center my-4">
                <i class="fas fa-exclamation-circle me-2"></i>
                No se encontraron indicadores con esos filtros.
            </div>`;
                return;
            }

            for (const ind of lista) {
                // aseguramos datos auxiliares
                const usuario = ind._usuario || await obtenerUsuarioPorLegajo(ind.responsable).catch(() => null);
                const sectores = ind._sector || await obtenerSectoresPorUnidad(ind.destino).catch(() => null);
                const info = await obtenerCumplimientoIndicador(ind.codigo_id).catch(() => ({ porcentaje: 0 }));

                console.log(`recibio indicador ${ind.nombre} con sector ${sectores?.nombre} y cumplimiento ${info?.porcentaje}`);

                // cache
                ind._usuario = usuario;
                ind._sector = sectores;
                ind._cumplimiento = info;
                ind._destinoKey = ind._destinoKey || normalizeKey(ind.destino);

                const porcentaje = Number(info?.porcentaje) || 0;

                console.log(`Indicador ${ind.nombre} tiene cumplimiento de ${porcentaje}%`);

                const color = getColorPorCumplimiento(porcentaje);

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-3';
                card.innerHTML = `
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="fw-bold mb-1">${ind.nombre}</h6>
                                        <small class="text-muted">
                                            ${ind.codigo_id} ¬∑ ${sectores?.nombre || sectores?.name || ''}
                                        </small>
                                    </div>

                                    <!-- üìä Secci√≥n de iconos de acci√≥n -->
                                    <div class="d-flex align-items-center">
                                        <!-- Indicador de cumplimiento -->
                                        <span class="badge rounded-circle me-1"
                                            style="background-color:${color}; width:18px; height:18px;"
                                            title="Cumplimiento: ${porcentaje.toFixed(1)}%">
                                        </span>
                                        <small>${porcentaje.toFixed(1)}%</small>

                                        <!-- üìà Ver evoluci√≥n -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver evoluci√≥n"
                                            onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}')">
                                            <i class="fas fa-chart-line text-primary"></i>
                                        </button>

                                        <!-- ‚ÑπÔ∏è Detalle del indicador -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver detalle del indicador"
                                            onclick="verDetalleIndicador('${ind.codigo_id}')">
                                            <i class="fas fa-info-circle text-secondary"></i>
                                        </button>

                                        <!-- üóÉÔ∏è Mediciones -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver mediciones registradas"
                                            onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}', '${ind.freq_medicion}', '${ind.unico_eval}')">
                                            <i class="fas fa-database text-success"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- üí¨ Datos principales -->
                                <p class="mt-2 mb-1">
                                    <strong>Objetivo:</strong> ${ind.objetivo}
                                </p>
                                <p class="mb-1">
                                    <strong>Responsable:</strong> ${usuario?.nombres || usuario?.nombre || ''} ${usuario?.apellido || ''}
                                </p>
                                <p class="mb-0">
                                    <small class="text-muted">${ind.descripcion || ''}</small>
                                </p>
                            </div>
                        </div>
                    `;

                contenedor.appendChild(card);
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        function getColorPorCumplimiento(cumplimiento) {
            if (cumplimiento >= 90) return '#28a745'; // verde
            if (cumplimiento >= 70) return '#ffc107'; // amarillo
            if (cumplimiento >= 50) return '#3B83BD'; // azul
            return '#dc3545'; // rojo
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        function verGraficoIndicador(key_id, nombre, meta, descripcion, metodo) {
            // Guardar en sessionStorage
            sessionStorage.setItem('indicador_seleccionado', key_id);
            // document.getElementById('grafico-evolucion-indicador').style.display = 'block';
            document.getElementById('grafico-evolucion-Full').style.display = 'block';

            // Llama a la funci√≥n que renderiza el gr√°fico
            console.log('Renderizando gr√°fico para indicador:', key_id, 'con metodo', metodo);

            renderIndicadorChart(key_id, nombre, meta, descripcion, metodo)

        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        async function XXXrenderIndicadorChart(idIndicador, nombre, meta, descripcion) {

            const chartContainer = document.querySelector('#sales-chart');
            if (!chartContainer) {
                console.error('Contenedor #sales-chart no encontrado');
                return;
            }
            const kpiContainer = document.getElementById('kpiCards'); // Ajusta seg√∫n tu HTML
            const analisisContainer = document.getElementById('analisisContainer');
            const analisisAuto = document.getElementById('analisis-automatico');
            if (window.salesChart) {
                try { await window.salesChart.destroy(); } catch (e) { console.warn('Error destruyendo gr√°fico previo:', e); }
                window.salesChart = null;
            }
            if (chartContainer) chartContainer.innerHTML = '';
            if (kpiContainer) kpiContainer.innerHTML = '';
            if (analisisContainer) analisisContainer.innerHTML = '';
            if (analisisAuto) analisisAuto.style.display = 'none';

            // üîπ Mostrar spinner mientras carga
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div id="spinnerCargaGrafico" class="text-center my-3">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Cargando gr√°fico...</p>
                    </div>
                `;
            }

            try {

                const response = await fetch(`/api/mediciones/${idIndicador}`);
                const result = await response.json();

                if (!result.success || !Array.isArray(result.data) || result.data.length === 0) {
                    if (window.salesChart) {
                        try { await window.salesChart.destroy(); } catch (e) { }
                        window.salesChart = null;
                    }
                    chartContainer.innerHTML = '<p class="text-center">Sin datos</p>';
                    return;
                }

                const valores = result.data.map(d => parseFloat(d.med_valor) || 0);
                const periodos = result.data.map(d => {
                    const str = String(d.med_valor_periodo);
                    const year = str.slice(0, 4);
                    const sufijo = str.slice(4);
                    return `${year}-${sufijo}`;
                });

                const maxY = Math.max(...valores, meta) * 1.1; // margen del 10%
                const options = {
                    chart: {
                        type: 'area',
                        height: 350,
                        toolbar: {
                            show: true,
                            tools: {
                                pan: false,
                                zoom: true,
                                zoomin: true,
                                zoomout: true,
                                reset: true,
                                download: true,
                                selection: true
                            }
                        }
                    },
                    series: [{ name: 'Valor', data: valores }],
                    xaxis: { categories: periodos },
                    stroke: { curve: 'smooth' },
                    tooltip: { enabled: true },
                    colors: ['#0d6efd'],
                    dataLabels: { enabled: false },

                    // üëá NUEVO BLOQUE: l√≠nea de meta / objetivo
                    annotations: {
                        yaxis: [
                            {
                                y: meta, // ‚Üê tu variable con el valor objetivo
                                borderColor: '#FF0000',
                                strokeDashArray: 4,
                                label: {
                                    borderColor: '#FF0000',
                                    style: {
                                        color: '#fff',
                                        background: '#FF0000'
                                    },
                                    text: `Meta: ${meta}`
                                }
                            }
                        ]
                    },
                    // ‚úÖ Bloque que define el rango real del eje Y
                    yaxis: {
                        min: 0,
                        max: maxY
                    }

                };

                if (window.salesChart) {
                    try { await window.salesChart.destroy(); } catch (err) { console.warn('Error al destruir gr√°fico previo:', err); }
                    window.salesChart = null;
                }
                document.getElementById('indNombre').textContent = nombre;
                document.getElementById('descripcionGraf').textContent = descripcion;
                document.getElementById('metaGraf').textContent = meta;
                chartContainer.innerHTML = "";
                await new Promise(resolve => setTimeout(resolve, 50));

                window.salesChart = new ApexCharts(chartContainer, options);
                await window.salesChart.render();
                // Scroll hacia el gr√°fico
                chartContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // üìã Agregar comentarios y plan de acci√≥n debajo del gr√°fico
                const ultimaMedicion = result.data[result.data.length - 1];

                const comentarios = ultimaMedicion.med_comentarios || 'Sin comentarios registrados.';
                const planAccion = ultimaMedicion.med_plan_accion || 'Sin plan de acci√≥n definido.';

                // Crear o usar contenedor para los comentarios
                let infoContainer = document.getElementById('infoContainer');
                if (!infoContainer) {
                    infoContainer = document.createElement('div');
                    infoContainer.id = 'infoContainer';
                    infoContainer.className = 'mt-4 mb-3 p-3 card card-body bg-light shadow-sm';
                    chartContainer.insertAdjacentElement('afterend', infoContainer);
                }

                infoContainer.innerHTML = `
                        <p class="mb-2"><strong>üóíÔ∏è Comentarios:</strong> ${comentarios}</p>
                        <p class="mb-0"><strong>üéØ Plan de Acci√≥n:</strong> ${planAccion}</p>
                    `;


                // üîÑ Botones para cambiar tipo de gr√°fico
                document.getElementById('btnLine').onclick = () => {
                    window.salesChart.updateOptions({ chart: { type: 'line' } });
                };
                document.getElementById('btnArea').onclick = () => {
                    window.salesChart.updateOptions({ chart: { type: 'area' } });
                };
                document.getElementById('btnBar').onclick = () => {
                    window.salesChart.updateOptions({ chart: { type: 'bar' } });
                };

                // ‚òéÔ∏è calcula Tendencia
                const resultado = evaluarTendenciaIndicador(valores);

                // ‚úÖ generar tarjetas KPI din√°micas

                const valorActual = valores[valores.length - 1];
                const valorAnterior = valores[valores.length - 2];
                const promedio = Math.round(valores.reduce((a, b) => a + b, 0) / valores.length);
                const mejorMes = Math.max(...valores);
                const cambio = Math.round(((valorActual - valorAnterior) / valorAnterior) * 100);
                const cumplimiento = Math.round((valorActual / meta) * 100);

                crearKPICards({
                    valorActual: valorActual,
                    cambio: valores.length > 1
                        ? ((valorActual - valorAnterior) / valorAnterior * 100).toFixed(1)
                        : 0,
                    cumplimiento: cumplimiento,
                    meta: meta,
                    promedio6: (valores.slice(-6).reduce((a, b) => a + b, 0) / Math.min(6, valores.length)).toFixed(1),
                    rangoMeses: "√öltimas 6 mediciones",
                    mejorMesValor: mejorMes,
                    mejorMesNombre: periodos[valores.indexOf(mejorMes)],
                    tendencia: resultado.tendencia,
                    variacion: ` Variaci√≥n: ${resultado.variacion} | Pendiente: ${resultado.pendiente}`,
                    iconoTendencia: resultado.icono,
                    colorTendencia: resultado.color
                });

                const primerValor = valores[0];
                const ultimoValor = valorActual;
                const crecimientoTotal = Math.round(((ultimoValor - primerValor) / primerValor) * 100);
                const brechaPromedio = Math.round(promedio - meta);
                const mejorIndice = valores.indexOf(mejorMes);
                const peorValor = Math.min(...valores);
                const peorIndice = valores.indexOf(peorValor);

                const { observaciones, recomendaciones } = generarAnalisisAutomatico(
                    valores,
                    periodos,
                    meta,
                    primerValor,
                    ultimoValor,
                    valorAnterior,
                    crecimientoTotal,
                    brechaPromedio,
                    mejorIndice,
                    mejorMes,
                    peorValor,
                    peorIndice
                );
                const container = document.getElementById('analisisContainer');
                document.getElementById('analisis-automatico').style.display = 'block';

                container.innerHTML = `
                        <div class="col-md-6">
                            <h5 class="fw-semibold mb-3">üîç Observaciones:</h5>
                            <ul class="text-muted">
                                ${observaciones.map(obs => `<li>${obs}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="fw-semibold mb-3">üí° Recomendaciones:</h5>
                            <ul class="text-muted">
                                ${recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;

            } catch (error) {
                console.error('Error renderizando gr√°fico del indicador:', error);
            }
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        /**
         * @param {number[]} mediciones - Array con los valores del indicador (orden cronol√≥gico)
         * @param {number} umbral - Umbral de variaci√≥n (%) para considerar "estable" (default = 2)
         * @returns {object} { tendencia, variacion, pendiente, color, icono }
         */
        function evaluarTendenciaIndicador(mediciones, umbral = 2) {
            if (!Array.isArray(mediciones) || mediciones.length < 2) {
                return {
                    tendencia: "datos insuficientes",
                    variacion: 0,
                    pendiente: 0,
                    color: "gray",
                    icono: "‚ö™"
                };
            }

            const n = mediciones.length;
            const x = Array.from({ length: n }, (_, i) => i + 1);
            const y = mediciones;

            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            let num = 0, den = 0;
            for (let i = 0; i < n; i++) {
                num += (x[i] - meanX) * (y[i] - meanY);
                den += (x[i] - meanX) ** 2;
            }
            const pendiente = num / den;
            const variacion = ((y[n - 1] - y[0]) / y[0]) * 100;

            let tendencia, color, icono;
            if (variacion > umbral && pendiente > 0) {
                tendencia = "En alza";
                color = "#28a745"; // verde
                icono = "üìà";
            } else if (variacion < -umbral && pendiente < 0) {
                tendencia = "En baja";
                color = "#dc3545"; // rojo
                icono = "üìâ";
            } else {
                tendencia = "Estable";
                color = "#ffc107"; // amarillo
                icono = "‚ûñ";
            }

            return {
                tendencia,
                variacion: Number(variacion.toFixed(2)),
                pendiente: Number(pendiente.toFixed(3)),
                color,
                icono
            };
        }

        // üìÆü§°üéàüèÄüîîüìÆü§°üéàüèÄüîî
        function crearKPICards(datos) {
            const kpis = [
                {
                    titulo: 'Valor Actual',
                    valor: `${datos.valorActual ?? '-'}`,
                    subtitulo: `${datos.cambio >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${datos.cambio >= 0 ? '+' : ''}${datos.cambio}% vs medici√≥n anterior`,
                    color: datos.cambio >= 0 ? '#198754' : '#dc3545',
                    icono: 'üí∞'
                },
                {
                    titulo: 'Cumplimiento Meta',
                    valor: `${datos.cumplimiento ?? '-'}%`,
                    subtitulo: `Meta: ${datos.meta ?? '-'}`,
                    color: datos.cumplimiento >= 100 ? '#198754' : '#ffc107',
                    icono: 'üéØ'
                },
                {
                    titulo: 'Promedio',
                    valor: `${datos.promedio6 ?? '-'}`,
                    subtitulo: datos.rangoMeses ?? '',
                    color: '#6c757d',
                    icono: 'üìä'
                },
                {
                    titulo: 'Mejor Resultado',
                    valor: `${datos.mejorMesValor ?? '-'}`,
                    subtitulo: datos.mejorMesNombre ?? '',
                    color: '#0dcaf0',
                    icono: 'üèÜ'
                },
                {
                    titulo: 'Tendencia',
                    valor: `${datos.tendencia}`,
                    subtitulo: datos.variacion,
                    color: datos.colorTendencia,
                    icono: datos.iconoTendencia
                }
            ];

            const container = document.getElementById('kpiCards');
            container.className = "row gx-3 gy-3 p-3";
            // gx = gap horizontal, gy = gap vertical, p = padding interno
            container.innerHTML = kpis.map(kpi => `
                    <div class="col-md-6 col-lg-3">
                        <div class="card kpi-card h-100" style="border-left: 4px solid ${kpi.color}; margin: 5px;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">${kpi.titulo}</p>
                                        <h2 class="kpi-value mb-1" style="color: ${kpi.color}">${kpi.valor}</h2>
                                        <p class="text-muted small mb-0">${kpi.subtitulo}</p>
                                    </div>
                                    <span style="font-size: 2rem;">${kpi.icono}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        // üìäü§ñ Generador de an√°lisis autom√°tico de cumplimiento
        function XXXgenerarAnalisisAutomatico(
            valores,
            periodos,
            meta,
            primerValor,
            ultimoValor,
            valorAnterior,
            crecimientoTotal,
            brechaPromedio,
            mejorIndice,
            mejorValor,
            peorValor,
            peorIndice,
            promedio,
            cumplimiento
        ) {
            const observaciones = [];
            const recomendaciones = [];

            // üîç Debug opcional
            console.log('üîé Generando an√°lisis autom√°tico con:', {
                valores,
                periodos,
                meta,
                primerValor,
                ultimoValor,
                valorAnterior,
                crecimientoTotal,
                brechaPromedio,
                mejorIndice,
                mejorValor,
                peorValor,
                peorIndice,
                promedio,
                cumplimiento
            });

            // ==========================
            // üìà CONCLUSIONES / OBSERVACIONES
            // ==========================

            if (crecimientoTotal > 0) {
                observaciones.push(`Crecimiento positivo del ${crecimientoTotal}% en el per√≠odo analizado`);
            } else if (crecimientoTotal < 0) {
                observaciones.push(`Decrecimiento del ${Math.abs(crecimientoTotal)}% en el per√≠odo analizado`);
            }

            if (periodos && periodos.length > 0) {
                if (mejorIndice >= 0 && mejorIndice < periodos.length) {
                    observaciones.push(`Mejor resultado en ${periodos[mejorIndice]}: ${mejorValor}`);
                }
                if (peorIndice >= 0 && peorIndice < periodos.length) {
                    observaciones.push(`Valor m√°s bajo en ${periodos[peorIndice]}: ${peorValor}`);
                }
            }

            if (brechaPromedio < 0) {
                observaciones.push(`Brecha promedio vs meta: ${Math.abs(brechaPromedio)} por debajo del objetivo`);
            } else {
                observaciones.push(`Super√≥ la meta en promedio por ${brechaPromedio}`);
            }

            // Tendencia sostenida de crecimiento
            let mesesCrecimiento = 0;
            for (let i = 1; i < valores.length; i++) {
                if (valores[i] > valores[i - 1]) {
                    mesesCrecimiento++;
                } else break;
            }
            if (mesesCrecimiento >= 2) {
                observaciones.push(`Crecimiento sostenido durante ${mesesCrecimiento + 1} per√≠odos consecutivos`);
            }

            // Variaci√≥n del √∫ltimo mes
            if (ultimoValor < valorAnterior) {
                const caida = Math.round(((ultimoValor - valorAnterior) / valorAnterior) * 100);
                observaciones.push(`Ca√≠da del ${Math.abs(caida)}% en el √∫ltimo per√≠odo`);
            } else if (ultimoValor > valorAnterior) {
                const subida = Math.round(((ultimoValor - valorAnterior) / valorAnterior) * 100);
                observaciones.push(`Subida del ${subida}% en el √∫ltimo per√≠odo`);
            }

            // Variabilidad
            const varianza = valores.reduce((sum, val) => sum + Math.pow(val - promedio, 2), 0) / valores.length;
            const desviacion = Math.sqrt(varianza);
            if (desviacion > promedio * 0.2) {
                observaciones.push('El indicador presenta alta variabilidad en el per√≠odo analizado');
            } else if (desviacion < promedio * 0.05) {
                observaciones.push('El indicador se mantuvo estable durante el per√≠odo');
            }

            // ==========================
            // üí° RECOMENDACIONES
            // ==========================

            // 1Ô∏è‚É£ Replicar buenas pr√°cticas del mejor mes
            if (mejorIndice < valores.length - 1) {
                recomendaciones.push(`Analizar factores de √©xito de ${periodos[mejorIndice]} para replicarlos`);
            }

            // 2Ô∏è‚É£ Meta no alcanzada
            if (ultimoValor < meta) {
                const necesario = Math.round(((meta - ultimoValor) / ultimoValor) * 100);
                recomendaciones.push(`Requiere incremento del ${necesario}% para alcanzar la meta`);
            }

            // 3Ô∏è‚É£ Comportamiento reciente
            if (ultimoValor > valorAnterior) {
                recomendaciones.push('Mantener las estrategias recientes que impulsaron la mejora');
            } else if (ultimoValor < valorAnterior) {
                recomendaciones.push('Investigar causas de la ca√≠da reciente y tomar acciones correctivas');
            }

            // 4Ô∏è‚É£ Variabilidad alta
            if (desviacion > promedio * 0.2) {
                recomendaciones.push('Alta variabilidad en resultados - considerar estabilizar procesos o revisar factores externos');
            }

            // 5Ô∏è‚É£ Tendencia reciente positiva
            const tendenciaReciente = valores.slice(-3);
            const crecimientoReciente = tendenciaReciente.every((val, i) => i === 0 || val >= tendenciaReciente[i - 1]);
            if (crecimientoReciente) {
                recomendaciones.push('Tendencia positiva en los √∫ltimos meses - continuar con la estrategia actual');
            }

            // 6Ô∏è‚É£ Meta dif√≠cil de alcanzar
            const periodosBajos = valores.filter(v => v < meta * 0.7).length;
            if (cumplimiento < 70 && periodosBajos >= 3) {
                recomendaciones.push('El cumplimiento ha sido bajo durante varios per√≠odos - revisar si la meta es alcanzable en condiciones normales');
            }

            // 7Ô∏è‚É£ Meta demasiado baja
            const periodosAltos = valores.filter(v => v > meta * 1.1).length;
            if (periodosAltos >= 3) {
                recomendaciones.push('El indicador supera la meta en varios per√≠odos consecutivos - evaluar si la meta est√° subestimada');
            }

            // 8Ô∏è‚É£ Estancamiento o falta de progreso
            const sinCambio = valores.every(v => Math.abs(v - promedio) < promedio * 0.02);
            if (sinCambio) {
                recomendaciones.push('El indicador muestra estancamiento - revisar estrategias o reasignar recursos');
            }

            // 9Ô∏è‚É£ Buen desempe√±o sostenido
            if (cumplimiento >= 90 && desviacion < promedio * 0.1) {
                recomendaciones.push('Buen desempe√±o y estabilidad - mantener consistencia en las acciones implementadas');
            }

            // üîü Datos escasos o irregulares
            if (valores.length < 3) {
                recomendaciones.push('Pocos per√≠odos medidos - se recomienda incrementar la frecuencia de medici√≥n para mayor precisi√≥n');
            }

            return { observaciones, recomendaciones };
        }

    </script>

    <script type="module">     // üìåüìå module
        // =========================
        // üìå IMPORTS
        // =========================
        import {
            inicializarDatosGlobales,
            getIndicadores,
            getMediciones,
            getSectores
        } from './js/datosGlobales.js';

        // =========================
        // üìå VARIABLES GLOBALES
        // =========================
        window.getMediciones = getMediciones;
        window.getSectores = getSectores;

        let indicadores = []; // array original
        let indicadoresConDatos = []; // array con datos preparados
        window.destinosMap = {};

        // document.addEventListener("DOMContentLoaded", async () => {
        // =========================
        // üìå FUNCI√ìN PRINCIPAL INIT()
        // =========================
        async function init() {
            try {
                console.log("üöÄ Iniciando m√≥dulo‚Ä¶");

                // ------------------------------------------
                // 1Ô∏è‚É£ Inicializar datos globales
                // ------------------------------------------
                await inicializarDatosGlobales();
                const sectoresData = getSectores();
                localStorage.setItem('cantSectores', sectoresData.length);
                console.log('ctdd sectores,', sectoresData.length);

                sectoresData.forEach(sec => {
                    window.destinosMap[Number(sec.id)] = sec.nombre;
                });
                console.log("‚úî Finaliz√≥ 1Ô∏è‚É£ (datos globales)");

                // ------------------------------------------
                // 2Ô∏è‚É£ Obtener indicadores
                // ------------------------------------------
                indicadores = getIndicadores();
                window.indicadores = indicadores;
                localStorage.setItem('cantIndicadoresActivos', indicadores.length);
                console.log("‚úî Finaliz√≥ 2Ô∏è‚É£ (indicadores)");

                // ------------------------------------------
                // 3Ô∏è‚É£ CodigosService y alerta
                // ------------------------------------------
                await CodigosService.init();
                loadGlobalCompliance();
                verificarAlerta();
                console.log("‚úî Finaliz√≥ 3Ô∏è‚É£ (c√≥digos + alerta)");

                // 4Ô∏è‚É£ Prepara datos con medici√≥n, usuario y sector

                const hoy = new Date();
                const year = hoy.getFullYear();                      // AAAA
                const month = String(hoy.getMonth() + 1).padStart(2, '0');  // MM (dos d√≠gitos)
                const periodo = `${year}${month}`;
                indicadoresConDatos = await Promise.all(indicadores.map(async ind => {
                    const usuario = await obtenerUsuarioPorLegajo(ind.responsable);
                    const ultima = await getUltimaMedicionPorIndicador(ind.id);
                    const siguienteMedicion = getSiguienteMedicion(ultima, ind.freq_medicion);
                    let vigencia;
                    if (ind.freq_medicion == '0210') { // si es eventual, siempre ok
                        vigencia = "ok"
                    } else {
                        if (periodo > siguienteMedicion) {
                            vigencia = "Demorado";
                        } else if (periodo < siguienteMedicion) {
                            vigencia = "ok";
                        } else {
                            vigencia = "Al d√≠a";   // si son iguales, opcional
                        }
                    };
                    const sector = await obtenerSectoresPorUnidad(ind.destino);
                    const ultimaMedicion = ultima ? ultima.med_valor : null;
                    // const porcentaje = ultimaMedicion !== null ? (ultimaMedicion / ind.unico_valor * 100).toFixed(1) : null;
                    const porcentaje = ultima?.med_cumplimiento ?? 0;

                    // üîπ Obtener la descripci√≥n de la unidad de medida desde CodigosService
                    const unidad = CodigosService.getNombreCodigo(ind.unidad_medida)

                    const mediciones = getMediciones();
                    const medicionesIndicador = mediciones.data.filter(m => m.med_indicador_id == ind.id);
                    const valores = medicionesIndicador.map(m => parseFloat(m.med_valor) || 0);
                    // Calcula tendencia
                    const resultado = evaluarTendenciaIndicador(valores);

                    return {
                        id: ind.id,
                        codigo_id: ind.codigo_id,
                        nombre: ind.nombre,
                        destino: ind.destino,
                        objetivo: ind.objetivo,
                        descripcion: ind.descripcion,

                        // üîπ DIMENSI√ìN
                        dimension_id: ind.dimension_id,
                        dimension: ind.dimension_nombre || 'Sin Dimensi√≥n',

                        tipo: ind.tipo_id,
                        categoria: ind.categoria_id,
                        criticidad: ind.criticidad_id,
                        sector: sector?.nombre || '-',
                        usuario: usuario ? `${usuario.nombres} ${usuario.apellido}` : '-',
                        ultimaMedicion,
                        unico_valor: ind.unico_valor,  // üëà agregado
                        unico_eval: ind.unico_eval,    // üëà agregado
                        unidad_medida: ind.unidad_medida,   // c√≥digo
                        unidad_desc: unidad,     // descripci√≥n
                        ultima_medicion: ultimaMedicion,
                        freq_medicion: ind.freq_medicion,
                        porcentaje,
                        resultado,
                        peso: ind.peso_porcentual,
                        pesoBSC: ind.dimension_porcentual,
                        vigencia
                    };
                }));
                console.log("‚úî Finaliz√≥ 4Ô∏è‚É£ (preparaci√≥n datos)");

                // ------------------------------------------
                // 5Ô∏è‚É£ Reconstruir tablas
                // ------------------------------------------
                await reconstruirTablas();
                console.log("‚úî Finaliz√≥ 5Ô∏è‚É£ (tablas)");

                // ------------------------------------------
                // 6Ô∏è‚É£ Listeners
                // ------------------------------------------
                document.getElementById('valorCorteDestacados')
                    .addEventListener('input', reconstruirTablas);
                document.getElementById('valorCorteCriticos')
                    .addEventListener('input', reconstruirTablas);
                console.log("‚úî Finaliz√≥ 6Ô∏è‚É£ (listeners)");

                // ------------------------------------------
                // 7Ô∏è‚É£ Cumplimiento por destino
                // ------------------------------------------
                await cargarCumplimientoPorDestino();
                console.log("‚úî Finaliz√≥ 7Ô∏è‚É£ (cumplimiento destino)");

                // ------------------------------------------
                // 8Ô∏è‚É£ Tooltips
                // ------------------------------------------
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                const tooltipList = [...tooltipTriggerList].map(
                    (el) => new bootstrap.Tooltip(el)
                );
                console.log("‚úÖ Tooltips inicializados:", tooltipList.length);
                console.log("‚úî Finaliz√≥ 8Ô∏è‚É£ (tooltips)");

                // ------------------------------------------
                // 9Ô∏è‚É£ Panel resumen indicadores
                // ------------------------------------------
                mostrarPanelIndicadoresResumen();
                console.log("‚úî Finaliz√≥ 9Ô∏è‚É£ (filtros resumen)");

                // ------------------------------------------
                // üîü Carga tarjetas de cumplimiento
                // ------------------------------------------
                buildTarjetas(indicadoresConDatos);
                console.log("‚úî Finaliz√≥ üîü (tarjetas cumplimiento)");

                // 1Ô∏è‚É£1Ô∏è‚É£  Inicializar al cargar
                renderizarGrafico().catch(err => {
                    console.error(err);
                    alert('No se pudo cargar la evoluci√≥n global');
                });
                console.log('finalizo 1Ô∏è‚É£1Ô∏è‚É£');

                // 1Ô∏è‚É£2Ô∏è‚É£  Inicializar al cargar
                await cargarIndicadoresBSC();
                console.log('finalizo 1Ô∏è‚É£2Ô∏è‚É£');

                console.log("üéâ INIT COMPLETADO EXITOSAMENTE");

            } catch (error) {
                console.error("‚ùå Error en init():", error);
            }
        }

        // =========================
        // üìå EJECUTAR INIT
        // =========================
        init();

        // ‚úÖ verificar Alertas
        async function verificarAlerta() {
            try {
                const response = await fetch('api/alertas/1/valor');
                const data = await response.json();

                console.log("DATA RECIBIDA:", data);

                const alerta = document.getElementById('alertaCondicional');
                alerta.style.display = (data.success && data.valor == 1)
                    ? 'block'
                    : 'none';

                console.log(data.valor == 1 ? "üü¢ Mostrar alerta" : "üîµ Ocultar alerta");

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('alertaCondicional').style.display = 'none';
            }
        }

        // ‚úÖ reconstruirTablas
        async function reconstruirTablas() {
            const tbodyPendientes = document.getElementById('tbodyPendientes');
            const tbodyDestacados = document.getElementById('tbodyDestacados');
            const tbodyCriticos = document.getElementById('tbodyCriticos');
            let chartInstance = null;

            tbodyPendientes.innerHTML = '';
            tbodyDestacados.innerHTML = '';
            tbodyCriticos.innerHTML = '';

            const valorCorteDestacados = Number(document.getElementById('valorCorteDestacados').value);
            const valorCorteCriticos = Number(document.getElementById('valorCorteCriticos').value);

            console.log("Indicadores con datos:", indicadoresConDatos);

            // üîπ Pendientes (sin medici√≥n)
            indicadoresConDatos
                .filter(ind => ind.ultimaMedicion === null)
                .forEach(ind => {
                    tbodyPendientes.innerHTML += `
                <tr>
                    <td>${ind.nombre}</td>
                    <td>${ind.sector}</td>
                    <td>${ind.usuario}</td>
                </tr>`;
                });

            // üîπ Destacados ‚Üí ordenar de MAYOR a MENOR
            indicadoresConDatos
                .filter(ind => ind.porcentaje !== null && ind.porcentaje >= valorCorteDestacados)
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .forEach(ind => {
                    // console.log ('Destacado:', ind.nombre,'meta:' , ind.unico_valor);
                    tbodyDestacados.innerHTML += `
                        <td>${ind.nombre}</td>
                        <td>${ind.sector}</td>
                        <td>${ind.usuario}</td>
                        <td class="text-center" style="font-family: monospace; width: 70px">
                        <span style="display:inline-block;">
                            ${ind.unico_valor}
                        </span>
                        </td>

                        <td>${ind.unidad_desc || ''}</td>   <!-- ‚úÖ nueva columna -->

                        <td class="text-center" style="font-family: monospace; width: 80px">
                        <span style="display:inline-block;">
                            ${ind.ultima_medicion}
                        </span>
                        </td>
                        <td>${ind.porcentaje}%</td>
                        <td style="color: ${ind.resultado.color}">${ind.resultado.tendencia}</td>

                        <td class="text-center" style="font-family: monospace; width: 90px">
                        <span style="display:inline-block;">
                           ${ind.vigencia}
                        </span>
                        </td>
                        <!-- üìä Secci√≥n de iconos de acci√≥n -->
                        <td>
                            <!-- üìà Ver evoluci√≥n -->
                            <button type="button" class="btn btn-link p-0 ms-2" title="Ver evoluci√≥n"
                                onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}', '${ind.unico_eval}')">
                                <i class="fas fa-chart-line text-primary"></i>
                            </button>

                            <!-- ‚ÑπÔ∏è Detalle del indicador -->
                            <button type="button" class="btn btn-link p-0 ms-2" title="Ver detalle del indicador"
                                onclick="verDetalleIndicador('${ind.codigo_id}')">
                                <i class="fas fa-info-circle text-secondary"></i>
                            </button>

                            <!-- üóÉÔ∏è Mediciones -->
                            <button type="button" class="btn btn-link p-0 ms-2" title="Ver mediciones registradas"
                                onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}', '${ind.freq_medicion}', '${ind.unico_eval}')">
                                <i class="fas fa-database text-success"></i>
                            </button>
                        </td>
                   `;
                });

            // üîπ Cr√≠ticos ‚Üí ordenar de MENOR a MAYOR
            indicadoresConDatos
                .filter(ind => ind.porcentaje !== null && ind.porcentaje <= valorCorteCriticos)
                .sort((a, b) => a.porcentaje - b.porcentaje)
                .forEach(ind => {
                    tbodyCriticos.innerHTML += `

                        <td>${ind.nombre}</td>
                        <td>${ind.sector}</td>


                        <td class="text-center" style="font-family: monospace; width: 70px">
                        <span style="display:inline-block;">
                            ${ind.unico_valor}
                        </span>
                        </td>

                        <td>${ind.unidad_desc || ''}</td>   <!-- ‚úÖ nueva columna -->



                        <td>${ind.porcentaje}%</td>
                        <td style="color: ${ind.resultado.color}">${ind.resultado.tendencia}</td>

                        <td class="text-center" style="font-family: monospace; width: 90px">
                        <span style="display:inline-block;">
                           ${ind.vigencia}
                        </span>
                        </td>
                            <!-- üìä Secci√≥n de iconos de acci√≥n -->
                        <td>
                            <!-- üìà Ver evoluci√≥n -->
                            <button type="button" class="btn btn-link p-0 ms-1" title="Ver evoluci√≥n"
                                onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}' , '${ind.unico_eval}')">
                                <i class="fas fa-chart-line text-primary"></i>
                            </button>

                            <!-- ‚ÑπÔ∏è Detalle del indicador -->
                            <button type="button" class="btn btn-link p-0 ms-1" title="Ver detalle del indicador"
                                onclick="verDetalleIndicador('${ind.codigo_id}')">
                                <i class="fas fa-info-circle text-secondary"></i>
                            </button>

                            <!-- üóÉÔ∏è Mediciones -->
                            <button type="button" class="btn btn-link p-0 ms-1" title="Ver mediciones registradas"
                                onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}' , '${ind.freq_medicion}', '${ind.unico_eval}')">
                                <i class="fas fa-database text-success"></i>
                            </button>
                        </td>
                   `;
                });
        }

        // üìåüìå cargarCumplimientoPorDestino()
        async function cargarCumplimientoPorDestino() {
            const spinner = document.getElementById('spinnerCumplimientoDestinos');
            const tablaContainer = document.getElementById('tablaCumplimientoContainer');
            const tbody = document.getElementById('tablaCumplimientoDestinos');

            spinner.style.display = 'block';
            // üîπ y ahora activ√°s el bot√≥n que oculta el sidebar
            const botonSidebar = document.querySelector('[data-lte-toggle="sidebar"]');
            if (botonSidebar) botonSidebar.click();

            tablaContainer.style.display = 'none';

            try {
                const res = await fetch('/api/cumplimiento-por-destino');
                const data = await res.json();
                localStorage.setItem('destinosMedidos', data.length);

                // --- Renderizar tabla con √≠cono de evoluci√≥n ---
                tbody.innerHTML = data.map(d => {
                    const valor = Number(d.promedio_cumplimiento);
                    const valorSeguro = isNaN(valor) ? 0 : valor;

                    let color = 'text-danger';
                    if (valorSeguro >= 80) color = 'text-success';
                    else if (valorSeguro >= 50) color = 'text-warning';

                    const barra = `
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${color.replace('text-', 'bg-')}" 
                                role="progressbar" 
                                style="width: ${valorSeguro}%;"
                                aria-valuenow="${valorSeguro}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                            </div>
                        </div>`;

                    // ‚úÖ Aqu√≠ agregamos el √≠cono de Evoluci√≥n
                    return `
                        <tr>
                            <td>${d.destino}</td>
                            <td class="text-center">${d.total_indicadores}</td>
                            <td class="text-center fw-semibold ${color}">
                                ${valorSeguro}% ${barra}
                            </td>
                            <td class="text-center text-success fw-semibold">${d.en_meta}</td>
                            <td class="text-center text-danger fw-semibold">${d.criticos}</td>
                            <td class="text-center">
                                <span class="text-primary fw-semibold"
                                    role="button"
                                    style="cursor:pointer"
                                    title="Ver evoluci√≥n del destino"
                                    data-id="${d.id_destino}"
                                    data-nombre="${d.destino}">
                                    Ver
                                </span>
                            </td>
                        </tr>`;
                }).join('');

                spinner.style.display = 'none';
                tablaContainer.style.display = 'block';
                chartContainer.style.display = 'block';

                // Delegaci√≥n de eventos para los √≠conos de evoluci√≥n
                document.getElementById('tablaCumplimientoDestinos').addEventListener('click', async (e) => {
                    const icono = e.target.closest('[data-id]');
                    if (!icono) return;

                    const idDestino = Number(icono.dataset.id);
                    const nombreDestino = icono.dataset.nombre;

                    console.log(`üìà Clic en evoluci√≥n del destino: ${nombreDestino} (ID: ${idDestino})`);

                    // üîπ Mostrar el contenedor del gr√°fico
                    const graficoContainer = document.getElementById('grafico-evolucion');
                    // üîπ Mostrar nombre del destino (si hay un encabezado din√°mico)
                    const titulo = document.querySelector('#grafico-evolucion .card-title');
                    if (titulo) titulo.textContent = `Evoluci√≥n del destino: ${nombreDestino}`;
                    graficoContainer.style.display = 'block';

                    // üîπ Generar gr√°fico espec√≠fico
                    mostrarEvolucionPorArea(idDestino, nombreDestino);

                    // üîπ Obtener y mostrar indicadores del destino
                    await mostrarIndicadoresPorDestino(idDestino, nombreDestino);
                });


            } catch (error) {
                console.error('Error cargando cumplimiento por destino:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error al cargar los datos</td></tr>`;
                spinner.style.display = 'none';
                tablaContainer.style.display = 'block';
                chartContainer.style.display = 'none';
            }
        }

        // üìåüìå mostrarIndicadoresPorDestino
        async function mostrarIndicadoresPorDestino(idDestino, nombreDestino) {
            try {
                const indicadores = indicadoresConDatos.filter(ind => ind.destino == idDestino);
                const tituloDestino = document.getElementById('nombreDestino');
                const contenedor = document.getElementById('indicadores-destino');
                const tbody = contenedor.querySelector('tbody');
                tbody.innerHTML = ''; // limpiar
                tituloDestino.textContent = nombreDestino;

                if (indicadores.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No hay indicadores registrados para este destino.</td></tr>`;
                } else {
                    indicadores.forEach(ind => {
                        if (ind.resultado.tendencia == "En alza") ind.resultado.color = '#28a745'; // verde
                        if (ind.resultado.tendencia == "Estable") ind.resultado.color = '#ffc107'; // amarillo
                        if (ind.resultado.tendencia == "En baja") ind.resultado.color = '#dc3545'; // rojo
                        tbody.innerHTML += `
                                <tr>
                                    <td>${ind.nombre || '-'}</td>
                                    <td>${ind.objetivo || '-'}</td>
                                    <td>${ind.unico_valor || '-'}</td>
                                    <td>${ind.unidad_desc || '-'}</td>
                                    <td>${ind.ultimaMedicion || '-'}</td>
                                    <td>${ind.porcentaje || '-'}</td>
                                    <td>${ind.peso || '-'}</td>
                                    <td style="color: ${ind.resultado.color}">${ind.resultado.tendencia || '-'}</td> 
                                    <!-- üìä Secci√≥n de iconos de acci√≥n -->
                                    <td>
                                        <!-- üìà Ver evoluci√≥n -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver evoluci√≥n"
                                            onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}')">
                                            <i class="fas fa-chart-line text-primary"></i>
                                        </button>

                                        <!-- ‚ÑπÔ∏è Detalle del indicador -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver detalle del indicador"
                                            onclick="verDetalleIndicador('${ind.codigo_id}')">
                                            <i class="fas fa-info-circle text-secondary"></i>
                                        </button>

                                        <!-- üóÉÔ∏è Mediciones -->
                                        <button type="button" class="btn btn-link p-0 ms-2" title="Ver mediciones registradas"
                                            onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}', '${ind.freq_medicion}', '${ind.unico_eval}')">
                                            <i class="fas fa-database text-success"></i>
                                        </button>
                                        </td>
                                </tr>
                                `;
                    });
                }
                contenedor.style.display = 'block';
            } catch (error) {
                console.error('Error cargando indicadores del destino:', error);
            }
        }

        // üìåüìå mostrarEvolucionPorArea(idDestino, nombreDestino)
        let chartEvolucionArea = null;
        let chartBarrasArea = null;

        // üìåüìå mostrarEvolucionPorArea(idDestino, nombreDestino)
        function mostrarEvolucionPorArea(idDestino, nombreDestino) {
            if (!evolucionGlobal || !evolucionGlobal.length) {
                console.warn("‚ö†Ô∏è No hay datos globales cargados a√∫n.");
                return;
            }

            // üîπ Obtener datos del destino seleccionado
            const { labels, indicadoresMap, resumenActual } = obtenerSeriesPorDestino(evolucionGlobal, idDestino);

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // üìà GR√ÅFICO DE L√çNEAS ‚Äì EVOLUCI√ìN TEMPORAL
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const seriesLineas = Object.keys(indicadoresMap).map(indicador => ({
                name: indicador,
                data: indicadoresMap[indicador]
            }));

            const colores = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6610f2', '#20c997'];

            const opcionesEvolucion = {
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        },
                        export: {
                            csv: { filename: `Evolucion_${nombreDestino}` },
                            svg: { filename: `Evolucion_${nombreDestino}` },
                            png: { filename: `Evolucion_${nombreDestino}` }
                        }
                    },
                    zoom: { enabled: true, type: 'x' },
                    animations: { enabled: true, easing: 'easeinout', speed: 600 }
                },
                // title: {
                //     text: `Evoluci√≥n del cumplimiento - ${nombreDestino}`,
                //     align: 'center'
                // },
                stroke: { curve: 'smooth', width: 2 },
                series: seriesLineas,
                colors: colores,
                dataLabels: { enabled: false },
                xaxis: {
                    categories: labels,
                    title: { text: 'Per√≠odo' },
                    labels: { rotate: -45 }
                },
                yaxis: {
                    min: 0, max: 120, tickAmount: 5,
                    title: { text: '% de Cumplimiento' }
                },
                legend: { position: 'bottom' },
                tooltip: {
                    shared: true,
                    y: { formatter: val => `${val.toFixed(1)}%` }
                },
                grid: { borderColor: '#e0e0e0', strokeDashArray: 4 }
            };

            if (chartEvolucionArea) chartEvolucionArea.destroy();
            chartEvolucionArea = new ApexCharts(document.querySelector("#chartEvolucionArea"), opcionesEvolucion);
            chartEvolucionArea.render();

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // üìä GR√ÅFICO DE BARRAS ‚Äì CUMPLIMIENTO ACTUAL (valor/meta)
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const indicadores = Object.keys(indicadoresMap);

            // üîπ Valores actuales: √∫ltimo dato de cada indicador
            const valoresActuales = indicadores.map(ind => {
                const data = indicadoresMap[ind];
                return data[data.length - 1]; // √∫ltimo valor medido
            });

            // üîπ Metas (si no las ten√©s en tu backend, pod√©s ajustarlo aqu√≠)
            const metas = indicadores.map(() => 200); // ejemplo: meta general 200
            // Pod√©s reemplazar esto por metas reales, por ejemplo desde resumenActual[ind].meta

            // üîπ C√°lculo del % de cumplimiento
            const porcentajes = indicadores.map((_, i) => (valoresActuales[i] / metas[i]) * 100);

            const opcionesBarras = {
                chart: {
                    type: 'bar',
                    height: 420,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: false,
                            zoomin: false,
                            zoomout: false,
                            pan: false,
                            reset: false
                        },
                        export: {
                            csv: { filename: `Cumplimiento_${nombreDestino}` },
                            svg: { filename: `Cumplimiento_${nombreDestino}` },
                            png: { filename: `Cumplimiento_${nombreDestino}` }
                        }
                    }
                },
                // title: {
                //     text: `Cumplimiento actual por indicador - ${nombreDestino}`,
                //     align: 'center'
                // },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        dataLabels: { position: 'right' }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val, opts) => {
                        const i = opts.dataPointIndex;
                        return `${valoresActuales[i]} / ${metas[i]} (${porcentajes[i].toFixed(1)}%)`;
                    },
                    style: { colors: ['#000'], fontSize: '13px' },
                    offsetX: 10
                },
                series: [{
                    name: 'Cumplimiento actual',
                    data: porcentajes
                }],
                xaxis: {
                    categories: indicadores,
                    max: 100,
                    title: { text: '% de Cumplimiento' },
                    labels: { formatter: val => `${val}%` }
                },
                colors: ['#28a745'],
                grid: { borderColor: '#ddd', strokeDashArray: 4 },
                legend: { show: false },
                tooltip: {
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const ind = indicadores[dataPointIndex];
                        const actual = valoresActuales[dataPointIndex];
                        const meta = metas[dataPointIndex];
                        const pct = porcentajes[dataPointIndex].toFixed(1);
                        return `
                <div style="padding:6px;">
                    <strong>${ind}</strong><br>
                    Valor: ${actual}<br>
                    Meta: ${meta}<br>
                    Cumplimiento: ${pct}%
                </div>
            `;
                    }
                }
            };

            // üîÑ Destruir gr√°fico previo si existe
            // if (chartBarrasArea) chartBarrasArea.destroy();
            // chartBarrasArea = new ApexCharts(document.querySelector("#chartBarrasArea"), opcionesBarras);
            // chartBarrasArea.render();
        }

        // üìåüìå obtenerSeriesPorDestino(data, idDestino)
        function obtenerSeriesPorDestino(data, idDestino) {
            // Filtrar solo los per√≠odos donde el destino tiene datos
            const dataFiltrada = data.filter(item =>
                item.detalle.some(d => d.destino === idDestino)
            );

            // Generar labels solo con esos per√≠odos
            const labels = dataFiltrada.map(d => d.month);

            const indicadoresMap = {};

            // Recorrer los datos filtrados
            dataFiltrada.forEach(item => {
                item.detalle
                    .filter(d => d.destino === idDestino)
                    .forEach(d => {
                        if (!indicadoresMap[d.indicador]) {
                            indicadoresMap[d.indicador] = [];
                        }
                        indicadoresMap[d.indicador].push(d.cumplimiento);
                    });
            });
            console.log(`labels  ${labels.length}`, labels);
            console.log(`indicadoresMap  ${Object.keys(indicadoresMap).length}`, indicadoresMap);
            return { labels, indicadoresMap };
        }

        // üìåüìå Funci√≥n auxiliar para colores aleatorios suaves
        function getRandomColor() {
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // üìåüìå Calcula siguiente medici√≥n
        function getSiguienteMedicion(ultimaMed, freq) {
            if (!ultimaMed || !freq) return null;
            const tipo = String(freq).substring(2, 4);
            try {
                switch (tipo) {
                    case '01': { // diaria: yyyy-mm-dd
                        const partes = String(ultimaMed.med_valor_periodo).split('-');
                        const d = new Date(partes[0], (partes[1] || 1) - 1, partes[2] || 1);
                        // siguiente d√≠a h√°bil (salta s√°b/dom)
                        d.setDate(d.getDate() + 1);
                        while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() + 1);
                        const yy = d.getFullYear();
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const dd = String(d.getDate()).padStart(2, '0');
                        return `${yy}-${mm}-${dd}`;
                    }
                    case '02': { // semanal: AAAAWW (ej: 202538)
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const week = parseInt(s.slice(4), 10);
                        let nw = week + 1;
                        let ny = year;
                        if (nw > 53) { nw = 1; ny = year + 1; }
                        return `${ny}${String(nw).padStart(2, '0')}`;
                    }
                    case '03': { // quincenal (1..24) AAAAQQ
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const q = parseInt(s.slice(4), 10);
                        let nq = q + 1;
                        let ny = year;
                        if (nq > 24) { nq = 1; ny = year + 1; }
                        return `${ny}${String(nq).padStart(2, '0')}`;
                    }
                    case '04': { // mensual AAAAMM
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const month = parseInt(s.slice(4), 10);
                        let nm = month + 1;
                        let ny = year;
                        if (nm > 12) { nm = 1; ny = year + 1; }
                        return `${ny}${String(nm).padStart(2, '0')}`;
                    }
                    case '05': { // bimestral (1..6) -> AAAABB
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const b = parseInt(s.slice(4), 10);
                        // let nb = b + 1;
                        // let ny = year;
                        // if (nb > 6) { nb = 1; ny = year + 1; }
                        // return `${ny}${nb}`;
                        // lleva la expresi√≥n al numero de mes
                        // bimestre 1 = cubre hasta el mes 2
                        // bimestre 2 = cubre hasta el mes 4
                        // sigte al 2 = 3 => mes 6:  AAAA06 Si estoy en AAAA07 esta demorado.
                        // o sea si actual > proxima => demorado
                        let nb = (b + 1) * 2;  // calcula siguiente bimestre y lo lleva al mes
                        let ny = year;
                        if (nb > 12) { nb = 2; ny = year + 1; }
                        return `${ny}${nb}`;
                    }
                    case '06': { // trimestral (1..4)
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const t = parseInt(s.slice(4), 10);
                        // let nt = t + 1;
                        // let ny = year;
                        // if (nt > 4) { nt = 1; ny = year + 1; }
                        // return `${ny}${nt}`;
                        let nt = (t + 1) * 3;
                        let ny = year;
                        if (nt > 12) { nt = 3; ny = year + 1; }
                        return `${ny}${nt}`;
                    }
                    case '07': { // cuatrimestral (1..3)
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const c = parseInt(s.slice(4), 10);
                        // let nc = c + 1;
                        // let ny = year;
                        // if (nc > 3) { nc = 1; ny = year + 1; }
                        // return `${ny}${nc}`;
                        let nc = (c + 1) * 4;
                        let ny = year;
                        if (nc > 12) { nc = 4; ny = year + 1; }
                        return `${ny}${nc}`;
                    }
                    case '08': { // semestral (1..2)
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        const sem = parseInt(s.slice(4), 10);
                        // let nsem = sem + 1;
                        // let ny = year;
                        // if (nsem > 2) { nsem = 1; ny = year + 1; }
                        // return `${ny}${nsem}`;
                        let nsem = (sem + 1) * 6;
                        let ny = year;
                        if (nsem > 12) { nsem = 6; ny = year + 1; }
                        return `${ny}${nsem}`;
                    }
                    case '09': { // anual -> siguiente a√±o
                        const s = String(ultimaMed.med_valor_periodo);
                        const year = parseInt(s.slice(0, 4), 10);
                        return String(year + 1);
                    }
                    case '10': {
                        const s = String(ultimaMed.med_valor_periodo);
                        return `${s}`;
                    }
                    default:
                        return null;
                }
            } catch (e) {
                return null;
            }
        };

        // üìåüìå buildTarjetas
        function buildTarjetas(indicadoresConDatos) {

            window._indicadoresGlobales = indicadoresConDatos;

            // --- Definiciones ---
            const TIPOS = {
                1: "Estrat√©gico",
                2: "T√°ctico",
                3: "Operativo"
            };

            const CATEGORIAS = {
                1: "Eficiencia",
                2: "Eficacia",
                3: "Calidad",
                4: "Productividad"
            };

            const CRITICIDAD = {
                1: "Alta",
                2: "Media",
                3: "Baja"
            };

            // --- Funci√≥n gen√©rica para calcular grupos ---
            function getGroupStats(arr, field, groupsDefinition) {
                const result = [];

                for (const [id, name] of Object.entries(groupsDefinition)) {

                    // Filtrar por campo + excluir porcentaje null
                    const filtered = arr.filter(ind =>
                        Number(ind[field]) === Number(id) &&
                        ind.porcentaje !== null
                    );

                    const count = filtered.length;

                    const avg = count > 0
                        ? (
                            filtered.reduce((s, i) => s + (parseFloat(i.porcentaje) || 0), 0)
                            / count
                        )
                        : 0;

                    result.push({
                        id,
                        name,
                        count,
                        avg: Number(avg.toFixed(2))
                    });
                }
                return result;
            }


            // --- Render de tarjetas ---

            function renderTarjetas(containerId, data, tipo) {
                const container = document.getElementById(containerId);

                // Paletas e iconos (seguras)
                const palettes = {
                    tipo: ["#cfe2ff", "#e2f0d9", "#ffe5d9"],
                    categoria: ["#d1e7dd", "#ffe5ec", "#fff3cd", "#e2e3ff"],
                    criticidad: ["#f8d7da", "#fff3cd", "#d1e7dd"]
                };
                const icons = {
                    tipo: ["üìä", "üìà", "‚öôÔ∏è"],
                    categoria: ["‚ö°", "üéØ", "‚≠ê", "üì¶"],
                    criticidad: ["üî¥", "üü°", "üü¢"]
                };

                const palette = palettes[tipo] || ["#f0f0f0"];
                const iconset = icons[tipo] || ["üìå"];

                container.innerHTML = `
                            <div class="row">
                                ${data.map((item, i) => {
                    const bg = palette[i] || "#f0f0f0";
                    const icon = iconset[i] || "üìå";
                    // data-field = tipo/categoria/criticidad, data-key = id num√©rico
                    return `
                                <div class="col-4">
                                    <div class="mini-card mb-2 p-2 colored-${i + 1}" 
                                        data-field="${tipo}"
                                        data-key="${item.id}"
                                        data-name="${escapeHtml(item.name)}"
                                        style="background:${bg}; border-radius:10px; cursor:pointer;">
                                        <div style="font-size:1.4rem">${icon}</div>
                                        <h6 class="mt-1 mb-1">${escapeHtml(item.name)}</h6>
                                        <div><strong>Cant:</strong> ${item.count}</div>
                                        <div class="value"><strong>${item.avg}%</strong></div>
                                    </div>
                                </div>
                            `;
                }).join("")}
                    </div>
                `;


                // Despu√©s de renderizar, agrego los listeners
                container.querySelectorAll('.mini-card').forEach(card => {
                    card.addEventListener('click', function () {
                        const name = this.getAttribute('data-name');
                        const field = this.getAttribute('data-field');
                        const id = this.getAttribute('data-key');

                        // Llamo a la funci√≥n que muestra el modal (puede seguir siendo local)
                        mostrarDetalleTarjeta(name, field, id);
                    });
                });
            }


            // --- Ejecutar renderizaci√≥n final ---
            renderTarjetas(
                "tarjetaTipos",
                getGroupStats(indicadoresConDatos, "tipo", TIPOS),
                "tipo",
                indicadoresConDatos
            );

            renderTarjetas(
                "tarjetaCategorias",
                getGroupStats(indicadoresConDatos, "categoria", CATEGORIAS),
                "categoria",
                indicadoresConDatos
            );

            renderTarjetas(
                "tarjetaCriticidad",
                getGroupStats(indicadoresConDatos, "criticidad", CRITICIDAD),
                "criticidad",
                indicadoresConDatos
            );

        }

        // üìåüìå mostrarDetalleTarjeta
        function mostrarDetalleTarjeta(nombre, field, id) {

            const titulo = document.getElementById("modalTarjetaTitulo");
            const contenido = document.getElementById("modalTarjetaContenido");

            titulo.textContent = `Indicadores de: ${nombre}`;

            // Filtrar indicadores globales
            const indicadores = window._indicadoresGlobales.filter(ind =>
                Number(ind[field]) === Number(id) &&
                ind.porcentaje !== null
            );

            if (indicadores.length === 0) {
                contenido.innerHTML = `<p>No hay indicadores disponibles.</p>`;
            } else {
                contenido.innerHTML = `
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>√ölt. %</th>
                                <th>Responsable</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${indicadores.map(ind => `
                                <tr>
                                    <td>${ind.codigo_id}</td>
                                    <td>${ind.nombre}</td>
                                    <td><strong>${ind.porcentaje}%</strong></td>
                                    <td>${ind.usuario}</td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                `;
            }

            // Abrir modal Bootstrap
            const modalEl = document.getElementById("modalTarjetaDetalle");
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } else {
                console.warn("No se encontr√≥ #modalTarjetaDetalle en el DOM.");
            }
        }


        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        async function cargarIndicadoresBSC() {
            const spinner = document.getElementById("spinnerCarga");
            if (spinner) spinner.style.display = "block"; // Mostrar spinner

            try {
                const data = indicadoresConDatos;

                // Traer cumplimiento de cada indicador
                const indicadoresConCumplimiento = await Promise.all(
                    data.map(async (ind) => {
                        try {
                            const r = await fetch(`/api/indicadores/${ind.codigo_id}/cumplimiento`);
                            const cumplimientoData = await r.json();
                            return { ...ind, cumplimiento: cumplimientoData?.porcentaje || 0 };
                        } catch {
                            return { ...ind, cumplimiento: 0 };
                        }
                    })
                );

                const resumenPorDimension = agruparPorDimension(indicadoresConCumplimiento);

                localStorage.setItem(
                    "resumenPorDimension",
                    JSON.stringify(resumenPorDimension)
                );

                console.log('guardo el resumen por dimension en local storage')

                renderGraficos(resumenPorDimension);
                renderTabla(resumenPorDimension);

            } catch (err) {
                console.error("Error cargando indicadores:", err);
                alert("‚ùå No se pudieron cargar los indicadores");
            } finally {
                if (spinner) spinner.style.display = "none"; // Ocultar spinner
            }
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function agruparPorDimension(indicadores) {
            const grupos = {};
            indicadores.forEach(ind => {
                const dimension = ind.dimension || "Sin Dimensi√≥n";
                if (!grupos[dimension]) grupos[dimension] = [];
                grupos[dimension].push(ind);
            });

            return Object.keys(grupos).map(dimension => {
                const inds = grupos[dimension];
                const promedio = inds.reduce((acc, ind) => acc + (Number(ind.cumplimiento) || 0), 0) / inds.length;
                const promedioPon = inds.reduce((acc, ind) => acc + ((Number(ind.cumplimiento) * (Number(ind.pesoBSC)) / 100) || 0), 0);

                return { dimension, indicadores: inds, promedio: promedio.toFixed(2), promedioPon: promedioPon.toFixed(2) };
            });
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function XXXmostrarIndicadoresDeDimension(dimension, resumen) {
            if (!resumen) return;

            const dimensionData = resumen.find(d => d.dimension === dimension);
            if (!dimensionData) return;

            const contenedor = document.getElementById("detalleIndicadoresContainer");
            const titulo = document.getElementById("detalleIndicadoresTitulo");
            const tbody = document.getElementById("tbodyDetalleIndicadores");
            if (!contenedor || !tbody || !titulo) return;

            titulo.textContent = `Indicadores de Perspectiva ${dimension}`;
            tbody.innerHTML = '';

            let totalPonderado = 0;

            dimensionData.indicadores.forEach(ind => {
                const estado = ind.cumplimiento >= 80 ? '‚úÖ Alto' :
                    ind.cumplimiento >= 50 ? '‚ö†Ô∏è Medio' : '‚ùå Bajo';

                const ponderado = ind.cumplimiento * ind.pesoBSC / 100;
                totalPonderado += ponderado;   // üîπ ACUMULA

                tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${ind.nombre}</td>
                    <td>${ind.sector}</td>
                    <td class="text-center">${ind.usuario}</td>
                    <td class="text-center">${ind.unico_valor} ${ind.unidad_desc || ''}</td>
                    <td class="text-center">${Number(ind.cumplimiento).toFixed(1)} %</td>
                    <td class="text-center">${ind.pesoBSC != null ? ind.pesoBSC + ' %' : '-'}</td>
                    <td class="text-center">${ponderado.toFixed(2)} %</td>
                    <td>${estado}</td>
                    <td>

                    <!-- üìà Ver evoluci√≥n -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver evoluci√≥n"
                        onclick="verGraficoIndicador('${ind.id}', '${ind.nombre}', '${ind.unico_valor}', '${ind.descripcion}')">
                        <i class="fas fa-chart-line text-primary"></i>
                    </button>

                    <!-- ‚ÑπÔ∏è Detalle del indicador -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver detalle del indicador"
                        onclick="verDetalleIndicador('${ind.codigo_id}')">
                        <i class="fas fa-info-circle text-secondary"></i>
                    </button>

                    <!-- üóÉÔ∏è Mediciones -->
                    <button type="button" class="btn btn-link p-0 ms-1" title="Ver mediciones registradas"
                        onclick="mostrarModalMediciones('${ind.id}', '${ind.codigo_id}', '${ind.nombre}', '${ind.freq_medicion}', '${ind.unico_eval}')">
                        <i class="fas fa-database text-success"></i>
                    </button>
                    </td>

                </tr>
                `);
            });

            // agrega total de ponderado
            tbody.insertAdjacentHTML('beforeend', `
                    <tr class="table-secondary fw-bold">
                        <td colspan="6" class="text-end">Total ponderado</td>
                        <td class="text-center">${totalPonderado.toFixed(2)} %</td>
                        <td colspan="2"></td>
                    </tr>
                `);

            contenedor.style.display = 'block';
        }


        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function mostrarIndicadoresDeDimension(dimension, resumen) {
            if (!resumen) return;

            const dimensionData = resumen.find(d => d.dimension === dimension);
            if (!dimensionData) return;

            const contenedor = document.getElementById("detalleIndicadoresContainer");
            const titulo = document.getElementById("detalleIndicadoresTitulo");
            const tbody = document.getElementById("tbodyDetalleIndicadores");
            if (!contenedor || !tbody || !titulo) return;

            titulo.textContent = `Indicadores de Perspectiva ${dimension}`;
            tbody.innerHTML = '';

            const { html } = construirTablaIndicadores(dimensionData);
            tbody.innerHTML = html;

            contenedor.style.display = 'block';
        }



        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function verGraficoIndicador(key_id, nombre, meta, descripcion, metodo) {
            // Guardar en sessionStorage
            sessionStorage.setItem('indicador_seleccionado', key_id);
            document.getElementById('grafico-evolucion-Full').style.display = 'block';
            // Llama a la funci√≥n que renderiza el gr√°fico
            console.log('Renderizando gr√°fico para indicador:', key_id, 'con metodo', metodo);

            renderIndicadorChart(key_id, nombre, meta, descripcion, metodo)

        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        let chartBSC = null;
        let graficosListos = 0;
        const TOTAL_GRAFICOS = 1; // ajust√° si hay m√°s

        function renderGraficos(resumenPorDimension) {

            const COLORES_DIMENSIONES = [
                "#0d6efd", "#198754", "#ffc107", "#dc3545",
                "#6f42c1", "#20c997", "#fd7e14", "#0dcaf0"
            ];

            const barVerticalDiv = document.querySelector("#chartBarDimensiones");
            if (barVerticalDiv) barVerticalDiv.innerHTML = '';

            const valores = resumenPorDimension.map(d => parseFloat(d.promedio));
            const labels = resumenPorDimension.map(d => d.dimension);

            if (barVerticalDiv) {

                // üëâ GUARD√ÅS la instancia del gr√°fico
                chartBSC = new ApexCharts(barVerticalDiv, {
                    chart: {
                        type: 'bar',
                        height: 350,
                        toolbar: { show: false },
                        events: {
                            mounted: () => {
                                graficosListos++;
                                verificarGraficos();
                            },
                            dataPointSelection: (e, ctx, config) => {
                                const dim = labels[config.dataPointIndex];
                                mostrarIndicadoresDeDimension(dim, resumenPorDimension);
                            }
                        }
                    },
                    series: [{
                        name: "Cumplimiento promedio",
                        data: valores
                    }],
                    xaxis: { categories: labels },
                    yaxis: {
                        min: 0,
                        max: 100,
                        title: { text: "Cumplimiento (%)" }
                    },
                    plotOptions: {
                        bar: {
                            distributed: true,
                            borderRadius: 5,
                            columnWidth: "55%"
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: v => v.toFixed(1) + "%"
                    },
                    colors: COLORES_DIMENSIONES
                });

                chartBSC.render();

            }
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function renderTabla(resumenPorDimension) {
            const tbody = document.getElementById("tbodyDimensiones");
            if (!tbody) return;
            tbody.innerHTML = '';
            resumenPorDimension.forEach(d => {

                const estado = d.promedioPon >= 80 ? '‚úÖ Alto' :
                    d.promedioPon >= 50 ? '‚ö†Ô∏è Medio' : '‚ùå Bajo';

                console.log(`valores promedio: ${d.promedioPon}`)

                tbody.insertAdjacentHTML('beforeend', `
                    <tr style="cursor:pointer" onclick="mostrarIndicadoresDeDimension('${d.dimension}', resumenPorDimension)">
                        <td>${d.dimension}</td>
                        <td class="text-center">${d.indicadores.length}</td>
                        <td class="text-center">${d.promedio}%</td>
                        <td class="text-center">${d.promedioPon}%</td>
                        <td class="text-center">${estado}</td>
                    </tr>
                `);
            });
        }


        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function construirTablaIndicadores(dimensionData) {
            let totalPonderado = 0;
            let rowsHTML = '';

            dimensionData.indicadores.forEach(ind => {
                const estado = ind.cumplimiento >= 80 ? '‚úÖ Alto' :
                    ind.cumplimiento >= 50 ? '‚ö†Ô∏è Medio' : '‚ùå Bajo';

                const ponderado = ind.cumplimiento * ind.pesoBSC / 100;
                totalPonderado += ponderado;

                rowsHTML += `
                    <tr>
                        <td>${ind.nombre}</td>
                        <td>${ind.sector}</td>
                        <td class="text-center">${ind.usuario}</td>
                        <td class="text-center">${ind.unico_valor} ${ind.unidad_desc || ''}</td>
                        <td class="text-center">${Number(ind.cumplimiento).toFixed(1)} %</td>
                        <td class="text-center">${ind.pesoBSC != null ? ind.pesoBSC + ' %' : '-'}</td>
                        <td class="text-center">${ponderado.toFixed(2)} %</td>
                        <td>${estado}</td>
                    </tr>
                `;
            });

            rowsHTML += `
                    <tr class="table-secondary fw-bold">
                        <td colspan="6" class="text-end">Total ponderado</td>
                        <td class="text-center">${totalPonderado.toFixed(2)} %</td>
                        <td></td>
                    </tr>
                `;

            return {
                html: rowsHTML,
                total: totalPonderado
            };
        }

        // üéØüéØüéØüìåüìåüìåüìåüìåüìåüìå
        function generarDetalleCompletoParaInforme(resumen) {
            const detallePorDimension = {};

            resumen.forEach(dimensionData => {
                const { html, total } = construirTablaIndicadores(dimensionData);

                detallePorDimension[dimensionData.dimension] = {
                    titulo: `Indicadores de Perspectiva ${dimensionData.dimension}`,
                    html,
                    total: total.toFixed(2)
                };
            });

            localStorage.setItem(
                "detalleIndicadoresPorPerspectiva",
                JSON.stringify(detallePorDimension)
            );
        }


        // funci√≥n auxiliar para escapar texto en inserciones HTML
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        window.verificarGraficos = function () {
            if (graficosListos === TOTAL_GRAFICOS) {
                const btn = document.getElementById("btnPDF");
                const icon = document.getElementById("iconPDF");
                const text = document.getElementById("textPDF");

                btn.disabled = false;
                text.textContent = "Ver preliminar de PDF";
                icon.style.display = "none";
            }
        };


        document.getElementById("btnPDF").addEventListener("click", async () => {

            if (graficosListos !== TOTAL_GRAFICOS) return;

            const { imgURI } = await chartBSC.dataURI({ scale: 2 });
            localStorage.setItem("graficoBSC_Barras", imgURI);

            const resumenPorDimension = JSON.parse(
                localStorage.getItem("resumenPorDimension")
            );

            if (!resumenPorDimension) {
                alert("‚ùå No hay datos de indicadores para generar el informe");
                return;
            }

            generarDetalleCompletoParaInforme(resumenPorDimension);

            window.open("informePDF.html", "_blank");
        });

    </script>

    <div class="modal fade" id="modalTarjetaDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-3">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTarjetaTitulo"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" id="modalTarjetaContenido">
                    Cargando...
                </div>
            </div>
        </div>
    </div>


    <!-- Librer√≠a jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Spinner / Modal flotante -->
    <div id="spinnerOverlay" style="
                display:none;
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 2000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                color: white;
                font-size: 1.2rem;
                ">
        <div class="spinner-border text-light mb-3" role="status">
            <span class="visually-hidden">Generando PDF...</span>
        </div>
        <span id="spinnerText">Generando informe PDF, por favor espere...</span>
    </div>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // document.getElementById('btnDescargarPDF').addEventListener('click', async () => {
        //     const { jsPDF } = window.jspdf;
        //     const spinner = document.getElementById('spinnerOverlay');
        //     const spinnerText = document.getElementById('spinnerText');

        //     try {
        //         // Mostrar spinner
        //         spinner.style.display = 'flex';
        //         spinnerText.textContent = 'Generando informe PDF, por favor espere...';

        //         const fecha = new Date();
        //         const fechaISO = fecha.toISOString().slice(0, 10);
        //         const nombreArchivo = `Evolucion_Cumplimiento_Global_${fechaISO}.pdf`;

        //         // =========================
        //         // üß© Funci√≥n modular: Encabezado + Pie
        //         // =========================
        //         const agregarEncabezadoYPie = (doc, titulo, numeroPagina) => {
        //             const pageWidth = doc.internal.pageSize.getWidth();
        //             const pageHeight = doc.internal.pageSize.getHeight();

        //             // Encabezado
        //             doc.setFontSize(16);
        //             doc.setFont('helvetica', 'bold');
        //             doc.text(titulo, pageWidth / 2, 20, { align: 'center' });

        //             // Pie
        //             doc.setFontSize(10);
        //             doc.setTextColor(120);
        //             doc.text(
        //                 `Informe PKI - P√°gina ${numeroPagina}`,
        //                 pageWidth / 2,
        //                 pageHeight - 15,
        //                 { align: 'center' }
        //             );

        //             // Restaurar color
        //             doc.setTextColor(0, 0, 0);
        //         };

        //         // =========================
        //         // üìÑ Crear documento
        //         // =========================
        //         const doc = new jsPDF();

        //         // üè¢ Logo
        //         const logoUrl = 'dist/images/leon2.png';
        //         try {
        //             const img = new Image();
        //             img.crossOrigin = 'anonymous';
        //             img.src = logoUrl;
        //             await new Promise(resolve => (img.onload = resolve));
        //             doc.addImage(img, 'PNG', 15, 10, 40, 20);
        //         } catch (err) {
        //             console.warn('No se pudo cargar el logo:', err);
        //         }

        //         // =========================
        //         // üßæ P√°gina 1: Resumen general
        //         // =========================
        //         agregarEncabezadoYPie(doc, 'Reporte de Evoluci√≥n del Cumplimiento Global', 1);

        //         const fechaStr = fecha.toLocaleDateString('es-AR');
        //         doc.setFontSize(12);
        //         doc.text(`Fecha de generaci√≥n: ${fechaStr}`, 60, 35);

        //         const chart = window.globalChartInstance;
        //         if (!chart) {
        //             alert('‚ö†Ô∏è No se encontr√≥ el gr√°fico de evoluci√≥n global.');
        //             spinner.style.display = 'none';
        //             return;
        //         }

        //         const valores = chart.data.datasets[0].data;
        //         const labels = chart.data.labels;
        //         const promedio = (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2);
        //         const ultimoValor = valores[valores.length - 1];
        //         const ultimoMes = labels[labels.length - 1];

        //         // Texto resumen
        //         doc.setFontSize(14);
        //         doc.text('Resumen de datos:', 20, 55);
        //         doc.setFontSize(12);
        //         doc.text(`‚Ä¢ Promedio general de cumplimiento: ${promedio}%`, 25, 65);
        //         doc.text(`‚Ä¢ √öltimo valor (${ultimoMes}): ${ultimoValor}%`, 25, 73);

        //         const texto = [
        //             'Este informe refleja la evoluci√≥n mensual del cumplimiento global de los indicadores PKI.',
        //             'El gr√°fico de la p√°gina siguiente permite analizar las tendencias, avances y √°reas que requieren atenci√≥n.',
        //             '',
        //             'El cumplimiento promedio se calcula como la media de todos los meses registrados, mientras que el √∫ltimo valor corresponde al mes m√°s reciente disponible.'
        //         ];
        //         doc.text(texto, 20, 90, { maxWidth: 170, align: 'justify' });

        //         // =========================
        //         // üìä P√°gina 2: Gr√°fico de evoluci√≥n (canvas)
        //         // =========================
        //         doc.addPage();
        //         agregarEncabezadoYPie(doc, 'Gr√°fico de Evoluci√≥n Global', 2);

        //         const canvas = document.getElementById('evolucionChart');
        //         await new Promise(r => setTimeout(r, 300)); // asegurar render completo

        //         const imgData = canvas.toDataURL('image/png', 1.0);
        //         const pageWidth = doc.internal.pageSize.getWidth();
        //         const pageHeight = doc.internal.pageSize.getHeight();
        //         const imgWidth = pageWidth - 30;
        //         const imgHeight = (canvas.height / canvas.width) * imgWidth;
        //         const yPos = (pageHeight - imgHeight) / 2;

        //         doc.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight);

        //         // =========================
        //         // üåê P√°gina 3: Ring Global + tendencias
        //         // =========================
        //         doc.addPage();
        //         agregarEncabezadoYPie(doc, 'Cumplimiento Global de la Organizaci√≥n', 3);

        //         // Obtener datos del DOM
        //         const ringSvg = document.getElementById('ringGlobal');
        //         const vsMesAnterior = document.getElementById('vsMesAnterior')?.textContent || '-';
        //         const promHistorico = document.getElementById('promHistorico')?.textContent || '-';
        //         const promAnual = document.getElementById('promAnual')?.textContent || '-';
        //         const tendencia = document.getElementById('tendencia')?.textContent || '-';

        //         // Convertir el SVG en PNG v√°lido
        //         const svgData = new XMLSerializer().serializeToString(ringSvg);
        //         const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        //         const svgUrl = URL.createObjectURL(svgBlob);
        //         const svgImg = new Image();
        //         svgImg.src = svgUrl;
        //         await new Promise(resolve => (svgImg.onload = resolve));

        //         const canvasTmp = document.createElement('canvas');
        //         canvasTmp.width = 1000;
        //         canvasTmp.height = 1000;

        //         const ctx = canvasTmp.getContext('2d');
        //         ctx.drawImage(svgImg, 0, 0, canvasTmp.width, canvasTmp.height);
        //         const pngData = canvasTmp.toDataURL('image/png');

        //         // Centrar imagen
        //         const imgMaxWidth = pageWidth * 0.7;
        //         const imgHeightRing = imgMaxWidth;
        //         const imgX = (pageWidth - imgMaxWidth) / 2;
        //         const imgY = 50;

        //         doc.addImage(pngData, 'PNG', imgX, imgY, imgMaxWidth, imgHeightRing);

        //         // Cuadro de datos debajo del gr√°fico
        //         const yBase = imgY + imgHeightRing + 25;
        //         const lineSpacing = 10;

        //         doc.setFillColor(245, 245, 245);
        //         doc.roundedRect(40, yBase - 10, pageWidth - 80, 55, 3, 3, 'F');
        //         doc.setTextColor(40, 40, 40);
        //         doc.setFontSize(12);
        //         doc.text(`‚Ä¢ vs. Mes Anterior: ${vsMesAnterior}`, 50, yBase + 5);
        //         doc.text(`‚Ä¢ Promedio Hist√≥rico: ${promHistorico}`, 50, yBase + 5 + lineSpacing);
        //         doc.text(`‚Ä¢ Promedio Anual: ${promAnual}`, 50, yBase + 5 + lineSpacing * 2);
        //         doc.text(`‚Ä¢ Tendencia: ${tendencia}`, 50, yBase + 5 + lineSpacing * 3);

        //         // =========================
        //         // üíæ Descargar PDF
        //         // =========================
        //         doc.save(nombreArchivo);

        //         spinnerText.textContent = `‚úÖ Informe generado correctamente.
        //             El archivo se descarg√≥ como: ${nombreArchivo}`;
        //         setTimeout(() => (spinner.style.display = 'none'), 2500);
        //     } catch (error) {
        //         console.error(error);
        //         alert('‚ùå Error al generar el informe.');
        //         spinner.style.display = 'none';
        //     }
        // });

        /*
        üß© C√≥mo extender con nuevas secciones
        Si despu√©s quer√©s agregar m√°s p√°ginas (por ejemplo, un gr√°fico por sector o KPI), solo ten√©s que usar esta plantilla modular:
        doc.addPage();
        agregarEncabezadoYPie(doc, 'T√≠tulo de la nueva secci√≥n', numeroPagina);
        // ... contenido nuevo (texto, imagen o gr√°fico) */

    </script>

    <script>
        const avatarAudio = document.getElementById('avatarAudio');
        const btnDetener = document.getElementById('btnDetenerVoz');

        const textoExplicativo = `
    ¬°Hola! Bienvenido a My Result IQ, la herramienta ideal para la gesti√≥n de indicadores.
    Soy tu asistente virtual y estoy aqu√≠ para guiarte en el uso de la aplicaci√≥n y ayudarte a aprovechar todo su potencial.
    En este sistema trabajamos con dos conceptos clave: usuarios habilitados y destinos. Los destinos representan las diferentes √°reas, unidades funcionales o procesos de tu organizaci√≥n.
    A cada destino se le asignan indicadores que permiten medir su desempe√±o. Cada indicador tiene una importancia relativa dentro del destino, y la suma de todas estas importancias siempre equivale al 100%.
    De manera similar, cuando un destino est√° compuesto por destinos dependientes ‚Äîpor ejemplo, sectores dentro de una gerencia, o gerencias dentro de una direcci√≥n‚Äî cada uno tiene un porcentaje asociado que tambi√©n suma 100% en ese nivel.
    Gracias a esta estructura jer√°rquica, el sistema calcula autom√°ticamente el porcentaje de cumplimiento global de tu organizaci√≥n, bas√°ndose en el rendimiento de cada destino y su relevancia dentro del nivel superior.
    Estoy aqu√≠ para ayudarte a explorar estos conceptos y entender c√≥mo evoluciona el desempe√±o de tu organizaci√≥n.
    ¬°Comencemos!
    `;

        let vozSeleccionada = null;

        // üîä Seleccionar voz en espa√±ol (prioriza Google)
        function obtenerVozEspa√±ol() {
            const voces = speechSynthesis.getVoices();
            if (!voces.length) return null;

            const vozGoogle = voces.find(v => v.name.toLowerCase().includes("google") && v.lang.startsWith("es"));
            const vozEspa√±ol = voces.find(v => v.lang.startsWith("es"));
            vozSeleccionada = vozGoogle || vozEspa√±ol || voces[0];
            return vozSeleccionada;
        }

        // üéôÔ∏è Hablar
        function hablar(texto = textoExplicativo) {
            if (!('speechSynthesis' in window)) {
                alert('Tu navegador no soporta la funci√≥n de voz.');
                return;
            }

            detener(); // Si ya est√° hablando, detener primero

            const utterance = new SpeechSynthesisUtterance(texto);
            const voz = obtenerVozEspa√±ol();
            if (voz) utterance.voice = voz;
            utterance.lang = "es-ES";
            utterance.rate = 1;
            utterance.pitch = 1.05;

            // Eventos visuales
            utterance.onstart = () => {
                avatarAudio.classList.add('speaking');
                btnDetener.style.display = 'block';
            };
            utterance.onend = () => detener();
            utterance.onerror = () => detener();

            speechSynthesis.speak(utterance);
        }

        // üõë Detener voz
        function detener() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            avatarAudio.classList.remove('speaking');
            btnDetener.style.display = 'none';
        }

        // üéß Eventos
        avatarAudio.addEventListener('click', () => hablar());
        btnDetener.addEventListener('click', detener);
        window.speechSynthesis.onvoiceschanged = () => obtenerVozEspa√±ol();
    </script>

    <style>
        /* Efecto de "hablando" */
        #avatarAudio.speaking {
            animation: pulse 1.2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }
    </style>

    <!-- ===================== MODAL DE PRESENTACI√ìN DEL ASISTENTE ===================== -->
    <div class="modal fade" id="asistenteBienvenidaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0 rounded-4">
                <div class="modal-body p-4 text-center">

                    <!-- üß† Avatar del asistente con efecto de ondas -->
                    <div id="avatarContainer" style="position: relative; display: inline-block; margin-bottom: 1rem;">
                        <div id="ondaSonido" style="position:absolute; top:50%; left:50%; width:100px; height:100px; border-radius:50%;
                      transform:translate(-50%, -50%); background:rgba(0,123,255,0.2); opacity:0;
                      transition:opacity 0.3s, transform 0.3s;"></div>

                        <img id="avatarAsistenteModal" src="/dist/images/avatar-neutral.svg" alt="Asistente KPI" style="width:100px; height:100px; cursor:pointer; border-radius:50%;
                      box-shadow:0 0 10px rgba(0,0,0,0.25); transition:transform 0.2s;" />
                    </div>

                    <!-- üí¨ Mensaje -->
                    <h4 class="fw-semibold text-secondary">¬°Hola! Soy tu asistente virtual myResultIQ</h4>
                    <p class="mt-2 text-muted">
                        Bienvenido al panel de gesti√≥n. Aqu√≠ podr√°s visualizar y analizar los indicadores clave de
                        desempe√±o.<br>
                        La presentaci√≥n general del sistema pod√©s volver a escucharla en cualquier momento, usando el
                        asistente que aparece en cada secci√≥n.
                    </p>

                    <!-- üéß Bot√≥n para escuchar la introducci√≥n -->
                    <div class="mt-3">
                        <button id="btnEscucharIntro" class="btn btn-outline-primary rounded-pill">
                            <i class="fas fa-volume-up me-2"></i> Escuchar introducci√≥n
                        </button>
                    </div>

                    <!-- üîò Checkbox para no volver a mostrar -->
                    <div class="form-check d-inline-flex align-items-center justify-content-center mt-4">
                        <input class="form-check-input me-2" type="checkbox" value="" id="noMostrarBienvenida">
                        <label class="form-check-label text-muted" for="noMostrarBienvenida">
                            No volver a mostrar esta introducci√≥n
                        </label>
                    </div>

                    <!-- üöÄ Bot√≥n para continuar -->
                    <div class="mt-4">
                        <button id="btnContinuarAsistente" class="btn btn-primary px-4 rounded-pill">
                            Continuar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== SCRIPT DEL MODAL ===================== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            window.modalDetalleMes = new bootstrap.Modal(document.getElementById('detalleModal'));
            const modal = new bootstrap.Modal(document.getElementById('asistenteBienvenidaModal'), { backdrop: 'static' });
            const checkbox = document.getElementById('noMostrarBienvenida');
            const btnContinuar = document.getElementById('btnContinuarAsistente');
            const btnEscucharIntro = document.getElementById('btnEscucharIntro');
            const avatar = document.getElementById('avatarAsistenteModal');
            const onda = document.getElementById('ondaSonido');

            const ocultarBienvenida = localStorage.getItem('ocultarBienvenida') === 'true';

            console.log(`valor de ocultar ${ocultarBienvenida}`)

            if (!ocultarBienvenida) {
                modal.show();
            }

            // Guardar preferencia y cerrar
            btnContinuar.addEventListener('click', () => {
                if (checkbox.checked) {
                    localStorage.setItem('ocultarBienvenida', 'true')
                };
                modal.hide();
                speechSynthesis.cancel(); // Detener voz al salir
                console.log(
                    'guardando ocultar bienvenida',
                    localStorage.getItem('ocultarBienvenida')
                );
            });

            // Texto de presentaci√≥n
            const textoIntro = "Bienvenido al sistema de gesti√≥n de indicadores myResult IQ.  En cada secci√≥n de la aplicaci√≥n me encontrar√°s disponible para comentarte sobre los aspectos particulares a considerar en la secci√≥n, que te permitan el mejor uso y aprovechamiento de la aplicaci√≥n.  Como introducci√≥n general, me gustar√≠a comentarte sobre la secuencia de utilizaci√≥n de la aplicaci√≥n.  La tarea inicial es la definici√≥n de lo que denominamos Destinos, que son aquellas √°reas, unidades funcionales o procesos de los que queremos monitorear su comportamiento a trav√©s de los indicadores.  Definidos los Destinos, corresponde registrar a los usuarios de la aplicaci√≥n con sus distintos roles y vinculaci√≥n con el Destino.  Luego corresponde definir los indicadores con sus objetivos, metas, formas de c√°lculo, asign√°ndolos a un Destino y vincul√°ndolos con un responsable.  Una vez hecho esto, ya podr√°s registrar las mediciones correspondientes a cada indicador, y el sistema calcular√° autom√°ticamente el cumplimiento de cada uno, as√≠ como el cumplimiento global de la organizaci√≥n, ponderando cada Destino seg√∫n su importancia relativa en el nivel superior.  Estoy aqu√≠ para ayudarte a explorar estos conceptos y entender c√≥mo evoluciona el desempe√±o de tu organizaci√≥n.  ¬°Comencemos!";


            // Reproducir voz
            function hablarTextoIntro(texto) {
                if (!('speechSynthesis' in window)) return;
                speechSynthesis.cancel();

                const utter = new SpeechSynthesisUtterance(texto);
                utter.lang = 'es-ES';
                utter.rate = 1;
                utter.pitch = 1.05;
                const voces = speechSynthesis.getVoices();
                const vozGoogle = voces.find(v => v.name.toLowerCase().includes("google") && v.lang.startsWith("es"));
                utter.voice = vozGoogle || voces.find(v => v.lang.startsWith("es")) || voces[0];

                // Activar efecto visual de onda
                onda.style.opacity = '1';
                onda.style.transform = 'translate(-50%, -50%) scale(1.2)';

                speechSynthesis.speak(utter);

                // Quitar efecto al terminar
                utter.onend = () => {
                    onda.style.opacity = '0';
                    onda.style.transform = 'translate(-50%, -50%) scale(1)';
                };
            }

            // Click en avatar o bot√≥n ‚ÄúEscuchar introducci√≥n‚Äù
            avatar.addEventListener('click', () => hablarTextoIntro(textoIntro));
            btnEscucharIntro.addEventListener('click', () => hablarTextoIntro(textoIntro));

            // üîÅ Reactivar introducci√≥n desde el bot√≥n del navbar
            const btnReactivarIntro = document.getElementById('btnReactivarIntro');
            if (btnReactivarIntro) {
                btnReactivarIntro.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('ocultarBienvenida'); // üîπ elimina la preferencia
                    modal.show(); // üîπ muestra nuevamente el modal
                });
            }
        });

    </script>

    <div id="contenedorModal"></div>
    <div id="contenedorModalMediciones"></div>
    <div id="contenedorModalUsuario"></div>
    <div id="contenedorModalLogout"></div>

    <script>
        // Cargar modal de indicadores
        fetch('/modal-indicador.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('contenedorModal').innerHTML = html;
            });

        // Cargar modal de mediciones
        fetch('/modal-mediciones.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('contenedorModalMediciones').innerHTML = html;
            });

        // Cargar modal usuario
        fetch('/modal-usuario.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('contenedorModalUsuario').innerHTML = html;
            });

        // Cargar modal logout
        fetch('/modal-logout.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('contenedorModalLogout').innerHTML = html;
            });

        //     const btnLogout = document.getElementById('confirmLogout');
        //     if (!btnLogout) return;

        //     btnLogout.addEventListener('click', async () => {
        //         // Cerrar modal
        //         const modalEl = document.getElementById('logoutModal');
        //         const modal = bootstrap.Modal.getInstance(modalEl);
        //         if (modal) modal.hide();

        //         // üîê Auditor√≠a logout
        //         const token = localStorage.getItem('token');
        //         if (token) {
        //             try {
        //                 await fetch('/api/auth/logout', {
        //                     method: 'POST',
        //                     headers: {
        //                         Authorization: 'Bearer ' + token
        //                     }
        //                 });
        //             } catch (e) {
        //                 console.warn('No se pudo registrar logout');
        //             }
        //         }

        //         // üßπ Limpiar sesi√≥n
        //         localStorage.clear();
        //         sessionStorage.clear();

        //         // üöÄ Redirigir
        //         window.location.href = '/';
        //     });
        // });

    </script>

    <script src="/modal-indicador.js"></script>
    <script src="/modal-mediciones.js"></script>
    <script src="/modal-usuario.js"></script>

    <script src="/js/layout.js"></script>
    <script src="/js/navbar-user.js"></script>
    <script src="/js/logout.js"></script>

    <script>
        fetch('/kpi-tools.html')
            .then(res => res.text())
            .then(html => {
                // Crear contenedor temporal para poder querySelectorear
                const temp = document.createElement("div");
                temp.innerHTML = html;

                // Seleccionar las secciones del HTML externo
                const sectionA = temp.querySelector("#grafico-evolucion-Full");
                const sectionB = temp.querySelector("#analisis-automatico");

                // Insertarlas donde quer√©s
                document.getElementById("graficoIndicadorFull").appendChild(sectionA);
                document.getElementById("kpiTarjetasFull").appendChild(sectionB);

                // (Opcional) inicializar scripts, gr√°ficos, etc.
                if (typeof initGraficos === "function") initGraficos();
            });
    </script>

    <script src="/kpi-tools.js"></script>

</body>

</html>