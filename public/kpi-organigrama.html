<!DOCTYPE html>
<html lang="es">
<!--begin::Head-->

<head>
    <meta charset="UTF-8">
    <title>myResultIQ | Entidades</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="title" content="AdminLTE v4 | Dashboard" />
    <meta name="author" content="ColorlibHQ" />
    <meta name="description"
        content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
    <meta name="keywords"
        content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard" />
    <!--end::Primary Meta Tags-->

    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
        integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
    <!--end::Fonts-->

    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
        integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
    <!--end::Third Party Plugin(OverlayScrollbars)-->

    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
        integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
    <!--end::Third Party Plugin(Bootstrap Icons)-->

    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="../css/estilos-custom.css">
    <!--end::Required Plugin(AdminLTE)-->

    <!-- apexcharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
        integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

    <!-- jsvectormap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
        integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- AdminLTE se basa en Bootstrap, asÃ­ que hay que incluirlo primero:-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--  Bootstrap Icons (Para que <i class="bi bi-..."> funcione) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!--  AdminLTE CSS (Estilos del template)-->
    <link rel="stylesheet" href="../css/adminlte.css" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">

    <style>
        .brand-image {
            opacity: 1 !important;
            width: 40px;
            height: auto;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            object-fit: contain;
        }

        .app-main {
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .app-content-header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }

        .card-outline {
            border: 1px solid #dee2e6;
        }

        .badge-dimension {
            font-size: 0.75rem;
        }

        .table-responsive {
            border-radius: 0.375rem;
        }

        .btn-link-custom {
            color: #0d6efd;
            text-decoration: none;
            font-weight: 500;
        }

        .btn-link-custom:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        .criticidad-alta {
            color: #dc3545;
        }

        .criticidad-media {
            color: #fd7e14;
        }

        .criticidad-baja {
            color: #198754;
        }

        .tendencia-ascendente {
            color: #198754;
        }

        .tendencia-descendente {
            color: #dc3545;
        }

        .tendencia-estable {
            color: #6c757d;
        }
    </style>

</head>

<!-- <body class="hold-transition sidebar-mini"> -->

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <!--begin::Header-->
        <nav class="app-header navbar navbar-expand bg-body">
            <!--begin::Container-->
            <div class="container-fluid">
                <!--begin::Start Navbar Links-->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Home</a></li>
                    <!-- <li class="nav-item d-none d-md-block"><a href="#" class="nav-link">Contact</a></li> -->
                </ul>
                <!--end::Start Navbar Links-->

                <!--begin::End Navbar Links-->
                <ul class="navbar-nav ms-auto">
                    <!--begin::Navbar Search-->
                    <!-- <li class="nav-item">
                        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
                            <i class="bi bi-search"></i>
                        </a>
                    </li> -->
                    <!--end::Navbar Search-->

                    <!--begin::Messages Dropdown Menu-->
                    <li class="nav-item dropdown">
                        <a class="nav-link" data-bs-toggle="dropdown" href="#">
                            <i class="bi bi-chat-text"></i>
                            <span class="navbar-badge badge text-bg-danger">3</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <a href="#" class="dropdown-item">
                                <!--begin::Message-->
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <img src="dist/images/user1-128x128.jpg" alt="User Avatar"
                                            class="img-size-50 rounded-circle me-3" />
                                    </div>
                                    <div class="flex-grow-1">
                                        <h3 class="dropdown-item-title">
                                            Brad Diesel
                                            <span class="float-end fs-7 text-danger"><i
                                                    class="bi bi-star-fill"></i></span>
                                        </h3>
                                        <p class="fs-7">Call me whenever you can...</p>
                                        <p class="fs-7 text-secondary">
                                            <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                                        </p>
                                    </div>
                                </div>
                                <!--end::Message-->
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <!--begin::Message-->
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <img src="dist/images/user8-128x128.jpg" alt="User Avatar"
                                            class="img-size-50 rounded-circle me-3" />
                                    </div>
                                    <div class="flex-grow-1">
                                        <h3 class="dropdown-item-title">
                                            John Pierce
                                            <span class="float-end fs-7 text-secondary">
                                                <i class="bi bi-star-fill"></i>
                                            </span>
                                        </h3>
                                        <p class="fs-7">I got your message bro</p>
                                        <p class="fs-7 text-secondary">
                                            <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                                        </p>
                                    </div>
                                </div>
                                <!--end::Message-->
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <!--begin::Message-->
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <img src="dist/images/user3-128x128.jpg" alt="User Avatar"
                                            class="img-size-50 rounded-circle me-3" />
                                    </div>
                                    <div class="flex-grow-1">
                                        <h3 class="dropdown-item-title">
                                            Nora Silvester
                                            <span class="float-end fs-7 text-warning">
                                                <i class="bi bi-star-fill"></i>
                                            </span>
                                        </h3>
                                        <p class="fs-7">The subject goes here</p>
                                        <p class="fs-7 text-secondary">
                                            <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                                        </p>
                                    </div>
                                </div>
                                <!--end::Message-->
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item dropdown-footer">See All Messages</a>
                        </div>
                    </li>
                    <!--end::Messages Dropdown Menu-->
                    <!--begin::Notifications Dropdown Menu-->
                    <li class="nav-item dropdown">
                        <a class="nav-link" data-bs-toggle="dropdown" href="#">
                            <i class="bi bi-bell-fill"></i>
                            <span class="navbar-badge badge text-bg-warning">15</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <span class="dropdown-item dropdown-header">15 Notifications</span>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <i class="bi bi-envelope me-2"></i> 4 new messages
                                <span class="float-end text-secondary fs-7">3 mins</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <i class="bi bi-people-fill me-2"></i> 8 friend requests
                                <span class="float-end text-secondary fs-7">12 hours</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item">
                                <i class="bi bi-file-earmark-fill me-2"></i> 3 new reports
                                <span class="float-end text-secondary fs-7">2 days</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item dropdown-footer"> See All Notifications </a>
                        </div>
                    </li>
                    <!--end::Notifications Dropdown Menu-->

                    <!--begin::Fullscreen Toggle-->
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
                        </a>
                    </li>
                    <!--end::Fullscreen Toggle-->

                    <!--begin::User Menu Dropdown"-->
                    <li class="nav-item dropdown1 user-menu">

                        <span class="nav-link dropdown-toggle">
                            <span class="nav-link d-none d-md-inline">Bienvenido, <strong>Daniel GonzÃ¡lez
                                    (ADM)</strong></span>
                            <img src="/dist/images/user6-128x128.jpg" class="user-image rounded-circle shadow"
                                style="width: 40px; height: 40px;" alt="User Image" />
                        </span>
                    </li>
                    <li>
                        <!-- <a href="#" class="btn btn-default btn-flat float-end"> Salir</a> -->
                        <a href="#" class="nav-link " data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="fas fa-sign-out-alt me-1"></i> Salir
                        </a>
                    </li>
                    <!--end::User Menu Dropdown-->
                </ul>
                <!--end::End Navbar Links-->
            </div>
            <!--end::Container-->
        </nav>
        <!--end::Header-->

        <!--begin::Sidebar-->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="light">
            <!--begin::Sidebar Brand-->
            <div class="sidebar-brand">
                <!--begin::Brand Link-->
                <!-- <a href="./index.html" class="brand-link"> -->
                <!--begin::Brand Image-->
                <img src="dist/images/leon.png" alt="LeÃ³n blanco sÃ­mbolo de la aplicaciÃ³n" class="fade-in"
                    style="width: 40px; border-radius: 50%; margin-bottom: 0px;">
                <!--end::Brand Image-->
                <!--begin::Brand Text-->
                <span class="brand-text fw-light fs-5">myResultIQ 1</span>
                <!--end::Brand Text-->
                </a>
                <!--end::Brand Link-->
            </div>
            <!--end::Sidebar Brand-->

            <!--begin::Sidebar Wrapper-->
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <!--begin::Sidebar Menu-->
                    <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu"
                        data-accordion="false">
                        <li class="nav-header">
                            <h5>Menu Administrador</h5>
                        </li>

                        <li class="nav-item">
                            <a href="kpi-panel-admin.html" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>Panel Administrador</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="kpi-arbol.html" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p><i class="fas fa-sitemap text-primary"></i> Entidades-Indicadores</p>
                            </a>
                        </li>


                        <li class="nav-item">
                            <a href="kpi-ponderado.html" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>ValoraciÃ³n %</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="kpi-indicadores.html" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>Indicadores</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="kpi-usuarios.html" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>Usuarios</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="kpi-organigrama.html" class="nav-link active">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>Destinos</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon bi bi-circle text-danger"></i>
                                <p>----------------------</p>
                            </a>
                        </li>
                    </ul>
                    <!--end::Sidebar Menu-->
                </nav>
            </div>
            <!--end::Sidebar Wrapper-->

        </aside>
        <!--end::Sidebar-->

        <main class="app-main">
            <div class="app-content-header">
                <div class="container-fluid">
                    <!--begin::Row-->
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Destinos</h3>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-end">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Destino</li>
                            </ol>
                        </div>
                    </div>

                    <div class="mt-2 mb-2">En esta secciÃ³n se definen las entidades organizativas (Ã¡rea, proceso o
                        unidad funcional) a las que se les asignarÃ¡n indicadores.
                        <i class="bi bi-info-circle-fill text-primary ms-2" role="button" data-bs-toggle="modal"
                            data-bs-target="#infoModal"></i>
                    </div>
                    <!--end::Row-->

                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-image"></i> Imagen del Organigrama Institucional
                            </h3>
                        </div>
                        <!-- </div> -->

                        <div class="form-group ps-2 pe-2 mt-3 mb-3 ml-3">
                            <label for="orgImageInput" class="form-label">Seleccionar imagen del organigrama:</label>
                            <input type="file" class="form-control" id="orgImageInput" accept="image/*">
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button id="uploadButton" class="btn btn-primary ms-3">Subir imagen</button>
                            <button id="showImageButton" class="btn btn-success d-none">Mostrar</button>
                            <button id="hideImageButton" class="btn btn-secondary d-none">Ocultar</button>
                            <button id="deleteImageButton" class="btn btn-danger d-none">Eliminar</button>
                        </div>

                        <div id="imageContainer" class="text-center d-none">
                            <img id="organigramaImagen" class="img-fluid rounded shadow" alt="Organigrama">
                        </div>
                    </div>

                    <!-- SecciÃ³n 2: Formulario + Ãrbol -->
                    <div class="row">
                        <!-- Formulario -->
                        <div class="col-md-6 mt-3">
                            <div class="card card-info">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-plus-circle"></i> Agregar Entidad (Area -
                                        Unidad Funcional - Proceso)</h3>
                                </div>
                                <div class="card-body">

                                    <form id="sectorForm">
                                        <div class="form-group">
                                            <label for="sectorName">Nombre: </label>
                                            <input type="text" class="form-control" id="sectorName" required>
                                        </div>
                                        <div class="form-group mt-2">
                                            <label for="sectorParent">Dependiente de: (opcional):</label>
                                            <select class="form-control" id="sectorParent">
                                                <option value="">-- Ninguno --</option>
                                            </select>
                                        </div>

                                        <div class="col-md-3 mt-2 mb-3">
                                            <label for="sectorDescription" class="form-label">Tipo</label>
                                            <select id="sectorDescription" name="tipo" class="form-select">
                                                <option value="area">Area</option>
                                                <option value="unidad">Unidad Funcional</option>
                                                <option value="proceso">Proceso</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Agregar sector</button>
                                    </form>

                                </div>
                            </div>
                        </div>

                        <!-- Ãrbol -->
                        <div class="col-md-6 mt-3">
                            <div class="card card-success">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-sitemap"></i> Estructura de Entidades</h3>
                                </div>
                                <div class="card-body">
                                    <div id="treeView" class="tree"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal de ConfirmaciÃ³n de Logout -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">Â¿Desea Salir?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    Esta acciÃ³n cerrarÃ¡ tu sesiÃ³n actual y volverÃ¡s a la pÃ¡gina de inicio.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmLogout">Salir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de InformaciÃ³n para revisar ValoraciÃ³n % -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">Â¿Por quÃ© definir los Destinos  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                        La aplicaciÃ³n permite definir Ã¡reas, unidades funcionales y procesos en una estructura jerÃ¡rquica o de dependencia, donde cada nivel puede tener uno o varios indicadores asignados.<br><br>
                        Cada indicador mide un aspecto especÃ­fico y genera un resultado de cumplimiento respecto a su meta, pudiendo tener distinto nivel de relevancia segÃºn su participaciÃ³n en el objetivo del nivel al que pertenece.<br><br>

                        El resultado de cada nivel se calcula combinando los resultados de sus indicadores, y, asimismo,los subniveles se ponderan para obtener un valor global de desempeÃ±o en los niveles superiores.<br><br>

                        Al combinar los distintos niveles hacia los niveles superiores, se logra que, al llegar al nivel mÃ¡ximo definido, se obtenga un resultado general que refleje el estado global del Ã¡rea, unidad funcional o proceso correspondiente..<br>
                </div>
                <div class="modal-footer">
                    <!-- BotÃ³n a la izquierda con link -->
                    <a href="kpi-ponderado.html" class="btn btn-primary">
                        Ir a ValoraciÃ³n %
                    </a>

                    <!-- BotÃ³n de cerrar a la derecha -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('confirmLogout').addEventListener('click', function () {
            // Limpiar lo necesario
            sessionStorage.clear();
            localStorage.clear(); // si usÃ¡s localStorage

            // Redirigir al inicio
            window.location.href = 'index.html';
        });
    </script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

    <script>
        // === ConfiguraciÃ³n ===
        const API_URL = '/api/sectores';
        const IMG_URL = '/api/organigrama';

        // === Esperar DOM ===
        document.addEventListener("DOMContentLoaded", async () => {
            inicializarBotonesImagen();
            await verificarImagen();
            cargarSectores();
            manejarEnvioFormulario();
        });

        // === GestiÃ³n de Imagen ===
        function inicializarBotonesImagen() {
            const showBtn = document.getElementById("showImageButton");
            const hideBtn = document.getElementById("hideImageButton");
            const deleteBtn = document.getElementById("deleteImageButton");
            const uploadBtn = document.getElementById("uploadButton");
            const fileInput = document.getElementById("orgImageInput");
            const imageContainer = document.getElementById("imageContainer");
            const organigramaImg = document.getElementById("organigramaImagen");

            showBtn.addEventListener("click", async () => {
                const res = await fetch(`${IMG_URL}/imagen`);
                const blob = await res.blob();
                organigramaImg.src = URL.createObjectURL(blob);
                imageContainer.classList.remove("d-none");
                showBtn.classList.add("d-none");
                hideBtn.classList.remove("d-none");
            });

            hideBtn.addEventListener("click", () => {
                imageContainer.classList.add("d-none");
                showBtn.classList.remove("d-none");
                hideBtn.classList.add("d-none");
            });

            uploadBtn.addEventListener("click", async () => {
                if (!fileInput.files.length) return alert("Selecciona una imagen primero.");
                const formData = new FormData();
                formData.append("imagen", fileInput.files[0]);

                const res = await fetch(IMG_URL, { method: "POST", body: formData });
                if (res.ok) {
                    alert("Imagen subida correctamente.");
                    fileInput.value = "";
                    await verificarImagen();
                    imageContainer.classList.add("d-none");
                    hideBtn.classList.add("d-none");
                } else {
                    alert("Error al subir imagen.");
                }
            });

            deleteBtn.addEventListener("click", async () => {
                if (!confirm("Â¿Seguro que deseas eliminar la imagen?")) return;
                const res = await fetch(IMG_URL, { method: "DELETE" });
                if (res.ok) {
                    alert("Imagen eliminada correctamente.");
                    imageContainer.classList.add("d-none");
                    showBtn.classList.add("d-none");
                    hideBtn.classList.add("d-none");
                    deleteBtn.classList.add("d-none");
                } else {
                    alert("Error al eliminar imagen.");
                }
            });
        }

        async function verificarImagen() {
            const showBtn = document.getElementById("showImageButton");
            const deleteBtn = document.getElementById("deleteImageButton");
            try {
                const res = await fetch(`${IMG_URL}/imagen`);
                const visible = res.ok;
                showBtn.classList.toggle("d-none", !visible);
                deleteBtn.classList.toggle("d-none", !visible);
            } catch (err) {
                console.error("Error al verificar imagen:", err);
            }
        }

        // === GestiÃ³n de Formulario ===
        function manejarEnvioFormulario() {
            $('#sectorForm').on('submit', async function (event) {
                event.preventDefault();
                const nombre = $('#sectorName').val();
                const tipo = $('#sectorDescription').val();
                const sector_padre_id = $('#sectorParent').val() || null;

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nombre, tipo, sector_padre_id }),
                    });
                    await cargarSectores();
                    this.reset();
                } catch (err) {
                    console.error('Error al agregar sector:', err);
                }
                actualizarAlerta(1)
            });
        }

                // ð²ð²ð² Actualizar alertas
        function actualizarAlerta(tieneError) {
            (async () => {
                try {
                    await fetch(`/api/alertas/1/valor`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ valor: tieneError })
                    });
                } catch (err) {
                    console.error('Error actualizando alertas.valor', err);
                }
            })();
        }


        // === GestiÃ³n de Sectores ===
        async function cargarSectores() {
            try {
                const response = await fetch(API_URL);
                const sectores = await response.json();
                actualizarOpcionesPadre(sectores);
                renderizarArbol(sectores);
            } catch (err) {
                console.error('Error al cargar sectores:', err);
            }
        }

        function actualizarOpcionesPadre(sectores) {
            const $select = $('#sectorParent');
            $select.html('<option value="">-- Ninguno --</option>');
            sectores.forEach(({ id, nombre }) => {
                $select.append(`<option value="${id}">${nombre}</option>`);
            });
        }

        function renderizarArbol(sectores) {
            $('#treeView').html(construirArbol(sectores));
        }

        function construirArbol(sectores, padreId = null) {
            const hijos = sectores.filter(s => padreId === null
                ? s.sector_padre_id === null || s.sector_padre_id === 0
                : s.sector_padre_id == padreId);

            if (!hijos.length) return '';

            const items = hijos.map(s => `
                    <li>
                    <small>${s.tipo || ''}</small>
                    <strong>${s.nombre}</strong>
                        <button class="btn btn-sm btn-outline-danger p-1" onclick="eliminarSector(${s.id})" title="Eliminar sector">
                        <i class="fas fa-trash-alt" style="font-size: 12px;"></i>
                        </button>
                    ${construirArbol(sectores, s.id)}
                    </li>
                `).join('');

            return `<ul class="ml-3">${items}</ul>`;
        }

        async function eliminarSector(id) {
            if (!confirm('Â¿EstÃ¡s seguro de que querÃ©s eliminar este sector?')) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Error en la eliminaciÃ³n');
                await cargarSectores();
            } catch (err) {
                console.error('Error al eliminar sector:', err);
                alert('No se pudo eliminar el sector.');
            }
            actualizarAlerta(1);
        }
    </script>

    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
        integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
    <!--end::Third Party Plugin(OverlayScrollbars)-->

    <!-- Bootstrap (bundle con Popper incluido) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- <script src="../../dist/js/adminlte.js"></script> -->
    <script src="../js/adminlte.js"></script>
    <!--end::Required Plugin(AdminLTE)-->

    <!-- OverlayScrollbars (opcional) -->
    <script
        src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"></script>
</body>

</html>