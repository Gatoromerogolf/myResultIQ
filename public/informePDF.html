<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla Informe - myResultIQ</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --azul: #1F78FF;
      --gris: #333333;
      --gris-claro: #F2F2F2;
      --espacio: 16px;
      --page-width-mm: 210mm;
      /* A4 */
    }

    /* Reset b√°sico */
    * {
      box-sizing: border-box
    }

    body {
      font-family: 'Roboto', system-ui, sans-serif;
      color: var(--gris);
      margin: 0;
      background: #efefef;
    }

    /* Contenedor que simula el documento */
    .doc-wrap {
      max-width: 900px;
      margin: 24px auto;
      padding: 24px
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer
    }

    /* Estilos de p√°gina (cada .page ser√° una hoja A4 cuando se exporte a PDF) */
    .page {
      width: 210mm;
      height: 297mm;
      /* Fijar exactamente una A4 */
      background: white;
      margin: 0;
      position: relative;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      /* evita cortes extra */
    }

    /* MARCO INTERNO */
    .marco {
      border: 2px solid #007BFF;
      border-radius: 5mm;
      padding: 12mm;
      margin: 20mm 12mm 20mm 12mm;
      /* margen interno superior / inferior */
      height: calc(297mm - 40mm);
      /* altura real √∫til */
      box-sizing: border-box;
    }

    /* Contenido */
    .content {
      overflow: hidden;
      /* evita ‚Äúspill‚Äù */
    }

    .marco,
    .content,
    table,
    h2,
    p {
      page-break-inside: avoid;
    }

    /* Header / Footer */
    .header {
      position: absolute;
      top: 5mm;
      left: 10mm;
      right: 10mm;
      text-align: center;
    }

    .footer {
      position: absolute;
      bottom: 5mm;
      left: 10mm;
      right: 10mm;
      text-align: center;
    }

    /* === PORTADA PREMIUM === */
    .cover-page {
      padding: 0 !important;
      position: relative;
      overflow: hidden;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      color: white;
      font-family: 'Montserrat', sans-serif;
    }

    /* Overlay degradado premium */
    .cover-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
          rgba(0, 0, 0, 0.65) 0%,
          rgba(0, 0, 0, 0.30) 40%,
          rgba(0, 0, 0, 0.55) 100%);
      z-index: 1;
    }

    /* Contenedor central */
    .cover-content {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40mm 25mm 30mm 25mm;
      text-align: center;
    }

    /* Logo */
    .cover-logocomun {
      width: 25mm;
      opacity: 0.95;
      margin-bottom: 20mm;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .cover-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30mm;
      /* si quer√©s ajustarlo */
      opacity: 0.95;
    }

    /* T√≠tulos */
    .cover-title {
      font-size: 34pt;
      font-weight: 700;
      margin-bottom: 10mm;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.55);
    }

    .cover-subtitle {
      font-size: 20pt;
      font-weight: 500;
      margin-bottom: 3mm;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.45);
    }

    /* RESUMEN EJECUTIVO */
    .cover-resumen {
      margin-top: 18mm;
      font-size: 14pt;
      font-weight: 300;
      line-height: 1.55;
      text-align: justify;
      padding: 0 5mm;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Pie */
    .cover-bottom {
      position: absolute;
      bottom: 12mm;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 12pt;
      opacity: 0.85;
      z-index: 3;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.55);
    }



    .cover2-page {
      padding: 0 !important;
      position: relative;
      overflow: hidden;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      color: rgb(65, 138, 247);
      font-family: 'Montserrat', sans-serif;
    }

    /* Overlay degradado premium */
    .cover2-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
          rgba(0, 0, 0, 0.65) 0%,
          rgba(0, 0, 0, 0.30) 40%,
          rgba(0, 0, 0, 0.55) 100%);
      z-index: 1;
    }

    /* Contenedor central */
    .cover2-content {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40mm 25mm 30mm 25mm;
      text-align: center;
    }

    /* Logo */
    .cover2-logocomun {
      width: 25mm;
      opacity: 0.95;
      margin-bottom: 20mm;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .cover2-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30mm;
      /* si quer√©s ajustarlo */
      opacity: 0.95;
    }

    /* T√≠tulos */
    .cover2-empresa {
      font-size: 35pt;
      font-weight: 500;
      color: #333333;
      position: absolute;
      top: 80mm;
      /* distancia desde arriba */
      left: 0;
      right: 0;
      text-align: center;
    }

    /* T√≠tulos */
    .cover2-infoeje {
      font-size: 24pt;
      font-weight: 500;
      position: absolute;
      top: 110mm;
      /* distancia desde arriba */
      left: 0;
      right: 0;
      text-align: center;
    }

    .cover2-indiGes {
      font-size: 40pt;
      font-weight: 600;
      color: #333333;
      position: absolute;
      top: 130mm;
      left: 0;
      right: 0;
      text-align: center;
    }

    .cover2-seguimiento {
      font-size: 20pt;
      font-weight: 500;
      position: absolute;
      top: 160mm;
      width: 80%;
      /* left: 20px;
      right: 20px; */
      text-align: center;
    }

    .cover2-intro {
      font-size: 14pt;
      font-weight: 400;
      /* position: absolute;
      top: 90mm;
      left: 40mm;
      right: 40mm; */
      text-align: justify;
    }

    .cover2-subtitle2 {
      font-size: 14pt;
      font-weight: 400;
      position: absolute;
      top: 90mm;
      left: 40mm;
      right: 40mm;
      text-align: justify;
    }

    .cover2-piemyResult {
      font-size: 11pt;
      font-weight: 400;
      position: absolute;
      top: 220mm;
      left: 30mm;
      right: 30mm;
      margin-top: 10mm;
      text-align: center;
    }


    /* RESUMEN EJECUTIVO */
    .cover2-resumen {
      margin-top: 18mm;
      font-size: 14pt;
      font-weight: 300;
      line-height: 1.55;
      text-align: justify;
      padding: 0 5mm;
      position: absolute;
      top: 170mm;
      /* text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); */
    }

    /* Pie */
    .cover2-bottom {
      position: absolute;
      bottom: 12mm;
      left: 40px;
      width: 100%;
      text-align: center;
      font-size: 12pt;
      opacity: 0.85;
      z-index: 3;
      /* text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.55); */
    }

    .logo-image {
      width: 20mm;
      margin-top: 5mm;
      opacity: 0.9;
    }

    h2.section-title {
      font-family: 'Montserrat';
      font-size: 18px;
      margin: 6px 0 12px 0;
      color: var(--azul)
    }

    /* Contenedor de las m√©tricas: 4 columnas fijas */
    .metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      width: 100%;
    }

    /* Tarjetas */
    .metric {
      background: #fff;
      border: 5px solid #eee;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      /* apila label arriba y valor abajo */
      align-items: center;
      /* centra horizontalmente */
    }

    .metric .label {
      font-size: 12px;
      color: #666;
    }

    .metric .value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 6px;
    }

    .tabla-indicadores {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 12px;
    }

    .tabla-indicadores th,
    .tabla-indicadores td {
      border: 1px solid #999;
      padding: 6px;
    }

    .tabla-indicadores th {
      background: #f0f0f0;
    }

    .fila-total td {
      background: #fafafa;
      font-size: 13px;
    }


    /* üì± RESPONSIVE: en pantallas peque√±as pasa a 2x2 */
    @media (max-width: 768px) {
      .metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* üì± Extra chico: 1 por l√≠nea */
    @media (max-width: 450px) {
      .metrics {
        grid-template-columns: 1fr;
      }
    }

    /* Tabla simple */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #eee;
      text-align: left;
      font-size: 13px
    }

    th {
      background: var(--gris-claro);
      font-weight: 600
    }

    /* Page break helper */
    .page-break {
      page-break-after: always;
    }

    /* TOC */
    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0
    }

    .toc-list li {
      padding: 6px 0;
      border-bottom: 1px dashed #eee
    }

    .separator {
      width: 65%;
      height: 3px;
      background: #444;
      border-radius: 3px;
      margin: 0 auto 35px auto;
      position: absolute;
      top: 100mm;
    }


    /* Responsive preview scaling */
    @media (max-width:980px) {
      .doc-wrap {
        padding: 10px
      }

      .page {
        width: 100%;
        min-height: 1200px
      }
    }
  </style>
</head>

<body>

  <div class="doc-wrap">
    <div class="toolbar">
      <!-- <button id="btn-build">Generar documento</button> -->
      <button id="btn-pdf">Exportar a PDF</button>
      <!-- <button id="btn-preview">Vista previa en nueva ventana</button> -->
      <!-- <label style="margin-left:12px;font-size:13px;color:#555">Plantilla base</label> -->
    </div>

    <!-- Contenedor donde el script crear√° las p√°ginas -->
    <div id="documento"></div>
  </div>

  <!-- Spinner / Modal flotante -->
  <div id="spinnerOverlay" style="
                display:none;
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 2000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                color: white;
                font-size: 1.2rem;
                ">
    <div class="spinner-border text-light mb-3" role="status">
      <span class="visually-hidden">Generando PDF...</span>
    </div>
    <span id="spinnerText">Generando informe PDF, por favor espere...</span>
  </div>

  <!-- Dependencia para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    // Datos de ejemplo (luego los reemplaz√°s por tus datos reales)
    empresa = "ORGANIZACION";
    const ejemplo = {
      titulo: 'Informe de Indicadores',
      subtitulo: 'Gesti√≥n, seguimiento y an√°lisis de m√©tricas organizacionales',
      fecha: new Date().toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' }),
      autor: '√Årea de Gesti√≥n de Indicadores',
      resumen: {
        cumplimientoGlobal: '82%',
        promedioHistorico: '78.4',
        deltaMes: '+3.2%'
      },

      sectores: [
        {
          id: 1, nombre: 'Comercial', indicadores: [
            { id: 11, nombre: 'Ventas mensuales', meta: '100k', valor: '92k', estado: 'amarillo' },
            { id: 12, nombre: 'Tasa de conversi√≥n', meta: '2.5%', valor: '3.1%', estado: 'verde' }
          ]
        },
        {
          id: 2, nombre: 'Operaciones', indicadores: [
            { id: 21, nombre: 'Tiempo de respuesta', meta: '<24h', valor: '18h', estado: 'verde' },
            { id: 22, nombre: 'Incidentes cr√≠ticos', meta: '0', valor: '1', estado: 'rojo' }
          ]
        }
      ]
    };

    // --- Construcci√≥n del documento (DOM) ---
    const documento = document.getElementById('documento');

    function clearDocument() { documento.innerHTML = ''; }

    function createPage() {
      const page = document.createElement('section');
      page.className = 'page';

      // Header (fuera del marco)
      const header = document.createElement('div');
      header.className = 'header';
      header.innerHTML = `<div>${ejemplo.titulo}</div><div>${ejemplo.fecha}</div>`;
      page.appendChild(header);

      // Marco interno
      const marco = document.createElement('div');
      marco.className = 'marco';
      page.appendChild(marco);

      // Contenido dentro del marco
      const content = document.createElement('div');
      content.className = 'content';
      marco.appendChild(content);

      // Footer (fuera del marco)
      const footer = document.createElement('div');
      footer.className = 'footer';
      footer.innerHTML = `
    <div>Generado por: ${ejemplo.autor}</div>
    <div class="page-number">P√°gina</div>
  `;
      page.appendChild(footer);

      return { page, content };
    }

    //üòéüòéüòé buildCover
    function buildCover() {
      const page = document.createElement('section');
      page.className = 'page cover-page';

      // === Fondo de barras diagonales modernas ===
      page.style.background = `
          repeating-linear-gradient(
            -45deg,
            #0a2850 0,
            #0a2850 12mm,
            #123d80 12mm,
            #123d80 24mm
          )
      `;
      page.style.backgroundSize = "cover";

      // Overlay premium
      const overlay = document.createElement('div');
      overlay.className = 'cover-overlay';
      page.appendChild(overlay);

      // Contenido central
      const content = document.createElement('div');
      content.className = 'cover-content';

      // Logo
      const logo = document.createElement('img');
      logo.className = 'cover-logo';
      logo.src = "../dist/images/leon.png";
      // content.appendChild(logo);
      page.appendChild(logo);  // ‚¨ÖÔ∏è importante: no va dentro de cover-content

      // T√≠tulo principal
      const title = document.createElement('div');
      title.className = 'cover-title';
      title.textContent = ejemplo.titulo;
      content.appendChild(title);

      // Subt√≠tulo
      const subtitle = document.createElement('div');
      subtitle.className = 'cover-subtitle';
      subtitle.textContent = ejemplo.subtitulo;
      content.appendChild(subtitle);

      // Resumen ejecutivo
      const resumen = document.createElement('div');
      resumen.className = 'cover-resumen';
      resumen.textContent =
        "Este informe resume los principales indicadores estrat√©gicos, " +
        "identifica variaciones cr√≠ticas y presenta una visi√≥n anal√≠tica " +
        "general del desempe√±o institucional durante el per√≠odo evaluado. <br>" +
        "<br><br>" +
        "Los datos presentados han sido procesados con la plataforma <strong>myResultIQ</strong>, asegurando precisi√≥n y trazabilidad en cada etapa del an√°lisis.";
      content.appendChild(resumen);

      page.appendChild(content);

      // Pie inferior
      const bottom = document.createElement('div');
      bottom.className = 'cover-bottom';
      bottom.textContent = `Generado el ${ejemplo.fecha}`;
      page.appendChild(bottom);

      documento.appendChild(page);
    }


    //üòéüòéüòé buildCover2
    function buildCover2() {
      const page = document.createElement('section');
      page.className = 'page cover2-page';

      // === Fondo completo ===
      // page.style.backgroundImage = 'url("../dist/images/Fondomy.png")';
      page.style.backgroundImage = 'url("../dist/images/PortadaAzulBlanca.png")';

      // Contenedor central
      const content = document.createElement('div');
      content.className = 'cover2-content';

      // Empresa
      const subtitle = document.createElement('div');
      subtitle.className = 'cover2-empresa';
      subtitle.textContent = "ORGANIZACION";
      content.appendChild(subtitle);

      //Informe Ejecutivo
      const infoEje = document.createElement('div');
      infoEje.className = 'cover2-infoeje';
      infoEje.textContent = "Informe Ejecutivo";
      content.appendChild(infoEje);

      //Indicadores de Gesti√≥n
      const indiGes = document.createElement('div');
      indiGes.className = 'cover2-indiGes';
      indiGes.textContent = "Indicadores de Gesti√≥n";
      content.appendChild(indiGes);


      // T√≠tulo
      const title = document.createElement('div');
      title.className = 'cover2-seguimiento';
      title.textContent = "Seguimiento y an√°lisis de m√©tricas organizacionales.";
      content.appendChild(title);


      // Pie inferior
      const bottom = document.createElement('div');
      bottom.className = 'cover2-bottom';
      bottom.textContent = `${ejemplo.fecha}`;
      content.appendChild(bottom);

      page.appendChild(content);

      documento.appendChild(page);
    }

    //üòéüòéüòé buildIntrooverview
    function buildIntrooverview() {
      const { page, content } = createPage();
      const h = document.createElement('h1');
      h.className = 'section-title';
      h.textContent = 'Marco Introductorio y Visi√≥n General';
      content.appendChild(h);

      const p = document.createElement('p');
      p.className = 'cover2-intro';
      p.innerHTML = `
          <h4>Introducci√≥n y Visi√≥n General</h4>

          <p>El presente informe tiene por finalidad ofrecer una visi√≥n integral y consolidada del desempe√±o organizacional mediante el an√°lisis de los indicadores clave de gesti√≥n (KPIs). Se presenta una s√≠ntesis estructurada de la informaci√≥n disponible en el dashboard interactivo, con el prop√≥sito de facilitar la toma de decisiones estrat√©gicas basadas en datos cuantitativos y cualitativos correspondientes al per√≠odo evaluado.</p>

          <h4>Destinatarios</h4>
          Este documento est√° dirigido a la Alta Direcci√≥n, gerencias de √°rea y dem√°s actores estrat√©gicos que requieren informaci√≥n precisa, actualizada y confiable para evaluar el desempe√±o institucional, monitorear avances y orientar la planificaci√≥n estrat√©gica..

          <h4>Prop√≥sito y Alcance</h4>

          <p>El informe resume los principales indicadores estrat√©gicos, analiza su evoluci√≥n, identifica desviaciones relevantes y eval√∫a el nivel de cumplimiento respecto de los objetivos establecidos. Adem√°s, integra tendencias, comparaciones interper√≠odos y observaciones contextuales que permiten interpretar el comportamiento de los indicadores.<br><br>El objetivo central es transformar los datos en insights accionables que apoyen la gesti√≥n, la toma de decisiones y el mejoramiento continuo de los procesos institucionales.</p>

          <h4>Calidad y Precisi√≥n de los Datos</h4>
          <p>La validez de los resultados presentados depende directamente de la calidad de los datos utilizados. Por ello, se destaca la importancia de los procesos de verificaci√≥n, consistencia y validaci√≥n aplicados durante cada etapa de recolecci√≥n, procesamiento y consolidaci√≥n.`

      content.appendChild(p);
      documento.appendChild(page);


      // Crear segunda hoja
      const { page: page1, content: content1 } = createPage();

      // Primer bloque
      const p1 = document.createElement('div');
      p1.className = 'cover2-intro';
      p1.innerHTML = `
            <p>Estos mecanismos aseguran la trazabilidad, la transparencia anal√≠tica y la confiabilidad del sistema de medici√≥n, permitiendo construir conclusiones s√≥lidas y comparables en el tiempo.</p>

            <h4> Evoluci√≥n y Mejora Continua</h4>

            <p>El sistema de indicadores que sustenta este informe es din√°mico y evolutivo. La incorporaci√≥n progresiva de nuevos KPIs, as√≠ como la actualizaci√≥n y el refinamiento de los existentes, permitir√° avanzar hacia un monitoreo m√°s detallado y granular del desempe√±o institucional.<br><br>Esta ampliaci√≥n gradual responde al nivel de madurez de los procesos internos y a las necesidades estrat√©gicas detectadas, contribuyendo a una comprensi√≥n cada vez m√°s precisa de los factores que influyen en los resultados organizacionales.</p>

            <h4> Estructura del Informe</h4>

            <p>El documento se organiza en secciones tem√°ticas que agrupan indicadores relacionados. Para cada uno se presentan:<br>
              <ul>
                <li>Valores actuales</li>
                <li>Tendencias hist√≥ricas</li>
                <li>Comparaciones con per√≠odos anteriores</li>
                <li>An√°lisis de brechas respecto de metas establecidas</li>
                <li>Observaciones cualitativas y factores contextuales relevantes</li>
              </ul>

            Esta estructura favorece tanto una lectura integral del desempe√±o global como la consulta segmentada por √°rea o l√≠nea estrat√©gica, seg√∫n las necesidades del usuario.</p>`;

      content1.appendChild(p1);

      const piemyResult = document.createElement('div');
      piemyResult.className = 'cover2-piemyResult';
      piemyResult.innerHTML = `
            Los datos de este informe han sido procesados con la plataforma <strong> myResultIQ</strong>,
            asegurando precisi√≥n y trazabilidad en cada etapa del an√°lisis.
            <br>
              <img src="/dist/images/leon.png" class="logo-image" alt="Logo">
                `;
      page1.appendChild(piemyResult);

      documento.appendChild(page1);
    }


    //üòéüòéüòé buildTOC
    function buildTOC() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = '√çndice';
      content.appendChild(h);

      const ul = document.createElement('ul'); ul.className = 'toc-list';
      // Generamos entradas acordes a las secciones previstas
      const entradas = ['Resumen Ejecutivo', 'Indicadores Globales', 'Indicadores por Sector', 'An√°lisis de Cumplimientos', 'Anexos'];
      entradas.forEach((e, i) => {
        const li = document.createElement('li'); li.textContent = `${i + 1}. ${e}`;
        ul.appendChild(li);
      });

      content.appendChild(ul);

      documento.appendChild(page);
    }


    //üòéüòéüòé buildResumen
    async function buildResumen() {
      const { page, content } = createPage();
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Resumen Ejecutivo';
      content.appendChild(h);

      // -----------------------
      // Texto descriptivo
      // -----------------------
      const p = document.createElement('p');

      const cantSectores = localStorage.getItem('cantSectores');
      const cantActivos = localStorage.getItem('cantIndicadoresActivos');
      const cantDestinos = localStorage.getItem('destinosMedidos');
      const cantMediciones = localStorage.getItem('totalMediciones');
      const cantAlDia = Number(localStorage.getItem('cantOk'));
      const cantDemorados = Number(localStorage.getItem('cantDemorados'));
      const cantPendientes = Number(localStorage.getItem('cantnoInformados'));
      const fechaISODesde = localStorage.getItem('fechaDesde');
      const fechaISOHasta = localStorage.getItem('fechaHasta');

      // ‚úîÔ∏è Objetos Date (para c√°lculos)
      const fechaDesdeDate = new Date(fechaISODesde);
      const fechaHastaDate = new Date(fechaISOHasta);

      // ‚úîÔ∏è Strings SOLO para mostrar
      const fechaDesdeTexto = fechaDesdeDate.toLocaleDateString(
        'es-AR',
        { year: 'numeric', month: 'long', day: 'numeric' }
      );

      const fechaHastaTexto = fechaHastaDate.toLocaleDateString(
        'es-AR',
        { year: 'numeric', month: 'long', day: 'numeric' }
      );


      function cantidadMesesEntreFechas(desde, hasta) {
        if (hasta < desde) return 0;

        const yearDiff = hasta.getFullYear() - desde.getFullYear();
        const monthDiff = hasta.getMonth() - desde.getMonth();

        return yearDiff * 12 + monthDiff + 1;
      }

      const totalMeses = cantidadMesesEntreFechas(fechaDesdeDate, fechaHastaDate);

      let texto =
        `Se han declarado un total de <strong> ${cantSectores}</strong> destinos, de los cuales <strong> ${cantDestinos}</strong> tienen indicadores asignados.<br><br>` +
        `Cada destino posee un peso que representa su importancia estrat√©gica dentro de la organizaci√≥n, definido en funci√≥n del rol que cumple en la cadena de valor. Estos destinos pueden contar, o no, con indicadores propios asignados.<br><br>` +
        `Se han definido un total de <strong>${cantActivos}</strong> indicadores activos.<br><br>` +
        `Los indicadores est√°n asociados a destinos espec√≠ficos, los cuales a su vez pueden depender jer√°rquicamente de otros. El c√°lculo del cumplimiento global se realiza de manera ascendente: primero se determina el cumplimiento de cada indicador, luego el del destino correspondiente y, finalmente, se consolida el resultado hacia los niveles superiores.<br><br>De esta forma, el cumplimiento global expresa el desempe√±o integral de la organizaci√≥n, ponderado seg√∫n la relevancia de cada destino dentro de la estructura.<br><br>` +
        `Este informe Ejecutivo resume las conclusiones de las mediciones registradas en el per√≠odo comenzado el <strong>${fechaDesdeTexto}</strong> y finalizado el <strong>${fechaHastaTexto}</strong>.<br><br>` +
        `Durante este per√≠odo se han realizado y registrado un total de <strong>${cantMediciones}</strong> mediciones.<br><br>`;

      if (cantDemorados === 0 && cantPendientes === 0) {
        texto += `Todos los indicadores fueron medidos con la frecuencia establecida y no hay mediciones pendientes para el per√≠odo definido en este informe.<br><br>`;
      } else {
        const cantAlDia = cantActivos - (cantDemorados + cantPendientes);
        texto += `Solo <strong>${cantAlDia}</strong> indicadores tienen todas sus mediciones informadas en fecha, ` +
          `mientras que <strong>${cantActivos - cantAlDia}</strong> presentan mediciones pendientes o fuera de t√©rmino.<br><br>` +
          `Debido a la ausencia de informaci√≥n completa, los resultados y conclusiones de este informe podr√≠an presentar ` +
          `variaciones respecto de la situaci√≥n real. La falta de mediciones vigentes puede generar desviaciones en los ` +
          `promedios, tendencias y porcentajes de cumplimiento, por lo que las interpretaciones deben realizarse con ` +
          `precauci√≥n.<br><br>`;
      }

      p.innerHTML = texto;
      content.appendChild(p);

      const metrics = document.createElement('div');
      metrics.className = 'metrics';

      const m1 = document.createElement('div');
      m1.className = 'metric';
      m1.innerHTML = `<div class="label">Destinos totales</div><div class="value"> ${cantSectores}</div>`;

      const m2 = document.createElement('div');
      m2.className = 'metric';
      m2.innerHTML = `<div class="label">Dest.c/Indicadores</div><div class="value">${cantDestinos}</div>`;

      const m3 = document.createElement('div');
      m3.className = 'metric';
      m3.innerHTML = `<div class="label">Total Indicadores</div><div class="value">${cantActivos}</div>`;

      const m4 = document.createElement('div');
      m4.className = 'metric';
      m4.innerHTML = `<div class="label">Total Mediciones</div><div class="value">${cantMediciones}</div>`;

      const m5 = document.createElement('div');
      m5.className = 'metric';
      m5.innerHTML = `<div class="label">Meses medidos</div><div class="value">${totalMeses}</div>`;

      metrics.appendChild(m1);
      metrics.appendChild(m2);
      metrics.appendChild(m3);
      metrics.appendChild(m4);
      metrics.appendChild(m5);
      content.appendChild(metrics);

      documento.appendChild(page);
    }


    //üòéüòéüòé svgToPng
    function svgToPng(svgElement, width = 300, height = 300) {
      return new Promise(resolve => {
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          URL.revokeObjectURL(url);
          resolve(canvas.toDataURL("image/png"));
        };

        img.src = url;
      });
    }


    //üòéüòéüòé buildIndicadoresGlobales
    function buildIndicadoresGlobales() {
      const { page, content } = createPage();

      // --- T√çTULO DE SECCI√ìN ---
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Indicadores Globales';
      content.appendChild(h);


      // =======================
      // Texto introductorio
      // =======================
      const p = document.createElement('p');
      p.innerHTML = `
      El siguiente gr√°fico muestra el porcentaje de cumplimiento global organizacional correspondiente al √∫ltimo per√≠odo evaluado, resultante de ponderar
      cada indicador por su peso relativo dentro de la estructura total y por su nivel de logro
      respecto al objetivo definido.<br><br>
      `;
      content.appendChild(p);

      // =======================
      // Datos globales
      // =======================
      const valGlobales = localStorage.getItem('resumenGlobal');
      const resumenGlobal = JSON.parse(valGlobales);

      // =======================
      // Contenedor principal
      // =======================
      const bloqueResumen = document.createElement('div');
      bloqueResumen.style.display = 'flex';
      bloqueResumen.style.alignItems = 'center';
      bloqueResumen.style.gap = '28px';
      bloqueResumen.style.marginTop = '20px';

      // =======================
      // Gr√°fico (izquierda)
      // =======================
      const graf = document.createElement('div');
      graf.style.width = '200px';
      graf.style.height = '200px';
      graf.style.display = 'flex';
      graf.style.alignItems = 'center';
      graf.style.justifyContent = 'center';

      // PNG del ring
      const pngBase64 = localStorage.getItem("ringGlobalPNG");

      if (pngBase64) {
        graf.innerHTML = `
              <div style="
                  width:180px;
                  height:180px;
                  border-radius:50%;
                  background:#fff;
                  box-shadow:0 4px 12px rgba(0,0,0,0.1);
                  display:flex;
                  align-items:center;
                  justify-content:center;
              ">
                  <img src="${pngBase64}" style="width:140px; height:140px; border-radius:50%;">
              </div>
              `;
      } else {
        graf.innerHTML = `
              <div style="
                  width:180px;
                  height:180px;
                  border-radius:50%;
                  border:1px dashed #ddd;
                  display:flex;
                  align-items:center;
                  justify-content:center;
                  color:#999;
              ">
                  [Gr√°fico no disponible]
              </div>
              `;
      }

      // =======================
      // M√©tricas (derecha)
      // =======================
      const metrics = document.createElement('div');
      metrics.style.display = 'grid';
      metrics.style.gridTemplateColumns = '1fr 1fr';
      metrics.style.gridTemplateRows = '1fr 1fr';
      metrics.style.gap = '14px';
      metrics.style.height = '200px'; // igual al gr√°fico
      metrics.style.flex = '1';

      // =======================
      // Helper para fichas
      // =======================
      function crearMetric(label, valueHTML) {
        const m = document.createElement('div');
        m.className = 'metric';
        m.style.display = 'flex';
        m.style.flexDirection = 'column';
        m.style.justifyContent = 'center';
        m.style.padding = '12px 14px';
        m.style.borderRadius = '10px';
        m.style.background = '#fff';
        m.style.boxShadow = '0 2px 6px rgba(0,0,0,0.06)';

        m.innerHTML = `
        <div class="label" style="font-size:0.8em; color:#666; margin-bottom:4px;">
            ${label}
        </div>
        <div class="value" style="font-size:1.2em; font-weight:600;">
            ${valueHTML}
        </div>
    `;
        return m;
      }

      // =======================
      // M√©trica 1
      // =======================
      const m1 = crearMetric(
        'Promedio Anual',
        resumenGlobal.promAnual
      );

      // =======================
      // M√©trica 2
      // =======================
      const m2 = crearMetric(
        'Prom. Hist√≥rico',
        resumenGlobal.promHistorico
      );

      // =======================
      // M√©trica 3 (variaci√≥n)
      // =======================
      let valor = Number(resumenGlobal.variacion) || 0;
      let color = 'gray';
      let textoValor = '0';

      if (valor > 0) { textoValor = `+${valor}`; color = '#007bff'; }
      else if (valor < 0) { textoValor = `${valor}`; color = '#d9534f'; }

      const m3 = crearMetric(
        'Œî vs mes anterior',
        `<span style="color:${color}; font-weight:700;">${textoValor}</span>`
      );

      // =======================
      // M√©trica 4 (tendencia)
      // =======================
      let tendencia = resumenGlobal.tendencia || '';
      let icono = '‚ûñ';
      let colorTendencia = '#555';

      if (tendencia === 'Creciente%') { icono = 'üîº'; colorTendencia = '#007bff'; }
      else if (tendencia === 'Decreciente%') { icono = 'üîΩ'; colorTendencia = '#d9534f'; }

      const textoTendencia =
        tendencia ? tendencia.charAt(0).toUpperCase() + tendencia.slice(1) : 'Sin datos';

      const m4 = crearMetric(
        'Tendencia',
        `<span style="display:flex; align-items:center; gap:6px; color:${colorTendencia}; font-weight:700;">
            <span>${icono}</span>
            <span>${textoTendencia}</span>
        </span>`
      );

      // =======================
      // Ensamble final
      // =======================
      metrics.appendChild(m1);
      metrics.appendChild(m2);
      metrics.appendChild(m3);
      metrics.appendChild(m4);

      bloqueResumen.appendChild(graf);
      bloqueResumen.appendChild(metrics);
      content.appendChild(bloqueResumen);

      const p2 = document.createElement('p');
      p2.innerHTML = `<br><br>
      A continuaci√≥n la representaci√≥n gr√°fica de la evoluci√≥n en el tiempo del cumplimiento global organizacional.<br>
      `;
      content.appendChild(p2);

      // --- RECUPERAR GR√ÅFICO ---
      const imagenGrafico = localStorage.getItem("graficoCumplimientoGlobal");

      // --- CARD CONTENEDOR ELEGANTE ---
      const card = document.createElement("div");
      card.style.marginTop = "25px";
      card.style.padding = "10px";
      card.style.border = "1px solid #e0e0e0";
      card.style.borderRadius = "10px";
      card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.05)";
      card.style.background = "#fff";

      // --- T√çTULO DEL GR√ÅFICO ---
      const tituloGraf = document.createElement("h3");
      tituloGraf.textContent = "Evoluci√≥n del Cumplimiento Global";
      tituloGraf.style.fontSize = "16px";
      tituloGraf.style.marginBottom = "5px";
      tituloGraf.style.color = "#333";
      card.appendChild(tituloGraf);

      // --- CONTENEDOR DEL GR√ÅFICO ---
      const graf2 = document.createElement("div");
      graf2.style.display = "flex";
      graf2.style.alignItems = "center";
      graf2.style.justifyContent = "center";
      graf2.style.padding = "5px 0";

      if (imagenGrafico) {
        graf2.innerHTML = `
              <img src="${imagenGrafico}" 
                  style="
                    width: 530px; 
                    max-width: 100%;
                    border-radius: 6px;
                    border: 1px solid #ddd;
                    padding: 6px;
                    background: #fafafa;
                  ">
            `;
      } else {
        graf2.innerHTML = `
            <div style="
              width: 520px; height: 220px;
              border: 1px dashed #bbb; 
              border-radius: 6px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #777;
              background: #fafafa;
            ">
              [Gr√°fico no disponible]
            </div>
          `;
      }

      card.appendChild(graf2);

      // --- PIE DE GR√ÅFICO ---
      // const nota = document.createElement("div");
      // nota.style.marginTop = "10px";
      // nota.style.fontSize = "12px";
      // nota.style.color = "#666";
      // nota.style.textAlign = "center";
      // nota.innerHTML =
      //   "Este gr√°fico representa la evoluci√≥n mensual del porcentaje de cumplimiento consolidado en toda la organizaci√≥n.";
      // // card.appendChild(nota);

      // Insertar card en el contenido
      content.appendChild(card);

      // Agregar p√°gina final al documento
      documento.appendChild(page);
    }

    //üòéüòéüòé buildSectores
    function getSemaforo(valor) {
      if (valor >= 90) return 'üü¢';
      if (valor >= 70) return 'üü°';
      return 'üî¥';
    }

    //üòéüòéüòé buildIndicadores
    function buildIndicadores() {
      // =======================
      // Leer datos del storage
      // =======================
      const dataPDF = JSON.parse(
        localStorage.getItem('detalleUltimoMesPDF')
      );

      if (!dataPDF || !Array.isArray(dataPDF.indicadores)) {
        const { page, content } = createPage();
        const h = document.createElement('h2');
        h.className = 'section-title';
        h.textContent = 'Detalle del √∫ltimo mes';
        content.appendChild(h);

        const warn = document.createElement('p');
        warn.textContent = 'No hay datos disponibles para este per√≠odo.';
        content.appendChild(warn);
        documento.appendChild(page);
        return;
      }

      // =======================
      // Agrupar por destino
      // =======================
      const grupos = dataPDF.indicadores.reduce((acc, d) => {
        if (!acc[d.destinoNombre]) acc[d.destinoNombre] = [];
        acc[d.destinoNombre].push(d);
        return acc;
      }, {});

      // Ordenar indicadores por cumplimiento DESC
      Object.keys(grupos).forEach(destino => {
        grupos[destino].sort((a, b) => b.cumplimiento - a.cumplimiento);
      });

      // =======================
      // Variables de paginaci√≥n
      // =======================
      let currentPage = null;
      let currentContent = null;
      let alturaAcumulada = 0;
      const MAX_ALTURA = 950; // Altura m√°xima antes de crear nueva p√°gina (ajustar seg√∫n necesites)
      let esPrimeraPagina = true;

      function iniciarNuevaPagina() {
        const { page, content } = createPage();
        currentPage = page;
        currentContent = content;
        alturaAcumulada = 0;

        // Solo en la primera p√°gina agregar t√≠tulo y descripci√≥n
        if (esPrimeraPagina) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = 'Detalle del √∫ltimo mes';
          currentContent.appendChild(h);

          const p = document.createElement('p');
          p.innerHTML = `
              Valor de los indicadores que conforman la √∫ltima medici√≥n<br>
            `;
          currentContent.appendChild(p);

          const sub = document.createElement('h4');
          sub.textContent = `Per√≠odo: ${dataPDF.month}`;
          currentContent.appendChild(sub);

          alturaAcumulada = 180; // Altura estimada del encabezado
          esPrimeraPagina = false;
        } else {
          // En p√°ginas siguientes, agregar continuaci√≥n
          const cont = document.createElement('h3');
          cont.textContent = 'Detalle del √∫ltimo mes (continuaci√≥n)';
          cont.style.fontSize = '16px';
          cont.style.marginBottom = '10px';
          currentContent.appendChild(cont);
          alturaAcumulada = 60;
        }

        documento.appendChild(currentPage);
      }

      // Iniciar primera p√°gina
      iniciarNuevaPagina();

      // =======================
      // Renderizar por destino
      // =======================
      Object.keys(grupos).forEach(destino => {
        const indicadores = grupos[destino];

        // Calcular altura estimada del destino completo
        const alturaDestino = 40; // T√≠tulo del destino
        const alturaEncabezadoTabla = 35;
        const alturaFilaPorIndicador = 30;
        const alturaTotal = alturaDestino + alturaEncabezadoTabla +
          (indicadores.length * alturaFilaPorIndicador) + 20;

        // Si el destino completo cabe en la p√°gina actual
        if (alturaAcumulada + alturaTotal < MAX_ALTURA) {
          // Renderizar destino completo
          renderizarDestino(destino, indicadores);
          alturaAcumulada += alturaTotal;
        } else {
          // Necesitamos dividir o crear nueva p√°gina

          // Si apenas empezamos la p√°gina, renderizar lo que se pueda
          if (alturaAcumulada < 200) {
            renderizarDestino(destino, indicadores);
            alturaAcumulada += alturaTotal;
          } else {
            // Crear nueva p√°gina y renderizar ah√≠
            iniciarNuevaPagina();
            renderizarDestino(destino, indicadores);
            alturaAcumulada += alturaTotal;
          }
        }
      });

      function renderizarDestino(destino, indicadores) {
        // --- T√≠tulo del destino ---
        const hDestino = document.createElement('h4');
        hDestino.style.marginTop = '16px';
        hDestino.textContent = destino;
        currentContent.appendChild(hDestino);

        // --- Tabla del destino ---
        const table = document.createElement('table');
        table.className = 'tabla-indicadores';

        table.innerHTML = `
            <thead>
              <tr>
                <th></th>
                <th>Indicador</th>
                <th>Cumplimiento</th>
                <th>Peso</th>
                <th>Contribuci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

        const tbody = table.querySelector('tbody');

        indicadores.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="text-align:center">${getSemaforo(d.cumplimiento)}</td>
            <td>${d.indicador}</td>
            <td>${d.cumplimiento.toFixed(2)}%</td>
            <td>${d.peso.toFixed(2)}%</td>
            <td><strong>${d.contribucion.toFixed(2)}%</strong></td>
          `;
          tbody.appendChild(tr);
        });

        currentContent.appendChild(table);
      }

      // =======================
      // TOTAL GENERAL al final
      // =======================
      // Verificar si cabe en la p√°gina actual
      if (alturaAcumulada + 50 > MAX_ALTURA) {
        iniciarNuevaPagina();
      }

      const total = document.createElement('p');
      total.style.marginTop = '12px';
      total.innerHTML = `
    <strong>Total contribuci√≥n del per√≠odo:</strong>
    ${dataPDF.totalContribucion.toFixed(2)}%
  `;
      currentContent.appendChild(total);
    }

    //üòéüòéüòé buildIndicadoresPorContribucion
    function buildIndicadoresPorContribucion() {
      // =======================
      // Leer datos del storage
      // =======================
      const dataPDF = JSON.parse(
        localStorage.getItem('detalleUltimoMesPDF')
      );

      if (!dataPDF || !Array.isArray(dataPDF.indicadores)) {
        const { page, content } = createPage();
        const h = document.createElement('h2');
        h.className = 'section-title';
        h.textContent = 'Indicadores por Contribuci√≥n';
        content.appendChild(h);

        const warn = document.createElement('p');
        warn.textContent = 'No hay datos disponibles para este per√≠odo.';
        content.appendChild(warn);
        documento.appendChild(page);
        return;
      }

      // =======================
      // Ordenar por contribuci√≥n DESC
      // =======================
      const indicadoresOrdenados = [...dataPDF.indicadores].sort(
        (a, b) => b.contribucion - a.contribucion
      );

      // =======================
      // Variables de paginaci√≥n
      // =======================
      let currentPage = null;
      let currentContent = null;
      let alturaAcumulada = 0;
      const MAX_ALTURA = 950;
      let esPrimeraPagina = true;

      function iniciarNuevaPagina() {
        const { page, content } = createPage();
        currentPage = page;
        currentContent = content;
        alturaAcumulada = 0;

        if (esPrimeraPagina) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = 'Indicadores por Contribuci√≥n';
          currentContent.appendChild(h);

          const p = document.createElement('p');
          p.innerHTML = `
            A continuaci√≥n se presentan todos los indicadores ordenados por su 
            contribuci√≥n al cumplimiento global, de mayor a menor impacto.<br>
          `;
          currentContent.appendChild(p);

          const sub = document.createElement('h4');
          sub.textContent = `Per√≠odo: ${dataPDF.month}`;
          currentContent.appendChild(sub);

          alturaAcumulada = 180;
          esPrimeraPagina = false;
        } else {
          const cont = document.createElement('h3');
          cont.textContent = 'Indicadores por Contribuci√≥n (continuaci√≥n)';
          cont.style.fontSize = '16px';
          cont.style.marginBottom = '10px';
          currentContent.appendChild(cont);
          alturaAcumulada = 60;
        }

        documento.appendChild(currentPage);
      }

      // Iniciar primera p√°gina
      iniciarNuevaPagina();

      // =======================
      // Crear tabla √∫nica
      // =======================
      const table = document.createElement('table');
      table.className = 'tabla-indicadores';

      table.innerHTML = `
          <thead>
            <tr>
              <th></th>
              <th>Indicador</th>
              <th>Destino</th>
              <th>Cumplimiento</th>
              <th>Peso</th>
              <th>Contribuci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

      const tbody = table.querySelector('tbody');
      currentContent.appendChild(table);
      alturaAcumulada += 35; // Encabezado de tabla

      // =======================
      // Agregar filas
      // =======================
      indicadoresOrdenados.forEach((d, index) => {
        const alturaFila = 30;

        // Si nos pasamos de altura, crear nueva p√°gina
        if (alturaAcumulada + alturaFila > MAX_ALTURA) {
          iniciarNuevaPagina();

          // Crear nueva tabla en la nueva p√°gina
          const nuevaTable = document.createElement('table');
          nuevaTable.className = 'tabla-indicadores';
          nuevaTable.innerHTML = `
            <thead>
              <tr>
                <th></th>
                <th>Indicador</th>
                <th>Destino</th>
                <th>Cumplimiento</th>
                <th>Peso</th>
                <th>Contribuci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          currentContent.appendChild(nuevaTable);
          tbody = nuevaTable.querySelector('tbody');
          alturaAcumulada += 35;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center">${getSemaforo(d.cumplimiento)}</td>
            <td>${d.indicador}</td>
            <td style="font-size: 0.9em; color: #666;">${d.destinoNombre}</td>
            <td>${d.cumplimiento.toFixed(2)}%</td>
            <td>${d.peso.toFixed(2)}%</td>
            <td><strong>${d.contribucion.toFixed(2)}%</strong></td>
          `;
        tbody.appendChild(tr);
        alturaAcumulada += alturaFila;
      });

      // =======================
      // TOTAL GENERAL al final
      // =======================
      if (alturaAcumulada + 50 > MAX_ALTURA) {
        iniciarNuevaPagina();
      }

      const total = document.createElement('p');
      total.style.marginTop = '12px';
      total.innerHTML = `
          <strong>Total contribuci√≥n del per√≠odo:</strong>
          ${dataPDF.totalContribucion.toFixed(2)}%
        `;
      currentContent.appendChild(total);
    }


    //üòéüòéüòé buildBSC
    function buildBSC() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'BSC - Balanced Scorecard';

      content.appendChild(h);
      const p0 = document.createElement('p'); p0.innerHTML = `
      El enfoque de Balanced Scorecard (BSC) permite evaluar el desempe√±o organizacional desde m√∫ltiples perspectivas,
      integrando indicadores financieros y no financieros para ofrecer una visi√≥n equilibrada y completa.<br><br>
      A continuaci√≥n se presentan los resultados obtenidos en las distintas perspectivas del BSC durante el per√≠odo evaluado.
      `;
      content.appendChild(p0);

      const p = document.createElement('p'); p.innerHTML = `
      1. Mostrar grafico con las cuatro barras y el cuadro con la cantidad de indicadores de cada perspectiva.<br><br>
      `;
      content.appendChild(p);

      const p1 = document.createElement('p'); p1.innerHTML = `
      2. Evoluci√≥n temporal.  Mostrar tendencia de cada perspectiva.<br><br>
      `;
      content.appendChild(p1);

      const p2 = document.createElement('p'); p2.innerHTML = `
      3. Mostrar los indicadores por perspectiva, con participaci√≥n de cada uno y ordenado por mejor cumplimiento.<br><br>
      `;
      content.appendChild(p2);


      const p3 = document.createElement('p'); p3.innerHTML = `
      4. En cada pagina los indicadores de cada perspectiva, mostrando el grafico del mejor calificado y el grafico del peor calificado.<br>
      Cada perspectiva se muestra en una p√°gina separada.<br>
      Poner comentarios y el plan de accion del indicador que se muestra adem√°s del gr√°fico<br>
      `;
      content.appendChild(p3);

      documento.appendChild(page);
    }

    //üòéüòéüòé nuevaPagina
    function nuevaPagina() {
      const { page, content } = createPage();
      documento.appendChild(page);
      return { page, content };
    }

    //üòéüòéüòé buildAnexos
    function buildAnexos() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Anexos';
      content.appendChild(h);

      const p = document.createElement('p'); p.textContent = 'Listado completo de mediciones y notas metodol√≥gicas.';
      content.appendChild(p);

      documento.appendChild(page);
    }

    // Cuando se arma el documento numeramos las p√°ginas (footer .page-number)
    //üòéüòéüòé numerarPaginas
    function numerarPaginas() {
      const pages = [...document.querySelectorAll('.page')];
      pages.forEach((p, idx) => {
        const el = p.querySelector('.page-number');
        if (el) el.textContent = `P√°gina ${idx + 1} de ${pages.length}`;
      });
    }

    //üòéüòéüòé buildDocumento completo
    function buildDocument() {
      clearDocument();
      // buildCover();
      buildCover2();
      buildIntrooverview();
      buildTOC();
      buildResumen();
      buildIndicadoresGlobales();
      buildIndicadores();
      buildIndicadoresPorContribucion();
      buildBSC()
      buildAnexos();
      numerarPaginas();
    }


    // üèÄüèÄüèÄ Exportar a PDF usando html2pdf
    async function exportPDF() {

      const spinner = document.getElementById('spinnerOverlay');
      const spinnerText = document.getElementById('spinnerText');
      spinner.style.display = 'flex';
      spinnerText.textContent = 'Generando informe PDF, por favor espere...';
      // Clonar el nodo para no afectar la vista
      const node = documento.cloneNode(true);
      const filename = `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`
      // Opciones de html2pdf
      const opt = {
        margin: 0,
        filename: `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 1.9,
          useCORS: true,
          letterRendering: true
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css'] }
      };


      // html2pdf requiere que el nodo est√© en el DOM en algunos navegadores; lo insertamos oculto temporalmente
      const holder = document.createElement('div'); holder.style.position = 'fixed'; holder.style.left = '-9999px'; holder.style.top = '-9999px'; holder.appendChild(node);
      document.body.appendChild(holder);

      node.querySelectorAll('.page').forEach(p => {
        p.style.boxShadow = 'none';
      });

      try {
        await html2pdf().set(opt).from(node).save();
      } catch (e) {
        console.error('Error generando PDF', e);
        alert('Error generando PDF ‚Äî ver consola');
      } finally {
        document.body.removeChild(holder);
      }
      spinnerText.textContent = `‚úÖ Informe generado correctamente.<br><br>
                    El archivo se descarg√≥ como: ${filename}`;
      setTimeout(() => (spinner.style.display = 'none'), 10000);
    }

    // üèÄüèÄüèÄ Abrir vista previa en nueva ventana (serializamos el HTML del documento)
    // function previewNewWindow() {
    //   const w = window.open('about:blank', '_blank');
    //   const html = `<!doctype html><html><head><meta charset="utf-8"><title>Preview</title>` +
    //     '<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">' +
    //     '<style>body{margin:0;padding:0;background:#ddd}.page{margin:12px auto}</style></head><body>' + documento.innerHTML + '</body></html>';
    //   w.document.open(); w.document.write(html); w.document.close();
    // }

    // Eventos
    // document.getElementById('btn-build').addEventListener('click', () => { buildDocument(); window.scrollTo(0, 0); });
    document.getElementById('btn-pdf').addEventListener('click', () => { exportPDF(); });
    // document.getElementById('btn-preview').addEventListener('click', () => { previewNewWindow(); });

    // Auto-build initial
    buildDocument();
  </script>
</body>

</html>