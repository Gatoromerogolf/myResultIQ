<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla Informe - myResultIQ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Abel&family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Courgette&family=Gupter:wght@400;500;700&family=PT+Sans+Narrow:wght@400;700&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --azul: #1F78FF;
      --gris: #333333;
      --gris-claro: #F2F2F2;
      --espacio: 16px;
      --page-width-mm: 210mm;
      /* A4 */
    }

    /* Reset b√°sico */
    * {
      box-sizing: border-box
    }

    body {
      /* font-family: 'Roboto', system-ui, sans-serif; */
      font-family: "Abel", sans-serif;
      font-weight: 500;
      font-size: 18px;
      color: var(--gris);
      margin: 0;
      background: #efefef;
    }

    h4 {
      font-weight: 700;
      font-size: 21px;
    }

    /* Contenedor que simula el documento */
    .doc-wrap {
      max-width: 900px;
      margin: 24px auto;
      padding: 24px
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer
    }

    /* Estilos de p√°gina (cada .page ser√° una hoja A4 cuando se exporte a PDF) */
    .page {
      width: 210mm;
      height: 297mm;
      /* Fijar exactamente una A4 */
      background: white;
      margin: 0;
      position: relative;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      /* evita cortes extra */
    }

    /* MARCO INTERNO */
    .marco {
      border: 2px solid #007BFF;
      border-radius: 5mm;
      padding: 8mm;
      margin: 20mm 12mm 20mm 12mm;
      /* margen interno superior / inferior */
      height: calc(297mm - 40mm);
      /* altura real √∫til */
      box-sizing: border-box;
    }

    /* Contenido */
    .content {
      overflow: hidden;
      /* evita ‚Äúspill‚Äù */
    }

    .marco,
    .content,
    table,
    h2,
    p {
      page-break-inside: avoid;
    }

    /* Header / Footer */
    .header {
      position: absolute;
      top: 5mm;
      left: 10mm;
      right: 10mm;
      text-align: center;
    }

    .footer {
      position: absolute;
      bottom: 5mm;
      left: 10mm;
      right: 10mm;
      text-align: center;
    }

    /* === PORTADA PREMIUM === */
    .cover-page {
      padding: 0 !important;
      position: relative;
      overflow: hidden;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      color: white;
      font-family: 'Montserrat', sans-serif;
    }

    /* Overlay degradado premium */
    .cover-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
          rgba(0, 0, 0, 0.65) 0%,
          rgba(0, 0, 0, 0.30) 40%,
          rgba(0, 0, 0, 0.55) 100%);
      z-index: 1;
    }

    /* Contenedor central */
    .cover-content {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40mm 25mm 30mm 25mm;
      text-align: center;
    }

    /* Logo */
    .cover-logocomun {
      width: 25mm;
      opacity: 0.95;
      margin-bottom: 20mm;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .cover-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30mm;
      /* si quer√©s ajustarlo */
      opacity: 0.95;
    }

    /* T√≠tulos */
    .cover-title {
      font-size: 34pt;
      font-weight: 700;
      margin-bottom: 10mm;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.55);
    }

    .cover-subtitle {
      font-size: 20pt;
      font-weight: 500;
      margin-bottom: 3mm;
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.45);
    }

    /* RESUMEN EJECUTIVO */
    .cover-resumen {
      margin-top: 18mm;
      font-size: 14pt;
      font-weight: 300;
      line-height: 1.55;
      text-align: justify;
      padding: 0 5mm;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Pie */
    .cover-bottom {
      position: absolute;
      bottom: 12mm;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 12pt;
      opacity: 0.85;
      z-index: 3;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.55);
    }

    .cover2-page {
      padding: 0 !important;
      position: relative;
      overflow: hidden;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      color: rgb(65, 138, 247);
      font-family: 'Montserrat', sans-serif;
    }

    /* Overlay degradado premium */
    .cover2-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
          rgba(0, 0, 0, 0.65) 0%,
          rgba(0, 0, 0, 0.30) 40%,
          rgba(0, 0, 0, 0.55) 100%);
      z-index: 1;
    }

    /* Contenedor central */
    .cover2-content {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40mm 25mm 30mm 25mm;
      text-align: center;
    }

    /* Logo */
    .cover2-logocomun {
      width: 25mm;
      opacity: 0.95;
      margin-bottom: 20mm;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .cover2-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30mm;
      /* si quer√©s ajustarlo */
      opacity: 0.95;
    }

    /* T√≠tulos */
    .cover2-empresa {
      font-size: 35pt;
      font-weight: 500;
      color: #333333;
      position: absolute;
      top: 80mm;
      /* distancia desde arriba */
      left: 0;
      right: 0;
      text-align: center;
    }

    /* T√≠tulos */
    .cover2-infoeje {
      font-size: 24pt;
      font-weight: 500;
      position: absolute;
      top: 110mm;
      /* distancia desde arriba */
      left: 0;
      right: 0;
      text-align: center;
    }

    .cover2-indiGes {
      font-size: 40pt;
      font-weight: 600;
      color: #333333;
      position: absolute;
      top: 130mm;
      left: 0;
      right: 0;
      text-align: center;
    }

    .cover2-seguimiento {
      font-size: 20pt;
      font-weight: 500;
      position: absolute;
      top: 160mm;
      width: 80%;
      /* left: 20px;
      right: 20px; */
      text-align: center;
    }

    .cover2-intro {
      font-size: 14pt;
      font-weight: 400;
      /* position: absolute;
      top: 90mm;
      left: 40mm;
      right: 40mm; */
      text-align: justify;
    }

    .cover2-subtitle2 {
      font-size: 14pt;
      font-weight: 400;
      position: absolute;
      top: 90mm;
      left: 40mm;
      right: 40mm;
      text-align: justify;
    }

    .cover2-piemyResult {
      font-size: 11pt;
      font-weight: 400;
      position: absolute;
      top: 220mm;
      left: 30mm;
      right: 30mm;
      margin-top: 10mm;
      text-align: center;
    }


    /* RESUMEN EJECUTIVO */
    .cover2-resumen {
      margin-top: 18mm;
      font-size: 14pt;
      font-weight: 300;
      line-height: 1.55;
      text-align: justify;
      padding: 0 5mm;
      position: absolute;
      top: 170mm;
      /* text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); */
    }

    /* Pie */
    .cover2-bottom {
      position: absolute;
      bottom: 12mm;
      left: 40px;
      width: 100%;
      text-align: center;
      font-size: 12pt;
      opacity: 0.85;
      z-index: 3;
      /* text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.55); */
    }

    .logo-image {
      width: 20mm;
      margin-top: 5mm;
      opacity: 0.9;
    }

    h2.section-title {
      /* font-family: 'Montserrat'; */
      font-size: 24px;
      margin: 0px 0 5px 0;
      color: var(--azul);
      font-weight: 700;
    }

    /* Contenedor de las m√©tricas: 4 columnas fijas */
    .metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      width: 100%;
    }

    /* Tarjetas */
    .metric {
      background: #fff;
      border: 5px solid #eee;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
      display: flex;
      flex-direction: column;
      /* apila label arriba y valor abajo */
      align-items: center;
      /* centra horizontalmente */
    }

    .metric .label {
      font-size: 12px;
      color: #666;
    }

    .metric .value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 6px;
    }

    .tabla-indicadores {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 12px;
    }

    .tabla-indicadores th,
    .tabla-indicadores td {
      border: 1px solid #999;
      padding: 6px;
    }

    .tabla-indicadores th {
      background: #f0f0f0;
    }

    .fila-total td {
      background: #fafafa;
      font-size: 13px;
    }


    /* üì± RESPONSIVE: en pantallas peque√±as pasa a 2x2 */
    @media (max-width: 768px) {
      .metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* üì± Extra chico: 1 por l√≠nea */
    @media (max-width: 450px) {
      .metrics {
        grid-template-columns: 1fr;
      }
    }

    /* Responsive preview scaling */
    @media (max-width:980px) {
      .doc-wrap {
        padding: 10px
      }

      .page {
        width: 100%;
        min-height: 1200px
      }
    }

    /* Tabla simple */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #eee;
      text-align: left;
      font-size: 13px
    }

    th {
      background: var(--gris-claro);
      font-weight: 600
    }

    /* Page break helper */
    .page-break {
      page-break-after: always;
    }

    /* TOC */
    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0
    }

    .toc-list li {
      padding: 6px 0;
      border-bottom: 1px dashed #eee
    }

    .separator {
      width: 65%;
      height: 3px;
      background: #444;
      border-radius: 3px;
      margin: 0 auto 35px auto;
      position: absolute;
      top: 100mm;
    }

    .perspectiva-section {
      margin-bottom: 40px;
      page-break-after: always;
    }

    .perspectiva-section:last-child {
      page-break-after: auto;
    }

    @media print {
      .perspectiva-section {
        page-break-after: always;
      }
    }

    .tree-report-container {
      font-size: 14px;
    }

    .tree-report-row {
      padding: 2px 0;
      border-left: 2px solid #ddd;
      padding-left: 8px;
    }

    .estado-verde {
      color: #1b7e3c;
      font-weight: 600;
    }

    .estado-amarillo {
      color: #b38b00;
      font-weight: 600;
    }

    .estado-rojo {
      color: #b02a37;
      font-weight: 600;
    }

    .tabla-informe {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .tabla-informe th,
    .tabla-informe td {
      border: 1px solid #ccc;
      padding: 5px;
    }

    .tabla-informe th {
      background-color: #f2f2f2;
    }

    .fila-usuario {
      background-color: #f0f0f0;
    }

    .fila-indicador td {
      background-color: #fff;
    }

    .titulo-jefe {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: bold;
    }

    .org-linea {
      font-family: "Courier New", Consolas, monospace;
      font-size: 16px;
      line-height: 1.8;
      white-space: pre;
    }

    .org-raiz {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .destino-usuario {
      margin: 4px 0 2px 0;
      font-style: italic;
    }

    .lista-indicadores {
      margin-left: 20px;
      margin-bottom: 16px;
    }

    .sin-indicadores {
      margin-top: 24px;
      font-weight: bold;
    }

    .usuario-block {
      margin-bottom: 20px;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* üìÑ Reglas de impresi√≥n */
    @media print {
      table {
        page-break-inside: auto;
      }

      h3 {
        page-break-after: avoid;
      }

      tr {
        page-break-inside: avoid;
        break-inside: avoid;
      }

      thead {
        display: table-header-group;
        /* üî• Repite encabezado */
      }

      .fila-usuario {
        background-color: #e0e0e0 !important;
      }

      .org-linea {
        page-break-inside: avoid;
        break-inside: avoid;
      }

      ul,
      li {
        page-break-inside: avoid;
      }

      .usuario-block {
        page-break-before: always;
        break-before: page;
      }

      .salto-hoja {
        page-break-before: always;
        break-before: page;
      }
    }

    .toolbar {
      display: flex;
      justify-content: flex-start;
      margin-bottom: 16px;
    }

    .btn-pdf {
      background-color: #2563eb;
      /* azul */
      color: #fff;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-pdf:hover {
      background-color: rgb(233, 50, 50);
    }

    .btn-pdf:active {
      transform: translateY(1px);
      box-shadow: 0 3px 3px rgba(0, 0, 0, 0.2);
    }

    .pdf-icon {
      color: #c62828;
      background: white;
      border-radius: 3px;
      padding: 2px 4px;
      margin-left: 8px;
      font-size: 0.9em;
    }


    /* Overlay */
    .pdf-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
      z-index: 3000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Caja central */
    .pdf-modal-content {
      background: #ffffff;
      padding: 32px 40px;
      border-radius: 16px;
      min-width: 320px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .25);
      animation: scaleIn .3s ease-out;
    }

    /* Texto */
    .pdf-text {
      font-size: 1rem;
      font-weight: 500;
      color: #1f2937;
    }

    /* Check animado */
    .pdf-check {
      font-size: 64px;
      color: #16a34a;
      animation: pop .4s ease-out;
    }

    /* Animaciones */
    @keyframes scaleIn {
      from {
        transform: scale(.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes pop {
      0% {
        transform: scale(0);
      }

      70% {
        transform: scale(1.2);
      }

      100% {
        transform: scale(1);
      }
    }
  </style>
</head>

<body>

  <div class="doc-wrap">
    <div class="toolbar">
      <button id="btn-pdf" class="btn-pdf">
        Exportar informe a PDF
        <i class="fas fa-file-pdf pdf-icon"></i>
      </button>
    </div>

    <!-- Contenedor donde el script crear√° las p√°ginas -->
    <div id="documento"></div>
  </div>

  <!-- Spinner / Modal flotante -->
  <!-- <div id="spinnerOverlay" style="
                display:none;
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 2000;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                color: white;
                font-size: 1.2rem;
                ">
    <div class="spinner-border text-light mb-3" role="status">
      <span class="visually-hidden mb-3">Generando PDF...</span>
    </div>
    <span id="spinnerText">Creando Informe, por favor espere...</span>
  </div> -->

  <!-- üßæ Modal Generaci√≥n PDF -->
  <div id="pdfModal" class="pdf-modal d-none">
    <div class="pdf-modal-content text-center">

      <!-- Spinner -->
      <div id="pdfSpinner" class="spinner-border text-primary mb-3" role="status"></div>

      <!-- Check animado -->
      <div id="pdfSuccessIcon" class="pdf-check d-none">‚úì</div>

      <!-- Texto -->
      <div id="pdfModalText" class="pdf-text">
        Creando informe PDF‚Ä¶<br>
        <small>Por favor espere</small>
      </div>

      <!-- Bot√≥n cerrar -->
      <button id="btnCerrarPdfModal" class="btn btn-outline-primary btn-sm mt-3 d-none">
        Cerrar
      </button>

    </div>
  </div>


  <!-- Dependencia para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    // Datos de ejemplo (luego los reemplaz√°s por tus datos reales)
    empresa = "ORGANIZACION";
    const ejemplo = {
      titulo: 'Informe de Indicadores',
      subtitulo: 'Gesti√≥n, seguimiento y an√°lisis de m√©tricas organizacionales',
      fecha: new Date().toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' }),
      autor: '√Årea de Gesti√≥n de Indicadores',
      resumen: {
        cumplimientoGlobal: '82%',
        promedioHistorico: '78.4',
        deltaMes: '+3.2%'
      },

      sectores: [
        {
          id: 1, nombre: 'Comercial', indicadores: [
            { id: 11, nombre: 'Ventas mensuales', meta: '100k', valor: '92k', estado: 'amarillo' },
            { id: 12, nombre: 'Tasa de conversi√≥n', meta: '2.5%', valor: '3.1%', estado: 'verde' }
          ]
        },
        {
          id: 2, nombre: 'Operaciones', indicadores: [
            { id: 21, nombre: 'Tiempo de respuesta', meta: '<24h', valor: '18h', estado: 'verde' },
            { id: 22, nombre: 'Incidentes cr√≠ticos', meta: '0', valor: '1', estado: 'rojo' }
          ]
        }
      ]
    };

    // --- Construcci√≥n del documento (DOM) ---
    const documento = document.getElementById('documento');

    // üß≤üß≤üß≤clearDocument
    function clearDocument() { documento.innerHTML = ''; }

    function createPage() {
      const page = document.createElement('section');
      page.className = 'page';

      // Header (fuera del marco)
      const header = document.createElement('div');
      header.className = 'header';
      header.innerHTML = `<div>${ejemplo.titulo}</div><div>${ejemplo.fecha}</div>`;
      page.appendChild(header);

      // Marco interno
      const marco = document.createElement('div');
      marco.className = 'marco';
      page.appendChild(marco);

      // Contenido dentro del marco
      const content = document.createElement('div');
      content.className = 'content';
      marco.appendChild(content);

      // Footer (fuera del marco)
      const footer = document.createElement('div');
      footer.className = 'footer';
      footer.innerHTML = `
    <div>Generado por: ${ejemplo.autor}</div>
    <div class="page-number">P√°gina</div>
  `;
      page.appendChild(footer);

      return { page, content };
    }

    //üòéüòéüòé buildCover
    // function buildCover() {
    //   const page = document.createElement('section');
    //   page.className = 'page cover-page';

    //   // === Fondo de barras diagonales modernas ===
    //   page.style.background = `
    //       repeating-linear-gradient(
    //         -45deg,
    //         #0a2850 0,
    //         #0a2850 12mm,
    //         #123d80 12mm,
    //         #123d80 24mm
    //       )
    //   `;
    //   page.style.backgroundSize = "cover";

    //   // Overlay premium
    //   const overlay = document.createElement('div');
    //   overlay.className = 'cover-overlay';
    //   page.appendChild(overlay);

    //   // Contenido central
    //   const content = document.createElement('div');
    //   content.className = 'cover-content';

    //   // Logo
    //   const logo = document.createElement('img');
    //   logo.className = 'cover-logo';
    //   logo.src = "../dist/images/leon.png";
    //   // content.appendChild(logo);
    //   page.appendChild(logo);  // ‚¨ÖÔ∏è importante: no va dentro de cover-content

    //   // T√≠tulo principal
    //   const title = document.createElement('div');
    //   title.className = 'cover-title';
    //   title.textContent = ejemplo.titulo;
    //   content.appendChild(title);

    //   // Subt√≠tulo
    //   const subtitle = document.createElement('div');
    //   subtitle.className = 'cover-subtitle';
    //   subtitle.textContent = ejemplo.subtitulo;
    //   content.appendChild(subtitle);

    //   // Resumen ejecutivo
    //   const resumen = document.createElement('div');
    //   resumen.className = 'cover-resumen';
    //   resumen.textContent =
    //     "Este informe resume los principales indicadores estrat√©gicos, " +
    //     "identifica variaciones cr√≠ticas y presenta una visi√≥n anal√≠tica " +
    //     "general del desempe√±o institucional durante el per√≠odo evaluado. <br>" +
    //     "<br><br>" +
    //     "Los datos presentados han sido procesados con la plataforma <strong>myResultIQ</strong>, asegurando precisi√≥n y trazabilidad en cada etapa del an√°lisis.";
    //   content.appendChild(resumen);

    //   page.appendChild(content);

    //   // Pie inferior
    //   const bottom = document.createElement('div');
    //   bottom.className = 'cover-bottom';
    //   bottom.textContent = `Generado el ${ejemplo.fecha}`;
    //   page.appendChild(bottom);

    //   documento.appendChild(page);
    // }

    // ===============================================================================
    // üß≤üß≤üß≤ buildCaratula
    // ===============================================================================
    function buildCaratula() {
      const page = document.createElement('section');
      page.className = 'page cover2-page';

      // === Fondo completo ===
      // page.style.backgroundImage = 'url("../dist/images/Fondomy.png")';
      page.style.backgroundImage = 'url("../dist/images/PortadaAzulBlanca.png")';

      // Contenedor central
      const content = document.createElement('div');
      content.className = 'cover2-content';

      // Empresa
      const subtitle = document.createElement('div');
      subtitle.className = 'cover2-empresa';
      subtitle.textContent = "ORGANIZACION";
      content.appendChild(subtitle);

      //Informe Ejecutivo
      const infoEje = document.createElement('div');
      infoEje.className = 'cover2-infoeje';
      infoEje.textContent = "Informe Ejecutivo";
      content.appendChild(infoEje);

      //Indicadores de Gesti√≥n
      const indiGes = document.createElement('div');
      indiGes.className = 'cover2-indiGes';
      indiGes.textContent = "Indicadores de Gesti√≥n";
      content.appendChild(indiGes);


      // T√≠tulo
      const title = document.createElement('div');
      title.className = 'cover2-seguimiento';
      title.textContent = "Seguimiento y an√°lisis de m√©tricas organizacionales.";
      content.appendChild(title);


      // Pie inferior
      const bottom = document.createElement('div');
      bottom.className = 'cover2-bottom';
      bottom.textContent = `${ejemplo.fecha}`;
      content.appendChild(bottom);

      page.appendChild(content);

      documento.appendChild(page);
    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildIndice
    // ===============================================================================
    function buildIndice() {
      const { page, content } = createPage();
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Tabla de Contenido';
      h.style.textAlign = 'center';
      content.appendChild(h);

      const ul = document.createElement('ul'); ul.className = 'toc-list';
      // Generamos entradas acordes a las secciones previstas
      const entradas = [
        'Marco Introductorio y Visi√≥n General',
        'Resumen Ejecutivo',
        'Indicadores Globales',
        'Cumplimiento por Destino',
        'Composici√≥n de los resultados',
        'Indicadores por Contribuci√≥n',
        'BSC - Balance Scorecard',
        '   1. Gr√°fico de cumplimiento promedio',
        '   2. Tabla de peerspectivas',
        '   3. Detalle de indicadorespor perspectiva',
        '      3.1. Indicadores de Perspectiva Clientes',
        '      3.2. Indicadores de Perspectiva Financiera',
        '      3.3. Indicadores de Perspectiva Capital Humano',
        '      3.4. Indicadores de Perspectiva Procesos',
        'Anexo 1 - Arbol de Destinos e Indicadores',
        'Anexo 2 - Usuarios',
        'Anexo 3 - Organigrama Institucional',
        'Anexo 4 - Usuarios registrados e indicadores asignados'
      ];
      entradas.forEach((e, i) => {
        const li = document.createElement('li'); li.textContent = `${i + 1}. ${e}`;
        ul.appendChild(li);
      });

      content.appendChild(ul);

      documento.appendChild(page);
    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildMarcoIntroductorio
    // ===============================================================================
    function buildMarcoIntroductorio() {
      const { page, content } = createPage();
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Marco Introductorio y Visi√≥n General';
      content.appendChild(h);

      const p = document.createElement('div');
      p.className = 'cover2-intro';
      p.innerHTML = `<br>
          <h4>Finalidad</h4>

          <p>El presente informe tiene por finalidad ofrecer una visi√≥n integral y consolidada del desempe√±o organizacional mediante el an√°lisis de los indicadores clave de gesti√≥n (KPIs). Se presenta una s√≠ntesis estructurada de la informaci√≥n disponible en el dashboard interactivo, con el prop√≥sito de facilitar la toma de decisiones estrat√©gicas basadas en datos cuantitativos y cualitativos correspondientes al per√≠odo evaluado.</p>

          <h4>Destinatarios</h4>
          <p>Este documento est√° dirigido a la Alta Direcci√≥n, gerencias de √°rea y dem√°s actores estrat√©gicos que requieren informaci√≥n precisa, actualizada y confiable para evaluar el desempe√±o institucional, monitorear avances y orientar la planificaci√≥n estrat√©gica.</p>

          <h4>Prop√≥sito y Alcance</h4>
          <p>El informe resume los principales indicadores estrat√©gicos, analiza su evoluci√≥n, identifica desviaciones relevantes y eval√∫a el nivel de cumplimiento respecto de los objetivos establecidos. Adem√°s, integra tendencias, comparaciones interper√≠odos y observaciones contextuales que permiten interpretar el comportamiento de los indicadores.<br>El objetivo central es transformar los datos en insights accionables que apoyen la gesti√≥n, la toma de decisiones y el mejoramiento continuo de los procesos institucionales.</p>

          <h4>Calidad y Precisi√≥n de los Datos</h4>
          <p>La validez de los resultados presentados depende directamente de la calidad de los datos utilizados. Por ello, se destaca la importancia de los procesos de verificaci√≥n, consistencia y validaci√≥n aplicados durante cada etapa de recolecci√≥n, procesamiento y consolidaci√≥n.</p>` +
        `<p>Estos mecanismos aseguran la trazabilidad, la transparencia anal√≠tica y la confiabilidad del sistema de medici√≥n, permitiendo construir conclusiones s√≥lidas y comparables en el tiempo.</p>`

      content.appendChild(p);
      documento.appendChild(page);


      // Crear segunda hoja
      const { page: page1, content: content1 } = createPage();

      // Primer bloque
      const p1 = document.createElement('div');
      p1.className = 'cover2-intro';
      p1.innerHTML = `

            <h4> Evoluci√≥n y Mejora Continua</h4>
            <p>El sistema de indicadores que sustenta este informe es din√°mico y evolutivo. La incorporaci√≥n progresiva de nuevos KPIs, as√≠ como la actualizaci√≥n y el refinamiento de los existentes, permitir√° avanzar hacia un monitoreo m√°s detallado y granular del desempe√±o institucional.<br>Esta ampliaci√≥n gradual responde al nivel de madurez de los procesos internos y a las necesidades estrat√©gicas detectadas, contribuyendo a una comprensi√≥n cada vez m√°s precisa de los factores que influyen en los resultados organizacionales.</p>

            <h4> Estructura del Informe</h4>

            <p>El documento se organiza en secciones tem√°ticas que agrupan indicadores relacionados. Para cada uno se presentan:<br>
              <ul>
                <li>Valores actuales</li>
                <li>Tendencias hist√≥ricas</li>
                <li>Comparaciones con per√≠odos anteriores</li>
                <li>An√°lisis de brechas respecto de metas establecidas</li>
                <li>Observaciones cualitativas y factores contextuales relevantes</li>
              </ul>
            Esta estructura favorece tanto una lectura integral del desempe√±o global como la consulta segmentada por √°rea o l√≠nea estrat√©gica, seg√∫n las necesidades del usuario.</p>`;

      content1.appendChild(p1);

      const piemyResult = document.createElement('div');
      piemyResult.className = 'cover2-piemyResult';
      piemyResult.innerHTML = `
            Los datos de este informe han sido procesados con la plataforma <strong> myResultIQ</strong>,
            asegurando precisi√≥n y trazabilidad en cada etapa del an√°lisis.
            <br>
              <img src="/dist/images/leon.png" class="logo-image" alt="Logo">
                `;
      page1.appendChild(piemyResult);

      documento.appendChild(page1);
    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildResumen
    // ===============================================================================
    async function buildResumen() {
      const { page, content } = createPage();
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Resumen Ejecutivo';
      content.appendChild(h);

      // -----------------------
      // Texto descriptivo
      // -----------------------
      const p = document.createElement('div');

      const cantSectores = localStorage.getItem('cantSectores');
      const cantActivos = localStorage.getItem('cantIndicadoresActivos');
      const cantDestinos = localStorage.getItem('destinosMedidos');
      const cantMediciones = localStorage.getItem('totalMediciones');
      const cantAlDia = Number(localStorage.getItem('cantOk'));
      const cantDemorados = Number(localStorage.getItem('cantDemorados'));
      const cantPendientes = Number(localStorage.getItem('cantnoInformados'));
      const fechaISODesde = localStorage.getItem('fechaDesde');
      const fechaISOHasta = localStorage.getItem('fechaHasta');

      // ‚úîÔ∏è Objetos Date (para c√°lculos)
      const fechaDesdeDate = new Date(fechaISODesde);
      const fechaHastaDate = new Date(fechaISOHasta);

      // ‚úîÔ∏è Strings SOLO para mostrar
      const fechaDesdeTexto = fechaDesdeDate.toLocaleDateString(
        'es-AR',
        { year: 'numeric', month: 'long', day: 'numeric' }
      );

      const fechaHastaTexto = fechaHastaDate.toLocaleDateString(
        'es-AR',
        { year: 'numeric', month: 'long', day: 'numeric' }
      );


      function cantidadMesesEntreFechas(desde, hasta) {
        if (hasta < desde) return 0;

        const yearDiff = hasta.getFullYear() - desde.getFullYear();
        const monthDiff = hasta.getMonth() - desde.getMonth();

        return yearDiff * 12 + monthDiff + 1;
      }

      const totalMeses = cantidadMesesEntreFechas(fechaDesdeDate, fechaHastaDate);

      let texto =
        `<br> ` +
        `<h4>Estructura Organizacional:</h4>
        La organizaci√≥n ha sido modelada en <strong>${cantSectores}</strong> destinos, que representan las distintas entidades, sectores, procesos o unidades funcionales que componen la estructura de medici√≥n.<br><br>` +
        `De estos destinos, <strong>${cantDestinos}</strong> cuentan con indicadores directamente asignados, mientras que los restantes forman parte de la jerarqu√≠a organizacional y su desempe√±o se eval√∫a a trav√©s de los destinos subordinados.<br><br>` +

        `<h4>Ponderaci√≥n Estrat√©gica:</h4>
        Cada destino posee un peso porcentual que refleja su importancia relativa dentro de la estrategia organizacional. Esta ponderaci√≥n se define considerando el impacto de cada destino en la cadena de valor y permite calcular contribuciones ponderadas al desempe√±o global.<br><br>` +

        `<h4>Indicadores Activos:</h4>
        El sistema cuenta con un total de <strong>${cantActivos}</strong> indicadores activos en seguimiento, distribuidos entre los diferentes destinos de la organizaci√≥n.<br><br>` +

        `<h4>Metodolog√≠a de C√°lculo:</h4>
        Los indicadores est√°n asociados a destinos espec√≠ficos, los cuales pueden depender jer√°rquicamente de otros destinos. El c√°lculo del cumplimiento global se realiza de manera ascendente: primero se determina el cumplimiento de cada indicador individual, luego se consolida el resultado del destino al que pertenece y, finalmente, se propaga hacia los niveles superiores de la jerarqu√≠a.<br><br>` +
        `De esta forma, el cumplimiento global expresa el desempe√±o integral de la organizaci√≥n, ponderado seg√∫n la relevancia estrat√©gica de cada destino dentro de la estructura.<br><br>`

      p.innerHTML = texto;
      content.appendChild(p);
      documento.appendChild(page);


      // Crear segunda hoja
      const { page: page1, content: content1 } = createPage();

      // Primer bloque
      const p1 = document.createElement('div');
      p1.className = 'cover2-intro';

      let texto1 =
        `<h4>Per√≠odo de An√°lisis:</h4>
      Este informe ejecutivo resume las conclusiones de las mediciones registradas en el per√≠odo comprendido entre el <strong>${fechaDesdeTexto}</strong> y el <strong>${fechaHastaTexto}</strong>, durante el cual se han realizado y registrado un total de <strong>${cantMediciones}</strong> mediciones.<br><br>`

      if (cantDemorados === 0 && cantPendientes === 0) {
        texto1 += `<h4>Calidad de la Informaci√≥n:</h4>
        Todos los indicadores fueron medidos con la frecuencia establecida y no existen mediciones pendientes para el per√≠odo analizado. Los resultados presentados en este informe reflejan fielmente el desempe√±o organizacional.<br><br>`;
      } else {
        const cantAlDia = cantActivos - (cantDemorados + cantPendientes);
        texto1 += `<h4>Calidad de la Informaci√≥n:</h4>
        Del total de indicadores activos, <strong>${cantAlDia}</strong> cuentan con todas sus mediciones informadas en fecha, ` +
          `mientras que <strong>${cantActivos - cantAlDia}</strong> presentan mediciones pendientes o registradas fuera de t√©rmino.<br><br>` +
          `<strong>Consideraciones sobre los resultados:</strong> Debido a la ausencia de informaci√≥n completa en algunos indicadores, los resultados y conclusiones de este informe podr√≠an presentar ` +
          `desviaciones respecto de la situaci√≥n real. La falta de mediciones vigentes puede afectar el c√°lculo de ` +
          `promedios, tendencias y porcentajes de cumplimiento, por lo que las interpretaciones deben realizarse con ` +
          `la debida precauci√≥n y considerando estas limitaciones.<br><br>`;
      }

      p1.innerHTML = texto1;
      content1.appendChild(p1);
      // Segundo bloque: m√©tricas clave

      const metrics = document.createElement('div');
      metrics.className = 'metrics';

      const m1 = document.createElement('div');
      m1.className = 'metric';
      m1.innerHTML = `<div class="label">Destinos totales</div><div class="value"> ${cantSectores}</div>`;

      const m2 = document.createElement('div');
      m2.className = 'metric';
      m2.innerHTML = `<div class="label">Dest.c/Indicadores</div><div class="value">${cantDestinos}</div>`;

      const m3 = document.createElement('div');
      m3.className = 'metric';
      m3.innerHTML = `<div class="label">Total Indicadores</div><div class="value">${cantActivos}</div>`;

      const m4 = document.createElement('div');
      m4.className = 'metric';
      m4.innerHTML = `<div class="label">Total Mediciones</div><div class="value">${cantMediciones}</div>`;

      const m5 = document.createElement('div');
      m5.className = 'metric';
      m5.innerHTML = `<div class="label">Meses medidos</div><div class="value">${totalMeses}</div>`;

      metrics.appendChild(m1);
      metrics.appendChild(m2);
      metrics.appendChild(m3);
      metrics.appendChild(m4);
      metrics.appendChild(m5);
      content1.appendChild(metrics);

      documento.appendChild(page1);
    }


    // //üòéüòéüòé svgToPng
    // function svgToPng(svgElement, width = 300, height = 300) {
    //   return new Promise(resolve => {
    //     const svgData = new XMLSerializer().serializeToString(svgElement);
    //     const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    //     const url = URL.createObjectURL(svgBlob);

    //     const img = new Image();
    //     img.onload = () => {
    //       const canvas = document.createElement("canvas");
    //       canvas.width = width;
    //       canvas.height = height;

    //       const ctx = canvas.getContext("2d");
    //       ctx.drawImage(img, 0, 0, width, height);

    //       URL.revokeObjectURL(url);
    //       resolve(canvas.toDataURL("image/png"));
    //     };

    //     img.src = url;
    //   });
    // }


    // ===============================================================================
    // üß≤üß≤üß≤ buildIndicadoresGlobales
    // ===============================================================================
    function buildIndicadoresGlobales() {
      const { page, content } = createPage();

      // --- T√çTULO DE SECCI√ìN ---
      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Indicadores Globales';
      content.appendChild(h);

      // =======================
      // Texto introductorio
      // =======================
      const p = document.createElement('p');
      p.innerHTML = `
      El siguiente gr√°fico muestra el porcentaje de cumplimiento global organizacional correspondiente al √∫ltimo per√≠odo evaluado, resultante de ponderar
      cada indicador por su peso relativo dentro de la estructura total y por su nivel de logro
      respecto al objetivo definido.<br><br>
      `;
      content.appendChild(p);

      // =======================
      // Datos globales
      // =======================
      const valGlobales = localStorage.getItem('resumenGlobal');
      const resumenGlobal = JSON.parse(valGlobales);

      // =======================
      // Contenedor principal
      // =======================
      const bloqueResumen = document.createElement('div');
      bloqueResumen.style.display = 'flex';
      bloqueResumen.style.alignItems = 'center';
      bloqueResumen.style.gap = '28px';
      bloqueResumen.style.marginTop = '20px';

      // =======================
      // Gr√°fico (izquierda)
      // =======================
      const graf = document.createElement('div');
      graf.style.width = '200px';
      graf.style.height = '200px';
      graf.style.display = 'flex';
      graf.style.alignItems = 'center';
      graf.style.justifyContent = 'center';

      // PNG del ring
      const pngBase64 = localStorage.getItem("ringGlobalPNG");

      if (pngBase64) {
        graf.innerHTML = `
              <div style="
                  width:180px;
                  height:150px;
                  border-radius:50%;
                  background:#fff;
                  box-shadow:0 4px 12px rgba(0,0,0,0.1);
                  display:flex;
                  align-items:center;
                  justify-content:center;
              ">
                  <img src="${pngBase64}" style="width:140px; height:140px; border-radius:50%;">
              </div>
              `;
      } else {
        graf.innerHTML = `
              <div style="
                  width:180px;
                  height:150px;
                  border-radius:50%;
                  border:1px dashed #ddd;
                  display:flex;
                  align-items:center;
                  justify-content:center;
                  color:#999;
              ">
                  [Gr√°fico no disponible]
              </div>
              `;
      }

      // =======================
      // M√©tricas (derecha)
      // =======================
      const metrics = document.createElement('div');
      metrics.style.display = 'grid';
      metrics.style.gridTemplateColumns = '1fr 1fr';
      metrics.style.gridTemplateRows = '1fr 1fr';
      metrics.style.gap = '14px';
      metrics.style.height = '200px'; // igual al gr√°fico
      metrics.style.flex = '1';

      // =======================
      // Helper para fichas
      // =======================
      function crearMetric(label, valueHTML) {
        const m = document.createElement('div');
        m.className = 'metric';
        m.style.display = 'flex';
        m.style.flexDirection = 'column';
        m.style.justifyContent = 'center';
        m.style.padding = '12px 14px';
        m.style.borderRadius = '10px';
        m.style.background = '#fff';
        m.style.boxShadow = '0 2px 6px rgba(0,0,0,0.06)';

        m.innerHTML = `
        <div class="label" style="font-size:0.8em; color:#666; margin-bottom:4px;">
            ${label}
        </div>
        <div class="value" style="font-size:1.2em; font-weight:600;">
            ${valueHTML}
        </div>
    `;
        return m;
      }

      // =======================
      // M√©trica 1
      // =======================
      const m1 = crearMetric(
        'Promedio Anual',
        resumenGlobal.promAnual
      );

      // =======================
      // M√©trica 2
      // =======================
      const m2 = crearMetric(
        'Prom. Hist√≥rico',
        resumenGlobal.promHistorico
      );

      // =======================
      // M√©trica 3 (variaci√≥n)
      // =======================
      let valor = Number(resumenGlobal.variacion) || 0;
      let color = 'gray';
      let textoValor = '0';

      if (valor > 0) { textoValor = `+${valor}`; color = '#007bff'; }
      else if (valor < 0) { textoValor = `${valor}`; color = '#d9534f'; }

      const m3 = crearMetric(
        'Œî vs mes anterior',
        `<span style="color:${color}; font-weight:700;">${textoValor}</span>`
      );

      // =======================
      // M√©trica 4 (tendencia)
      // =======================
      let tendencia = resumenGlobal.tendencia || '';
      let icono = '‚ûñ';
      let colorTendencia = '#555';

      if (tendencia === 'Creciente%') { icono = 'üîº'; colorTendencia = '#007bff'; }
      else if (tendencia === 'Decreciente%') { icono = 'üîΩ'; colorTendencia = '#d9534f'; }

      const textoTendencia =
        tendencia ? tendencia.charAt(0).toUpperCase() + tendencia.slice(1) : 'Sin datos';

      const m4 = crearMetric(
        'Tendencia',
        `<span style="display:flex; align-items:center; gap:6px; color:${colorTendencia}; font-weight:700;">
            <span>${icono}</span>
            <span>${textoTendencia}</span>
        </span>`
      );

      // =======================
      // Ensamble final
      // =======================
      metrics.appendChild(m1);
      metrics.appendChild(m2);
      metrics.appendChild(m3);
      metrics.appendChild(m4);

      bloqueResumen.appendChild(graf);
      bloqueResumen.appendChild(metrics);
      content.appendChild(bloqueResumen);

      const p2 = document.createElement('p');
      p2.innerHTML = `<br><br>
      A continuaci√≥n la representaci√≥n gr√°fica de la evoluci√≥n en el tiempo del cumplimiento global organizacional.<br>
      `;
      content.appendChild(p2);

      // --- RECUPERAR GR√ÅFICO ---
      const imagenGrafico = localStorage.getItem("graficoCumplimientoGlobal");

      // --- CARD CONTENEDOR ELEGANTE ---
      const card = document.createElement("div");
      card.style.marginTop = "25px";
      card.style.padding = "10px";
      card.style.border = "1px solid #e0e0e0";
      card.style.borderRadius = "10px";
      card.style.boxShadow = "0 2px 8px rgba(0,0,0,0.05)";
      card.style.background = "#fff";

      // --- T√çTULO DEL GR√ÅFICO ---
      const tituloGraf = document.createElement("h3");
      tituloGraf.textContent = "Evoluci√≥n del Cumplimiento Global";
      tituloGraf.style.fontSize = "16px";
      tituloGraf.style.marginBottom = "5px";
      tituloGraf.style.color = "#333";
      card.appendChild(tituloGraf);

      // --- CONTENEDOR DEL GR√ÅFICO ---
      const graf2 = document.createElement("div");
      graf2.style.display = "flex";
      graf2.style.alignItems = "center";
      graf2.style.justifyContent = "center";
      graf2.style.padding = "2px 0";

      if (imagenGrafico) {
        graf2.innerHTML = `
              <img src="${imagenGrafico}" 
                  style="
                    width: 500px; height: 320px;
                    max-width: 100%;
                    border-radius: 6px;
                    border: 1px solid #ddd;
                    padding: 3px;
                    background: #fafafa;
                  ">
            `;
      } else {
        graf2.innerHTML = `
            <div style="
              width: 500px; height: 320px;
              border: 1px dashed #bbb; 
              border-radius: 6px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #777;
              background: #fafafa;
            ">
              [Gr√°fico no disponible]
            </div>
          `;
      }

      card.appendChild(graf2);

      // --- PIE DE GR√ÅFICO ---
      // const nota = document.createElement("div");
      // nota.style.marginTop = "10px";
      // nota.style.fontSize = "12px";
      // nota.style.color = "#666";
      // nota.style.textAlign = "center";
      // nota.innerHTML =
      //   "Este gr√°fico representa la evoluci√≥n mensual del porcentaje de cumplimiento consolidado en toda la organizaci√≥n.";
      // // card.appendChild(nota);

      // Insertar card en el contenido
      content.appendChild(card);

      // Agregar p√°gina final al documento
      documento.appendChild(page);
    }


    // ===============================================================================
    // üß≤üß≤üß≤ cumplimientoPorDestino
    // ===============================================================================   
    function buildCumplimientoPorDestino() {

      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Cumplimiento por Destino';
      content.appendChild(h);

      const p = document.createElement('p'); p.innerHTML = `
      Se establece como porcentaje de cumplimiento a la suma de los porcentajes de cumplimiento de cada indicador, calculados como la relaci√≥n entre el valor alcanzado y la meta establecida, ponderados seg√∫n el peso porcentual asignado a cada uno.
      <br><br>
      El estado de cumplimiento se clasifica en funci√≥n del porcentaje alcanzado, conforme a los siguientes umbrales: ‚ÄúEn Meta‚Äù para valores iguales o superiores al 90 %, ‚ÄúRiesgo‚Äù para valores comprendidos entre el 70 % y el 89 %, y ‚ÄúCr√≠tico‚Äù para valores inferiores al 70 %.`;
      content.appendChild(p);

      const container = document.createElement('div');
      renderCumplimientoPorDestinoInforme(container);
      content.appendChild(container);

      documento.appendChild(page);

      //ü•ºü•º obtenerCumplimientoPorDestino
      function obtenerCumplimientoPorDestino() {
        const raw = localStorage.getItem('cumplimientoPorDestino');
        if (!raw) return [];
        return JSON.parse(raw);
      }

      //ü•ºü•º renderCumplimientoPorDestinoInforme  
      function renderCumplimientoPorDestinoInforme(container) {
        const data = obtenerCumplimientoPorDestino();
        if (!data.length) return;

        const table = document.createElement('table');
        table.className = 'table table-sm table-bordered informe-table';

        table.innerHTML = `
          <thead>
            <tr>
              <th>Destino</th>
              <th>Total KPI¬¥s</th>
              <th>Cumplimiento</th>
              <th>En Meta</th>
              <th>Cr√≠ticos</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
      ${data.map(d => {
          const valor = Number(d.promedio_cumplimiento) || 0;

          let estado = 'Cr√≠tico';
          let clase = 'estado-rojo';

          if (valor >= 80) {
            estado = 'En Meta';
            clase = 'estado-verde';
          } else if (valor >= 50) {
            estado = 'En Riesgo';
            clase = 'estado-amarillo';
          }

          return `
          <tr>
            <td>${d.destino}</td>
            <td class="text-center">${d.total_indicadores}</td>
            <td class="text-center">${valor}%</td>
            <td class="text-center">${d.en_meta}</td>
            <td class="text-center">${d.criticos}</td>
            <td class="text-center ${clase}">${estado}</td>
          </tr>
                  `;
        }).join('')}
              </tbody>
            `;

        container.appendChild(table);
      }

    }


    // =========================================
    //üòéüòéüòé getSemaforo
    // =========================================
    function getSemaforo(valor) {
      if (valor >= 90) return 'üü¢';
      if (valor >= 70) return 'üü°';
      return 'üî¥';
    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildUltimoMes
    // ===============================================================================
    function buildUltimoMes() {

      const dataPDF = JSON.parse(
        localStorage.getItem('detalleUltimoMesPDF')
      );

      if (!dataPDF || !Array.isArray(dataPDF.indicadores)) {
        const { page, content } = createPage();
        const h = document.createElement('h2');
        h.className = 'section-title';
        h.textContent = 'Composici√≥n de la √∫ltima medici√≥n';
        content.appendChild(h);

        const warn = document.createElement('p');
        warn.textContent = 'No hay datos disponibles para este per√≠odo.';
        content.appendChild(warn);
        documento.appendChild(page);
        return;
      }

      // Agrupar por destino
      const grupos = dataPDF.indicadores.reduce((acc, d) => {
        if (!acc[d.destinoNombre]) acc[d.destinoNombre] = [];
        acc[d.destinoNombre].push(d);
        return acc;
      }, {});

      // Ordenar indicadores por cumplimiento DESC
      Object.keys(grupos).forEach(destino => {
        grupos[destino].sort((a, b) => b.cumplimiento - a.cumplimiento);
      });

      // Variables de paginaci√≥n
      let currentPage = null;
      let currentContent = null;
      let alturaAcumulada = 0;
      const MAX_ALTURA = 950; // Altura m√°xima antes de crear nueva p√°gina (ajustar seg√∫n necesites)
      let esPrimeraPagina = true;

      // Iniciar primera p√°gina
      iniciarNuevaPagina();

      // Renderizar por destino
      Object.keys(grupos).forEach(destino => {
        const indicadores = grupos[destino];

        // Calcular altura estimada del destino completo
        const alturaDestino = 40; // T√≠tulo del destino
        const alturaEncabezadoTabla = 35;
        const alturaFilaPorIndicador = 30;
        const alturaTotal = alturaDestino + alturaEncabezadoTabla +
          (indicadores.length * alturaFilaPorIndicador) + 20;

        // Si el destino completo cabe en la p√°gina actual
        if (alturaAcumulada + alturaTotal < MAX_ALTURA) {
          // Renderizar destino completo
          renderizarDestino(destino, indicadores);
          alturaAcumulada += alturaTotal;
        } else {
          // Necesitamos dividir o crear nueva p√°gina

          // Si apenas empezamos la p√°gina, renderizar lo que se pueda
          if (alturaAcumulada < 200) {
            renderizarDestino(destino, indicadores);
            alturaAcumulada += alturaTotal;
          } else {
            // Crear nueva p√°gina y renderizar ah√≠
            iniciarNuevaPagina();
            renderizarDestino(destino, indicadores);
            alturaAcumulada += alturaTotal;
          }
        }

      });

      // TOTAL GENERAL al final
      // Verificar si cabe en la p√°gina actual
      if (alturaAcumulada + 50 > MAX_ALTURA) {
        iniciarNuevaPagina();
      }

      const total = document.createElement('p');
      total.style.marginTop = '12px';
      total.innerHTML = `
        <strong>Total contribuci√≥n del per√≠odo:</strong>
        ${dataPDF.totalContribucion.toFixed(2)}%
      `;
      currentContent.appendChild(total);


      //üòéüòéüòé iniciarNuevaPagina
      function iniciarNuevaPagina() {
        const { page, content } = createPage();
        currentPage = page;
        currentContent = content;
        alturaAcumulada = 0;

        // Solo en la primera p√°gina agregar t√≠tulo y descripci√≥n
        if (esPrimeraPagina) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = 'Composici√≥n de la √∫ltima medici√≥n';
          currentContent.appendChild(h);

          const p = document.createElement('p');
          p.innerHTML = `
              Valor de los indicadores que conforman la √∫ltima medici√≥n<br>
            `;
          currentContent.appendChild(p);

          const sub = document.createElement('h4');
          sub.textContent = `Per√≠odo: ${dataPDF.month}`;
          currentContent.appendChild(sub);

          alturaAcumulada = 180; // Altura estimada del encabezado
          esPrimeraPagina = false;
        } else {
          // En p√°ginas siguientes, agregar continuaci√≥n
          const cont = document.createElement('h3');
          cont.textContent = 'Composici√≥n de la √∫ltima medici√≥n(continuaci√≥n)';
          cont.style.fontSize = '16px';
          cont.style.marginBottom = '10px';
          currentContent.appendChild(cont);
          alturaAcumulada = 60;
        }

        documento.appendChild(currentPage);
      }


      //üòéüòéüòé renderizarDestino
      function renderizarDestino(destino, indicadores) {
        // --- T√≠tulo del destino ---
        const hDestino = document.createElement('h4');
        hDestino.style.marginTop = '16px';
        hDestino.textContent = destino;
        currentContent.appendChild(hDestino);

        // --- Tabla del destino ---
        const table = document.createElement('table');
        table.className = 'tabla-indicadores';

        table.innerHTML = `
            <thead>
              <tr>
                <th></th>
                <th>Indicador</th>
                <th>Cumplimiento</th>
                <th>Peso</th>
                <th>Contribuci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

        const tbody = table.querySelector('tbody');

        indicadores.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="text-align:center">${getSemaforo(d.cumplimiento)}</td>
            <td>${d.indicador}</td>
            <td>${d.cumplimiento.toFixed(2)}%</td>
            <td>${d.peso.toFixed(2)}%</td>
            <td><strong>${d.contribucion.toFixed(2)}%</strong></td>
          `;
          tbody.appendChild(tr);
        });

        currentContent.appendChild(table);
      }


    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildIndicadoresPorContribucion
    // ===============================================================================
    function buildIndicadoresPorContribucion() {

      const dataPDF = JSON.parse(
        localStorage.getItem('detalleUltimoMesPDF')
      );

      if (!dataPDF || !Array.isArray(dataPDF.indicadores)) {
        const { page, content } = createPage();
        const h = document.createElement('h2');
        h.className = 'section-title';
        h.textContent = 'Indicadores por Contribuci√≥n';
        content.appendChild(h);

        const warn = document.createElement('p');
        warn.textContent = 'No hay datos disponibles para este per√≠odo.';
        content.appendChild(warn);
        documento.appendChild(page);
        return;
      }

      // Ordenar por contribuci√≥n DESC
      const indicadoresOrdenados = [...dataPDF.indicadores].sort(
        (a, b) => b.contribucion - a.contribucion
      );

      // Variables de paginaci√≥n
      let currentPage = null;
      let currentContent = null;
      let alturaAcumulada = 0;
      const MAX_ALTURA = 950;
      let esPrimeraPagina = true;

      // Iniciar primera p√°gina
      iniciarNuevaPagina();


      // Crear tabla √∫nica
      const table = document.createElement('table');
      table.className = 'tabla-indicadores';

      table.innerHTML = `
          <thead>
            <tr>
              <th></th>
              <th>Indicador</th>
              <th>Destino</th>
              <th>Cumplimiento</th>
              <th>Peso</th>
              <th>Contribuci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

      const tbody = table.querySelector('tbody');
      currentContent.appendChild(table);
      alturaAcumulada += 35; // Encabezado de tabla

      // Agregar filas
      indicadoresOrdenados.forEach((d, index) => {
        const alturaFila = 30;

        // Si nos pasamos de altura, crear nueva p√°gina
        if (alturaAcumulada + alturaFila > MAX_ALTURA) {
          iniciarNuevaPagina();

          // Crear nueva tabla en la nueva p√°gina
          const nuevaTable = document.createElement('table');
          nuevaTable.className = 'tabla-indicadores';
          nuevaTable.innerHTML = `
            <thead>
              <tr>
                <th></th>
                <th>Indicador</th>
                <th>Destino</th>
                <th>Cumplimiento</th>
                <th>Peso</th>
                <th>Contribuci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          currentContent.appendChild(nuevaTable);
          tbody = nuevaTable.querySelector('tbody');
          alturaAcumulada += 35;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center">${getSemaforo(d.cumplimiento)}</td>
            <td>${d.indicador}</td>
            <td style="font-size: 0.9em; color: #666;">${d.destinoNombre}</td>
            <td>${d.cumplimiento.toFixed(2)}%</td>
            <td>${d.peso.toFixed(2)}%</td>
            <td><strong>${d.contribucion.toFixed(2)}%</strong></td>
          `;
        tbody.appendChild(tr);
        alturaAcumulada += alturaFila;
      });

      // TOTAL GENERAL al final
      if (alturaAcumulada + 50 > MAX_ALTURA) {
        iniciarNuevaPagina();
      }

      const total = document.createElement('p');
      total.style.marginTop = '12px';
      total.innerHTML = `
          <strong>Total contribuci√≥n del per√≠odo:</strong>
          ${dataPDF.totalContribucion.toFixed(2)}%
        `;
      currentContent.appendChild(total);



      function iniciarNuevaPagina() {
        const { page, content } = createPage();
        currentPage = page;
        currentContent = content;
        alturaAcumulada = 0;

        if (esPrimeraPagina) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = 'Indicadores por Contribuci√≥n';
          currentContent.appendChild(h);

          const p = document.createElement('p');
          p.innerHTML = `
            A continuaci√≥n se presentan todos los indicadores ordenados por su 
            contribuci√≥n al cumplimiento global, de mayor a menor impacto.<br>
          `;
          currentContent.appendChild(p);

          const sub = document.createElement('h4');
          sub.textContent = `Per√≠odo: ${dataPDF.month}`;
          currentContent.appendChild(sub);

          alturaAcumulada = 180;
          esPrimeraPagina = false;
        } else {
          const cont = document.createElement('h3');
          cont.textContent = 'Indicadores por Contribuci√≥n (continuaci√≥n)';
          cont.style.fontSize = '16px';
          cont.style.marginBottom = '10px';
          currentContent.appendChild(cont);
          alturaAcumulada = 60;
        }

        documento.appendChild(currentPage);
      }


    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildBSC
    // ===============================================================================
    function buildBSC() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'BSC - Balanced Scorecard';

      content.appendChild(h);

      const p0 = document.createElement('p'); p0.innerHTML = `
      <b>1. Gr√°fico de cumplimiento promedio.</b><br>
      A continuaci√≥n se presentan los resultados obtenidos en las distintas perspectivas del BSC durante el per√≠odo evaluado.
      `;
      content.appendChild(p0);

      const imgBSC = localStorage.getItem("graficoBSC_Barras");
      if (!imgBSC) {
        console.warn("No se encontr√≥ el gr√°fico BSC en localStorage");
      }

      // --- CONTENEDOR DEL GR√ÅFICO ---
      const graf2 = document.createElement("div");
      graf2.style.display = "flex";
      graf2.style.alignItems = "center";
      graf2.style.justifyContent = "center";
      graf2.style.padding = "5px 0";

      if (imgBSC) {
        graf2.innerHTML = `
          <img src="${imgBSC}" 
              style="
                width: 1000px;
                max-width: 100%;
                max-height: 330px;
                height: auto;
                object-fit: contain;
                border-radius: 6px;
                border: 1px solid #ddd;
                padding: 6px;
                background: #fafafa;
                display: block;
                margin: 0 auto;
              ">
        `;
      } else {
        graf2.innerHTML = `
            <div style="
              width: 520px; height: 220px;
              border: 1px dashed #bbb; 
              border-radius: 6px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #777;
              background: #fafafa;
            ">
              [Gr√°fico no disponible]
            </div>
          `;
      }

      content.appendChild(graf2);
      localStorage.removeItem("graficoBSC_Barras");

      // --- PUNTO 2: TABLA DE PERSPECTIVAS ---
      const tituloTabla = document.createElement('p');
      tituloTabla.innerHTML = `<br><br>
          <b>2. Tabla de perspectivas.</b><br>
          Valores promedios y ponderados seg√∫n el peso relativo asignado a cada indicador incluido en cada perspectiva.
          `;
      content.appendChild(tituloTabla);

      // insertar tabla
      const resumenPorDimension = JSON.parse(
        localStorage.getItem("resumenPorDimension") || "[]"
      );
      const tablaPerspectivas = buildTablaPerspectivas(resumenPorDimension);
      content.appendChild(tablaPerspectivas);

      documento.appendChild(page);


      //üòéüòéüòé buildTablaPerspectivas
      function buildTablaPerspectivas(resumenPorDimension) {
        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.style.marginTop = "12px";
        table.style.fontSize = "12px";

        table.innerHTML = `
        <thead>
            <tr style="background:#f0f0f0">
                <th style="border:1px solid #999; padding:6px">Perspectiva</th>
                <th style="border:1px solid #999; padding:6px; text-align:center">Indicadores</th>
                <th style="border:1px solid #999; padding:6px; text-align:center">Promedio</th>
                <th style="border:1px solid #999; padding:6px; text-align:center">Ponderado</th>
                <th style="border:1px solid #999; padding:6px; text-align:center">Estado</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;

        const tbody = table.querySelector("tbody");

        let totalPromedio = 0;
        let totalPonderado = 0;
        let totalIndicadores = 0;

        resumenPorDimension.forEach(d => {
          totalPromedio += Number(d.promedio) || 0;
          totalPonderado += Number(d.promedioPon) || 0;
          totalIndicadores += d.indicadores.length;

          const estado = d.promedioPon >= 80 ? 'Alto' :
            d.promedioPon >= 50 ? 'Medio' : 'Bajo';

          const color = d.promedioPon >= 80 ? '#d4edda' :
            d.promedioPon >= 50 ? '#fff3cd' : '#f8d7da';

          tbody.insertAdjacentHTML("beforeend", `
            <tr style="background:${color}">
                <td style="border:1px solid #999; padding:6px">${d.dimension}</td>
                <td style="border:1px solid #999; padding:6px; text-align:center">${d.indicadores.length}</td>
                <td style="border:1px solid #999; padding:6px; text-align:center">${Number(d.promedio).toFixed(1)}%</td>
                <td style="border:1px solid #999; padding:6px; text-align:center">${Number(d.promedioPon).toFixed(1)}%</td>
                <td style="border:1px solid #999; padding:6px; text-align:center">${estado}</td>
            </tr>
            `);
        });

        const promedioOrg = resumenPorDimension.length
          ? (totalPromedio / resumenPorDimension.length).toFixed(1)
          : 0;

        const ponderadoOrg = (totalPonderado / resumenPorDimension.length).toFixed(1);
        const estadoOrg = ponderadoOrg >= 80 ? 'Alto' :
          ponderadoOrg >= 50 ? 'Medio' : 'Bajo';

        const colorOrg = ponderadoOrg >= 80 ? '#c3e6cb' :
          ponderadoOrg >= 50 ? '#ffeeba' : '#f5c6cb';

        // üîπ FILA TOTAL ORGANIZACIONAL
        tbody.insertAdjacentHTML("beforeend", `
        <tr style="font-weight:bold; background:${colorOrg}">
            <td style="border:2px solid #555; padding:6px">TOTAL ORGANIZACIONAL</td>
            <td style="border:2px solid #555; padding:6px; text-align:center">${totalIndicadores}</td>
            <td style="border:2px solid #555; padding:6px; text-align:center">${promedioOrg}%</td>
            <td style="border:2px solid #555; padding:6px; text-align:center">${ponderadoOrg}%</td>
            <td style="border:2px solid #555; padding:6px; text-align:center">${estadoOrg}</td>
        </tr>
    `);
        return table;
        localStorage.removeItem("resumenPorDimension");
      }

    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildBSCPerspectiva
    // ===============================================================================
    function buildBSCPerspectiva() {

      const { page, content } = createPage();

      // üì¶ Contenedor del detalle
      const detalleContainer = document.createElement("div");
      detalleContainer.id = "detallePerspectivasInforme";
      content.appendChild(detalleContainer);

      // üß† Render directo, SIN document.getElementById
      renderDetallePorPerspectivaHTML(detalleContainer);

      // üî¥ Reci√©n ahora entra al DOM
      documento.appendChild(page);


      // üòéüòéüòé renderDetallePorPerspectivaHTML
      function renderDetallePorPerspectivaHTML() {

        const detalle = JSON.parse(
          localStorage.getItem("detalleIndicadoresPorPerspectiva")
        );

        if (!detalle) return;

        Object.values(detalle).forEach((perspectiva, index) => {

          const { page, content } = createPage();

          // üü¢ SOLO EN LA PRIMERA P√ÅGINA
          if (index === 0) {
            const h2 = document.createElement('h2');
            h2.className = 'section-title';
            h2.textContent = 'BSC - Balanced Scorecard';
            content.appendChild(h2);

            const p0 = document.createElement('p');
            p0.innerHTML = `
            <b>3. Detalle de Indicadores por Perspectiva.</b><br>
            Indicadores agrupados seg√∫n la perspectiva del BSC a la que pertenecen,
            mostrando su desempe√±o individual y contribuci√≥n al cumplimiento global.<br>
          `;
            content.appendChild(p0);
          }

          // üîπ T√çTULO DE LA PERSPECTIVA

          if (index !== 0) {
            const h2 = document.createElement('h2');
            h2.className = 'section-title';
            h2.textContent = 'BSC - Balanced Scorecard';
            content.appendChild(h2);
          }

          const h3 = document.createElement("h4");
          h3.className = "section-title";
          h3.textContent = perspectiva.titulo;
          content.appendChild(h3);

          const p = document.createElement("p");
          p.textContent = "Detalle de indicadores asociados a la perspectiva.";
          content.appendChild(p);

          const tableWrapper = document.createElement("div");
          const htmlSinIconos = eliminarUltimaColumna(perspectiva.html);
          tableWrapper.innerHTML = `
            <table class="table table-sm table-bordered mt-3">
                <thead class="table-light">
                    <tr>
                        <th>Indicador</th>
                        <th>Sector</th>
                        <th>Responsable</th>
                        <th>Valor</th>
                        <th>Cumpl.</th>
                        <th>Peso</th>
                        <th>Pond.</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                     ${htmlSinIconos}
                </tbody>
            </table>
        `;

          content.appendChild(tableWrapper);

          // üõë Evitar p√°gina en blanco
          const filas = tableWrapper.querySelectorAll("tbody tr");

          if (filas.length > 0) {
            documento.appendChild(page);
          }
        });

        function eliminarUltimaColumna(html) {
          const temp = document.createElement("div");
          temp.innerHTML = `<table><tbody>${html}</tbody></table>`;

          const filas = temp.querySelectorAll("tr");

          filas.forEach(tr => {
            const celdas = tr.querySelectorAll("td, th");
            if (celdas.length > 0) {
              celdas[celdas.length - 1].remove(); // elimina √∫ltima celda (iconos)
            }
          });

          return temp.querySelector("tbody").innerHTML;
        }

      }
    }


    // ===============================================================================
    // üß≤üß≤üß≤ buildPondeDestinosIndicadores
    // ===============================================================================
    function buildPondeDestinosIndicadores() {

      const treeData = JSON.parse(localStorage.getItem('bscTreeData'));
      if (!treeData) return;

      const PAGE_HEIGHT = 1120;
      const PAGE_PADDING = 600;
      const MAX_HEIGHT = PAGE_HEIGHT - PAGE_PADDING;

      let page, content, container;
      let currentHeight = 0;

      function newPage(withTitle = false) {
        ({ page, content } = createPage());

        if (withTitle) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = 'Ponderaci√≥n de Destinos e Indicadores';
          content.appendChild(h);

          const p = document.createElement('p');
          p.innerHTML = `
          Se muestra la estructura jer√°rquica completa de destinos (sectores,
          dependencias o procesos) y de los indicadores definidos.   Cada destino tiene asignado un peso relativo dentro del destino al que pertenece. Cada indicador incluye su peso relativo dentro del destino al que pertenece y su contribuci√≥n porcentual al cumplimiento global (combinando su peso dentro del destino y el peso de los destinos que lo contienen.)
        `;
          content.appendChild(p);
        }

        container = document.createElement('div');
        container.className = 'tree-report-container';
        content.appendChild(container);

        documento.appendChild(page);
        currentHeight = 0;
      }

      // üëâ PRIMERA P√ÅGINA (con t√≠tulo)
      newPage(true);

      function renderNode(node, level = 0) {

        const row = document.createElement('div');
        row.className = 'tree-report-row';
        row.style.marginLeft = `${level * 18}px`;
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.marginBottom = '6px';

        row.innerHTML = `
      <div>
        <span style="color:#666; font-size:12px; margin-right:6px;">
          ${node.weight?.toFixed(2) || 0}%
        </span>
        ${node.type === 'sector' || node.id === 'root'
            ? `<strong>${node.name}</strong>`
            : node.name
          }
      </div>
      <div>
        ${node.type === 'indicador'
            ? `${node.globalWeight?.toFixed(2) || 0}%`
            : ''
          }
      </div>
    `;

        container.appendChild(row);

        const rowHeight = row.offsetHeight;
        currentHeight += rowHeight;

        // üö® SALTO DE P√ÅGINA CORRECTO
        if (currentHeight > MAX_HEIGHT) {

          // nueva p√°gina SIN repetir t√≠tulo
          newPage(false);

          container.appendChild(row);
          currentHeight = rowHeight;
        }

        if (node.children && node.children.length > 0) {
          node.children.forEach(child =>
            renderNode(child, level + 1)
          );
        }
      }

      renderNode(treeData, 0);
    }


    //üòéüòéüòé nuevaPagina
    // function nuevaPagina() {
    //   const { page, content } = createPage();
    //   documento.appendChild(page);
    //   return { page, content };
    // }

    // ===============================================================================
    // üß≤üß≤üß≤ buildUsuariosDatos
    // ===============================================================================
    async function XXXbuildUsuariosDatos() {
      const { page, content } = createPage();

      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Usuarios registrados';
      content.appendChild(h);

      const p = document.createElement('p');
      p.textContent = 'Listado de usuarios registrados en el sistema.';
      content.appendChild(p);

      // üîÑ Leer usuarios
      const usuarios = await fetch('/usuarios').then(r => r.json());
      console.log('usuarios en build con datos', usuarios)

      const mapUsuarios = {};
      usuarios.forEach(u => {
        mapUsuarios[u.legajo] = `${u.apellido}, ${u.nombres}`;
      });

      renderTablaUsuariosPorJefe(content, usuarios);

      documento.appendChild(page);

      //üòéüòéüòé
      function agruparUsuariosPorJefe(usuarios) {
        const grupos = {};

        usuarios.forEach(u => {
          const key = u.legajo_jefe || 'SIN_LIDER';
          if (!grupos[key]) grupos[key] = [];
          grupos[key].push(u);
        });

        return grupos;
      }

      //üòéüòéüòé
      function renderTablaUsuariosPorJefe(container, usuarios) {

        const mapUsuarios = crearMapaUsuarios(usuarios);
        const grupos = agruparUsuariosPorJefe(usuarios);

        Object.keys(grupos).forEach(legajoJefe => {

          // üßë‚Äçüíº T√≠tulo del jefe
          const h3 = document.createElement('h3');
          h3.className = 'titulo-jefe';

          h3.textContent =
            legajoJefe === 'SIN_LIDER'
              ? 'Usuarios sin l√≠der asignado'
              : `L√≠der: ${mapUsuarios[legajoJefe] || `Legajo ${legajoJefe}`}`;

          container.appendChild(h3);

          // üìä Tabla del grupo
          const table = document.createElement('table');
          table.className = 'tabla-informe';

          table.innerHTML = `
                <thead>
                  <tr>
                    <th>Legajo</th>
                    <th>Apellido</th>
                    <th>Nombres</th>
                    <th>Cargo</th>
                    <th>Sector</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody></tbody>
              `;

          const tbody = table.querySelector('tbody');

          grupos[legajoJefe].forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.legajo}</td>
                <td>${u.apellido}</td>
                <td>${u.nombres}</td>
                <td>${u.cargo ?? '-'}</td>
                <td>${u.sector ?? '-'}</td>
                <td>${u.email ?? '-'}</td>
                <td>${u.rol ?? '-'}</td>
                <td>${u.estado ?? '-'}</td>
              `;
            tbody.appendChild(tr);
          });

          container.appendChild(table);
        });

        //üòéüòéüòé
        function crearMapaUsuarios(usuarios) {
          const map = {};
          usuarios.forEach(u => {
            map[u.legajo] = `${u.apellido}, ${u.nombres}`;
          });
          return map;
        }
      }

    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildUsuarios
    // ===============================================================================
    async function buildUsuarios() {

      const usuarios = await fetch("/usuarios").then(r => r.json());

      // üî§ Orden alfab√©tico
      usuarios.sort((a, b) => {
        const aN = `${a.apellido} ${a.nombres}`.toLowerCase();
        const bN = `${b.apellido} ${b.nombres}`.toLowerCase();
        return aN.localeCompare(bN, "es");
      });

      const FILAS_POR_PAGINA = 25;   // ‚Üê ajust√° seg√∫n tu layout PDF
      let pagina = 0;

      for (let i = 0; i < usuarios.length; i += FILAS_POR_PAGINA) {

        const bloque = usuarios.slice(i, i + FILAS_POR_PAGINA);
        const { page, content } = createPage();

        // üìå Solo en la primera p√°gina
        if (pagina === 0) {
          const h = document.createElement("h2");
          h.className = "section-title";
          h.textContent = "Usuarios registrados";
          content.appendChild(h);

          const p = document.createElement("p");
          p.textContent = "Listado de usuarios registrados en el sistema (orden alfab√©tico).";
          content.appendChild(p);
        }

        // üìä Tabla
        const table = document.createElement("table");
        table.className = "tabla-informe";

        table.innerHTML = `
      <thead>
        <tr>
          <th>Legajo</th>
          <th>Nombre</th>
          <th>Cargo</th>
          <th>Sector</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

        const tbody = table.querySelector("tbody");

        bloque.forEach(u => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${u.legajo}</td>
        <td>${u.apellido}, ${u.nombres}</td>
        <td>${u.cargo ?? "-"}</td>
        <td>${u.sector ?? "-"}</td>
        <td>${u.email ?? "-"}</td>
        <td>${u.rol ?? "-"}</td>
        <td>${u.estado ?? "-"}</td>
      `;
          tbody.appendChild(tr);
        });

        content.appendChild(table);
        documento.appendChild(page);
        pagina++;
      }
    }


    async function buildAnexoSectores() {

      const sectores = await fetch("/sectores").then(r => r.json());

      const mapa = {};
      sectores.forEach(s => {
        mapa[s.id] = { ...s, hijos: [] };
      });

      // Construir √°rbol
      const raiz = [];
      sectores.forEach(s => {
        if (s.sector_padre_id) {
          mapa[s.sector_padre_id].hijos.push(mapa[s.id]);
        } else {
          raiz.push(mapa[s.id]);
        }
      });

      const { page, content } = createPage();

      const h = document.createElement("h2");
      h.className = "section-title";
      h.textContent = "Estructura Organizacional";
      content.appendChild(h);

      const p = document.createElement("p");
      p.textContent = "Relaci√≥n jer√°rquica entre sectores y usuarios.";
      content.appendChild(p);

      const ul = document.createElement("ul");
      ul.style.fontSize = "12px";

      function renderNodo(nodo, parent) {
        const li = document.createElement("li");
        li.textContent = `${nodo.id} ‚Äì ${nodo.nombre}`;
        parent.appendChild(li);

        if (nodo.hijos.length > 0) {
          const sub = document.createElement("ul");
          nodo.hijos.forEach(h => renderNodo(h, sub));
          parent.appendChild(sub);
        }
      }

      raiz.forEach(r => renderNodo(r, ul));

      content.appendChild(ul);
      documento.appendChild(page);
    }


    async function buildAnexoSectoresII() {

      const sectores = await fetch("/sectores").then(r => r.json());
      const usuarios = await fetch("/usuarios").then(r => r.json());

      // üë• Agrupar usuarios por sector
      const usuariosPorSector = {};
      usuarios.forEach(u => {
        if (!usuariosPorSector[u.sector]) {
          usuariosPorSector[u.sector] = [];
        }
        usuariosPorSector[u.sector].push(`${u.apellido}, ${u.nombres}`);
      });

      // üå≥ Construir mapa de sectores
      const mapa = {};
      sectores.forEach(s => {
        mapa[s.id] = { ...s, hijos: [] };
      });

      const raiz = [];
      sectores.forEach(s => {
        if (s.sector_padre_id) {
          mapa[s.sector_padre_id].hijos.push(mapa[s.id]);
        } else {
          raiz.push(mapa[s.id]);
        }
      });

      const { page, content } = createPage();

      const h = document.createElement("h2");
      h.className = "section-title";
      h.textContent = "Estructura Organizacional";
      content.appendChild(h);

      const p = document.createElement("p");
      p.textContent = "Relaci√≥n funcional de sectores y usuarios registrados.";
      content.appendChild(p);

      const ul = document.createElement("ul");
      ul.style.fontSize = "16px";

      function XXXrenderNodo(nodo, parent) {
        const li = document.createElement("li");

        // üìÇ Sector
        const sectorLine = document.createElement("div");
        sectorLine.textContent = `${nodo.id} ‚Äì ${nodo.nombre}`;
        sectorLine.style.fontWeight = "bold";
        li.appendChild(sectorLine);

        // üë• Personas del sector
        const personas = usuariosPorSector[nodo.id] || [];
        const lineaPersonas = document.createElement("div");
        lineaPersonas.style.fontSize = "15px";
        lineaPersonas.style.marginLeft = "12px";
        lineaPersonas.style.marginBottom = "4px";

        if (personas.length > 0) {
          lineaPersonas.textContent = personas.sort().join("  // ");
        } else {
          lineaPersonas.textContent = "‚Äî Sin usuarios asignados ‚Äî";
          lineaPersonas.style.fontStyle = "italic";
        }

        li.appendChild(lineaPersonas);
        parent.appendChild(li);

        // üå± Hijos
        if (nodo.hijos.length > 0) {
          const sub = document.createElement("ul");
          nodo.hijos.forEach(h => renderNodo(h, sub));
          li.appendChild(sub);
        }
      }

      raiz.forEach(r => renderNodo(r, ul));
      content.appendChild(ul);
      documento.appendChild(page);


      function renderNodo(nodo, parent) {
        const li = document.createElement("li");

        // üìÇ Sector
        const sectorLine = document.createElement("div");
        sectorLine.textContent = `${nodo.id} ‚Äì ${nodo.nombre}`;
        sectorLine.style.fontWeight = "bold";
        li.appendChild(sectorLine);

        // üë• Personas del sector
        const personas = usuariosPorSector[nodo.id] || [];
        const lineaPersonas = document.createElement("div");
        lineaPersonas.style.fontSize = "15px";
        lineaPersonas.style.marginLeft = "12px";
        lineaPersonas.style.marginBottom = "4px";

        if (personas.length > 0) {
          lineaPersonas.textContent = personas.sort().join("  // ");
        } else {
          lineaPersonas.textContent = "‚Äî Sin usuarios asignados ‚Äî";
          lineaPersonas.style.fontStyle = "italic";
        }

        li.appendChild(lineaPersonas);
        parent.appendChild(li);

        // üå± Hijos
        if (nodo.hijos.length > 0) {
          const sub = document.createElement("ul");
          nodo.hijos.forEach(h => renderNodo(h, sub));
          li.appendChild(sub);
        }
      }

    }


    async function buildAnexoSectoresConUsuarios() {

      const sectores = await fetch("/sectores").then(r => r.json());
      const usuarios = await fetch("/usuarios").then(r => r.json());

      // üìå Mapa de usuarios por sector
      const usuariosPorSector = {};
      usuarios.forEach(u => {
        if (!usuariosPorSector[u.sector]) {
          usuariosPorSector[u.sector] = [];
        }
        usuariosPorSector[u.sector].push(`${u.apellido}, ${u.nombres}`);
      });

      // üìå Mapa de sectores
      const mapa = {};
      sectores.forEach(s => {
        mapa[s.id] = { ...s, hijos: [] };
      });

      // üå≥ Construir √°rbol
      const raiz = [];
      sectores.forEach(s => {
        if (s.sector_padre_id) {
          mapa[s.sector_padre_id].hijos.push(mapa[s.id]);
        } else {
          raiz.push(mapa[s.id]);
        }
      });

      const { page, content } = createPage();

      const h = document.createElement("h2");
      h.className = "section-title";
      h.textContent = "Anexo ‚Äì Sectores y Dotaci√≥n de Personal";
      content.appendChild(h);

      const p = document.createElement("p");
      p.textContent =
        "Relaci√≥n jer√°rquica de sectores con las personas asignadas a cada uno.";
      content.appendChild(p);

      function renderNodo(nodo, parent) {

        const bloque = document.createElement("div");
        bloque.style.marginLeft = "10px";

        // üìÇ Sector
        const titulo = document.createElement("div");
        titulo.style.fontWeight = "bold";
        titulo.textContent = `${nodo.id} ‚Äì ${nodo.nombre}`;
        bloque.appendChild(titulo);

        // üë• Personas
        const lista = document.createElement("div");
        lista.style.fontSize = "15px";
        lista.style.fontWeight = "bold";
        lista.style.marginLeft = "24px";
        lista.style.marginBottom = "8px";

        const personas = usuariosPorSector[nodo.id] || [];

        if (personas.length > 0) {
          lista.textContent = personas.sort().join(";  ");
        } else {
          lista.textContent = "‚Äî Sin usuarios asignados ‚Äî";
          lista.style.fontStyle = "italic";
        }

        bloque.appendChild(lista);
        parent.appendChild(bloque);

        // üå± Hijos
        nodo.hijos.forEach(h => renderNodo(h, parent));
      }

      raiz.forEach(r => renderNodo(r, content));

      documento.appendChild(page);
    }


    // ===============================================================================
    // üß≤üß≤üß≤ buildOrganigramaTextual
    // ===============================================================================
    async function buildOrganigramaTextual() {
      const { page, content } = createPage();

      const h = document.createElement('h2');
      h.className = 'section-title';
      h.textContent = 'Organigrama Institucional';
      content.appendChild(h);

      const p = document.createElement('p');
      p.textContent = 'Representaci√≥n textual de la estructura jer√°rquica de la organizaci√≥n.';
      content.appendChild(p);

      const resp = await fetch('/usuarios').then(r => r.json());
      const usuarios = Array.isArray(resp) ? resp : resp.data || resp.rows || [];
      console.log(usuarios)

      const arbol = construirArbolOrganigrama(usuarios);

      const raiz = document.createElement('div');
      raiz.className = 'org-linea org-raiz';
      raiz.textContent = 'Direcci√≥n General';
      content.appendChild(raiz);

      renderOrganigramaTextual(content, arbol);

      documento.appendChild(page);

      // üòéüòéüòé Construye √°rbol jer√°rquico
      function construirArbolOrganigrama(usuarios) {
        const map = {};
        const roots = [];

        // Normalizar legajos
        usuarios.forEach(u => {
          const legajo = String(u.legajo);
          map[legajo] = { ...u, legajo, hijos: [] };
        });

        usuarios.forEach(u => {
          const legajo = String(u.legajo);
          const jefe = u.legajo_jefe ? String(u.legajo_jefe) : null;

          if (jefe && map[jefe]) {
            map[jefe].hijos.push(map[legajo]);
          } else {
            roots.push(map[legajo]);
          }
        });

        return roots;
      }

      // üòéüòéüòé Render textual recursivo
      function renderOrganigramaTextual(container, nodos, prefijo = '') {
        nodos.forEach((nodo, index) => {
          const esUltimo = index === nodos.length - 1;

          const linea = document.createElement('div');
          linea.className = 'org-linea';

          const conector = esUltimo ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
          linea.textContent =
            prefijo +
            conector +
            `${nodo.apellido}, ${nodo.nombres}${nodo.cargo ? ' (' + nodo.cargo + ')' : ''}`;

          container.appendChild(linea);

          const nuevoPrefijo = prefijo + (esUltimo ? '    ' : '‚îÇ   ');

          if (nodo.hijos && nodo.hijos.length > 0) {
            renderOrganigramaTextual(container, nodo.hijos, nuevoPrefijo);
          }
        });
      }

    }


    // ===============================================================================
    // üß≤üß≤üß≤ buildUsuariosIndicadores
    // ===============================================================================
    let lineasActuales = 0;
    const MAX_LINEAS = 40;
    let pageActual = null;
    let contentActual = null;
    async function buildUsuariosIndicadores() {

      // üìÑ Primera p√°gina
      nuevaPagina('Relaci√≥n entre usuarios e indicadores');

      const p = document.createElement('p');
      p.textContent = 'Usuarios registrados y sus indicadores asignados.';
      contentActual.appendChild(p);
      lineasActuales += 2;

      // üîÑ Traemos usuarios e indicadores y sectores
      const [usuarios, indicadores, sectores] = await Promise.all([
        fetch('/usuarios').then(r => r.json()),
        fetch('/api/indicadores').then(r => r.json()),
        fetch('/sectores').then(r => r.json())
      ]);

      const mapSectores = {};
      sectores.forEach(s => {
        mapSectores[s.id] = s;
      });

      // üìå Agrupar indicadores por responsable (legajo)
      const indicadoresPorUsuario = {};
      indicadores.forEach(i => {
        if (!indicadoresPorUsuario[i.responsable]) {
          indicadoresPorUsuario[i.responsable] = [];
        }
        indicadoresPorUsuario[i.responsable].push(i);
      });

      const usuariosConIndicadores = [];
      const usuariosSinIndicadores = [];

      usuarios.forEach(u => {
        if (indicadoresPorUsuario[u.legajo]?.length) {
          usuariosConIndicadores.push(u);
        } else {
          usuariosSinIndicadores.push(u);
        }
      });

      renderUsuarios(
        usuariosConIndicadores,
        usuariosSinIndicadores,
        indicadoresPorUsuario,
        mapSectores
      );
      // }

      // ü•ºü•ºü•º renderTablaUsuarios
      function renderUsuarios(
        usuariosConIndicadores,
        usuariosSinIndicadores,
        indicadoresPorUsuario,
        mapSectores
      ) {
        /* USUARIOS CON INDICADORES */
        usuariosConIndicadores.forEach(u => {

          const indicadores = indicadoresPorUsuario[u.legajo] || [];

          // üßÆ L√≠neas necesarias
          const lineasUsuario =
            2 +                    // t√≠tulo usuario
            1 +                    // destino
            indicadores.length +   // indicadores
            1;                     // espacio

          agregarLineas(lineasUsuario);

          // üßç‚Äç‚ôÇÔ∏è Usuario
          const h3 = document.createElement('div');
          h3.style.fontWeight = 'bold';
          h3.style.fontSize = '18px';
          h3.textContent = `Legajo ${u.legajo} ‚Äì ${u.apellido}, ${u.nombres}`;
          contentActual.appendChild(h3);

          // üè∑Ô∏è Destino
          const destino = document.createElement('p');
          const rutaSector = u.sector
            ? obtenerRutaSector(u.sector, mapSectores)
            : 'No informado';
          destino.textContent = `Sector: ${rutaSector}`;
          contentActual.appendChild(destino);

          // üìã Indicadores
          const ul = document.createElement('ul');
          indicadores.forEach(i => {
            const li = document.createElement('li');
            li.textContent = i.nombre;
            ul.appendChild(li);
          });
          contentActual.appendChild(ul);
        });

        /* USUARIOS sin INDICADORES */
        if (usuariosSinIndicadores.length > 0) {

          const lineasSin = 2 + usuariosSinIndicadores.length;
          agregarLineas(lineasSin);

          const h3 = document.createElement('h4');
          h3.textContent = 'Usuarios sin indicadores asignados';
          contentActual.appendChild(h3);

          const ul = document.createElement('ul');
          usuariosSinIndicadores.forEach(u => {
            const li = document.createElement('li');
            li.textContent = `${u.apellido}, ${u.nombres} (Legajo ${u.legajo})`;
            ul.appendChild(li);
          });
          contentActual.appendChild(ul);
        }
      }

      // ü•ºü•ºü•º
      function obtenerRutaSector(idSector, mapSectores) {

        const ruta = [];
        let actual = mapSectores[idSector];

        while (actual) {
          ruta.unshift(actual.nombre); // agrega al inicio
          actual = actual.sector_padre_id ? mapSectores[actual.sector_padre_id] : null;
        }

        return ruta.join(' > ');
      }

      // ü•ºü•ºü•º
      function nuevaPagina(titulo = null) {
        const { page, content } = createPage();
        if (titulo) {
          const h = document.createElement('h2');
          h.className = 'section-title';
          h.textContent = titulo;
          content.appendChild(h);
        }
        documento.appendChild(page);
        pageActual = page;
        contentActual = content;
        lineasActuales = 0;
      }

      // ü•ºü•ºü•º
      function agregarLineas(lineasNecesarias) {
        if (lineasActuales + lineasNecesarias > MAX_LINEAS) {
          nuevaPagina('Usuarios e indicadores (cont.)');
        }
        lineasActuales += lineasNecesarias;
      }

    }



    //ü•ºü•ºü•º renderTreeForReport

    const PAGE_HEIGHT = 1120; // px aprox A4
    const PAGE_PADDING = 160; // header + footer + m√°rgenes
    const MAX_CONTENT_HEIGHT = PAGE_HEIGHT - PAGE_PADDING;
    const MAX_ROWS = 30;
    let usedRows = 0;

    function countSectorRows(sector) {
      let count = 1; // nombre del sector

      sector.children.forEach(child => {
        if (child.type === 'indicador') {
          count += 1;
        }
      });

      return count;
    }


    // // üèÄüèÄüèÄ renderTreeForReportPaged
    // function renderTreeForReportPaged(treeData) {

    //   let { page, content } = createPage();
    //   let currentHeight = 0;

    //   const container = document.createElement('div');
    //   container.className = 'tree-report-container';
    //   content.appendChild(container);

    //   documento.appendChild(page);

    //   function renderNode(node, level = 0) {

    //     const row = document.createElement('div');
    //     row.className = 'tree-report-row';
    //     row.style.marginLeft = `${level * 18}px`;
    //     row.style.display = 'flex';
    //     row.style.justifyContent = 'space-between';
    //     row.style.alignItems = 'center';
    //     row.style.marginBottom = '6px';

    //     row.innerHTML = `
    //         <div>
    //           <span style="color:#666; font-size:12px; margin-right:6px;">
    //             ${node.weight?.toFixed(2) || 0}%
    //           </span>
    //           ${node.type === 'sector' || node.id === 'root'
    //         ? `<strong>${node.name}</strong>`
    //         : node.name
    //       }
    //         </div>
    //         <div>
    //           ${node.type === 'indicador'
    //         ? `${node.globalWeight?.toFixed(2) || 0}%`
    //         : ''
    //       }
    //         </div>
    //       `;

    //     container.appendChild(row);

    //     const rowHeight = row.offsetHeight;
    //     currentHeight += rowHeight;

    //     // üö® Salto de p√°gina
    //     if (currentHeight > MAX_CONTENT_HEIGHT) {

    //       // crear nueva p√°gina
    //       ({ page, content } = createPage());
    //       documento.appendChild(page);

    //       // nuevo contenedor
    //       container.innerHTML = '';
    //       const newContainer = document.createElement('div');
    //       newContainer.className = 'tree-report-container';
    //       content.appendChild(newContainer);

    //       // reset
    //       currentHeight = 0;

    //       // mover fila a la nueva p√°gina
    //       newContainer.appendChild(row);
    //     }

    //     if (node.children && node.children.length > 0) {
    //       node.children.forEach(child => renderNode(child, level + 1));
    //     }
    //   }

    //   renderNode(treeData, 0);
    // }


    // üèÄüèÄüèÄ renderTreeForReport
    //   function renderTreeForReport(node, level = 0, container) {

    //     const row = document.createElement('div');
    //     row.className = 'tree-report-row';
    //     row.style.marginLeft = `${level * 18}px`;
    //     row.style.marginBottom = '6px';
    //     row.style.display = 'flex';
    //     row.style.justifyContent = 'space-between';
    //     row.style.alignItems = 'center';

    //     // üß± Parte izquierda (nombre + peso relativo)
    //     const left = document.createElement('div');
    //     left.innerHTML = `
    //   <span style="color:#666; font-size:12px; margin-right:6px;">
    //     ${node.weight?.toFixed(2) || 0}%
    //   </span>
    //   ${node.type === 'sector' || node.id === 'root'
    //         ? `<strong>${node.name}</strong>`
    //         : node.name
    //       }
    // `;

    //     // üåç Parte derecha (peso global)
    //     const right = document.createElement('div');
    //     if (node.type === 'indicador') {
    //       right.innerHTML = `
    //     <span style="font-size:12px;">
    //       ${node.globalWeight?.toFixed(2) || 0}%
    //     </span>
    //   `;
    //     }

    //     row.appendChild(left);
    //     row.appendChild(right);
    //     container.appendChild(row);

    //     if (node.children && node.children.length > 0) {
    //       node.children.forEach(child => {
    //         renderTreeForReport(child, level + 1, container);
    //       });
    //     }
    //   }

    // ===============================================================================
    // üß≤üß≤üß≤ buildAnexos
    // ===============================================================================
    function buildAnexos() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Anexos';
      content.appendChild(h);

      const p = document.createElement('p'); p.textContent = 'Listado completo de mediciones y notas metodol√≥gicas.';
      content.appendChild(p);

      documento.appendChild(page);
    }

    // ===============================================================================
    // üß≤üß≤üß≤ numerarPaginas
    // ===============================================================================
    function numerarPaginas() {
      const pages = [...document.querySelectorAll('.page')];
      pages.forEach((p, idx) => {
        const el = p.querySelector('.page-number');
        if (el) el.textContent = `P√°gina ${idx + 1} de ${pages.length}`;
      });
    }

    // ===============================================================================
    // üß≤üß≤üß≤ buildDocumento completo üß≤üß≤üß≤
    // ===============================================================================
    async function buildDocument() {
      clearDocument();
      // buildCover();
      await buildCaratula();
      await buildIndice();
      await buildMarcoIntroductorio();
      await buildResumen();
      await buildIndicadoresGlobales();
      await buildCumplimientoPorDestino();
      await buildUltimoMes();
      await buildIndicadoresPorContribucion();
      await buildBSC();
      await buildBSCPerspectiva();
      await buildPondeDestinosIndicadores();
      await buildUsuarios();
      // await buildAnexoSectores();
      await buildAnexoSectoresII();
      // await buildAnexoSectoresConUsuarios();
      await buildOrganigramaTextual();   // üëà nueva hoja
      await buildUsuariosIndicadores();
      // buildAnexos();
      numerarPaginas();
    }


    // async function XXXexportPDF() {
    //   const spinner = document.getElementById('spinnerOverlay');
    //   const spinnerText = document.getElementById('spinnerText');
    //   spinner.style.display = 'flex';
    //   spinnerText.textContent = 'Creando informe PDF, por favor espere...';
    //   // Clonar el nodo para no afectar la vista
    //   const node = documento.cloneNode(true);
    //   const filename = `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`
    //   // Opciones de html2pdf
    //   const opt = {
    //     margin: 0,
    //     filename: `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`,
    //     image: { type: 'jpeg', quality: 0.98 },
    //     html2canvas: {
    //       scale: 1.9,
    //       useCORS: true,
    //       letterRendering: true
    //     },
    //     jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    //     pagebreak: { mode: ['css'] }
    //   };

    //   const holder = document.createElement('div'); holder.style.position = 'fixed'; holder.style.left = '-9999px'; holder.style.top = '-9999px'; holder.appendChild(node);
    //   document.body.appendChild(holder);

    //   node.querySelectorAll('.page').forEach(p => {
    //     p.style.boxShadow = 'none';
    //   });

    //   try {
    //     await html2pdf().set(opt).from(node).save();
    //   } catch (e) {
    //     console.error('Error gen PDF', e);
    //     alert('Error gen PDF ‚Äî ver consola');
    //   } finally {
    //     document.body.removeChild(holder);
    //   }
    //   spinnerText.innerHTML = `‚úÖ Informe generado correctamente.<br><br>
    //                 El archivo se descarg√≥ como: ${filename}`;
    //   setTimeout(() => (spinner.style.display = 'none'), 10000);
    // }


    // ===============================================================================
    // üèÄüèÄüèÄ Exportar a PDF usando html2pdf
    // ===============================================================================
    async function exportPDF() {
      const filename = `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`;
      showPdfModal("Creando informe PDF‚Ä¶<br><small>Por favor espere</small>");
      const node = documento.cloneNode(true);

      const opt = {
        margin: 0,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 1.9, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css'] }
      };

      const holder = document.createElement('div');
      holder.style.position = 'fixed';
      holder.style.left = '-9999px';
      holder.appendChild(node);
      document.body.appendChild(holder);

      try {
        await html2pdf().set(opt).from(node).save();
        showPdfSuccess(filename);
      } catch (e) {
        console.error(e);
        alert("Error al generar PDF");
        closePdfModal();
      } finally {
        document.body.removeChild(holder);
      }
    }


    // üèÄüèÄüèÄ 
    function showPdfModal(text) {
      const modal = document.getElementById('pdfModal');
      document.getElementById('pdfSpinner').classList.remove('d-none');
      document.getElementById('pdfSuccessIcon').classList.add('d-none');
      document.getElementById('btnCerrarPdfModal').classList.add('d-none');
      document.getElementById('pdfModalText').innerHTML = text;
      modal.classList.remove('d-none');
    }

    // üèÄüèÄüèÄ 
    function showPdfSuccess(filename) {
      document.getElementById('pdfSpinner').classList.add('d-none');
      document.getElementById('pdfSuccessIcon').classList.remove('d-none');
      document.getElementById('pdfModalText').innerHTML =
        `Informe generado correctamente<br>
     <small class="text-muted">${filename}</small>`;
      document.getElementById('btnCerrarPdfModal').classList.remove('d-none');
    }

    // üèÄüèÄüèÄ 
    function closePdfModal() {
      const modal = document.getElementById('pdfModal');
      modal.classList.add('d-none');
    }


    document.addEventListener('DOMContentLoaded', () => {

      buildDocument(); // construye TODO el contenido

      const btn = document.getElementById('btn-pdf');
      if (btn) {
        btn.addEventListener('click', exportPDF);
      }

      const btnCerrar = document.getElementById('btnCerrarPdfModal');
      if (btnCerrar) {
        btnCerrar.addEventListener('click', closePdfModal);
      }

    });

  </script>
</body>

</html>