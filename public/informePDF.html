<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla Informe - myResultIQ</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --azul: #1F78FF;
      --gris: #333333;
      --gris-claro: #F2F2F2;
      --espacio: 16px;
      --page-width-mm: 210mm;
      /* A4 */
    }

    /* Reset básico */
    * {
      box-sizing: border-box
    }

    body {
      font-family: 'Roboto', system-ui, sans-serif;
      color: var(--gris);
      margin: 0;
      background: #efefef;
    }

    /* Contenedor que simula el documento */
    .doc-wrap {
      max-width: 900px;
      margin: 24px auto;
      padding: 24px
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer
    }

    /* Estilos de página (cada .page será una hoja A4 cuando se exporte a PDF) */
    .page {
      background: white;
      /* hoja */
      width: 210mm;
      /* A4 */
      min-height: 297mm;
      /* A4 */
      margin: 0 auto 12px auto;
      padding: 25mm 18mm 18mm 18mm;
      /* top right bottom left */
      position: relative;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    /* Encabezado y pie fijos en cada .page (se renderizan con cada hoja) */
    .page .header {
      position: absolute;
      top: 12mm;
      left: 18mm;
      right: 18mm;
      height: 14mm;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      border-bottom: 1px solid #eee;
      padding-bottom: 6px;
    }

    .page .footer {
      position: absolute;
      bottom: 12mm;
      left: 18mm;
      right: 18mm;
      height: 14mm;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      border-top: 1px solid #eee;
      padding-top: 6px;
    }

    /* Contenido principal (entre header y footer) */
    .content {
      padding-top: 28mm;
      padding-bottom: 22mm
    }

    /* Portada */
    .cover-hero {
      height: 140mm;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      padding: 24px;
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(31, 120, 255, 0.06), rgba(31, 120, 255, 0.02));
    }

    .cover-hero img {
      max-width: 60%;
      height: auto;
      opacity: 0.95
    }

    .cover-title {
      font-family: 'Montserrat';
      font-size: 28px;
      margin-top: 18px
    }

    .cover-sub {
      font-size: 14px;
      color: #666;
      margin-top: 8px
    }

    .cover-meta {
      margin-top: 22px;
      font-size: 12px;
      color: #444
    }

    h2.section-title {
      font-family: 'Montserrat';
      font-size: 18px;
      margin: 6px 0 12px 0;
      color: var(--azul)
    }

    /* Tarjetas de métricas */
    .metrics {
      display: flex;
      gap: 12px;
      flex-wrap: wrap
    }

    .metric {
      flex: 1 1 180px;
      background: #fff;
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03)
    }

    .metric .label {
      font-size: 12px;
      color: #666
    }

    .metric .value {
      font-size: 22px;
      font-weight: 600;
      margin-top: 6px
    }

    /* Tabla simple */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #eee;
      text-align: left;
      font-size: 13px
    }

    th {
      background: var(--gris-claro);
      font-weight: 600
    }

    /* Page break helper */
    .page-break {
      page-break-after: always;
    }

    /* TOC */
    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0
    }

    .toc-list li {
      padding: 6px 0;
      border-bottom: 1px dashed #eee
    }

    /* Responsive preview scaling */
    @media (max-width:980px) {
      .doc-wrap {
        padding: 10px
      }

      .page {
        width: 100%;
        min-height: 1200px
      }
    }
  </style>
</head>

<body>

  <div class="doc-wrap">
    <div class="toolbar">
      <button id="btn-build">Generar documento</button>
      <button id="btn-pdf">Exportar a PDF</button>
      <button id="btn-preview">Vista previa en nueva ventana</button>
      <label style="margin-left:12px;font-size:13px;color:#555">Plantilla base</label>
    </div>

    <!-- Contenedor donde el script creará las páginas -->
    <div id="documento"></div>
  </div>

  <!-- Dependencia para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    // Datos de ejemplo (luego los reemplazás por tus datos reales)
    empresa = "SEDRONAR";
    const ejemplo = {
      titulo: 'Informe de Indicadores - myResultIQ',
      subtitulo: 'Gestión, seguimiento y análisis de métricas organizacionales',
      fecha: new Date().toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' }),
      autor: 'Área de Gestión de Indicadores',
      resumen: {
        cumplimientoGlobal: '82%',
        promedioHistorico: '78.4',
        deltaMes: '+3.2%'
      },
      sectores: [
        {
          id: 1, nombre: 'Comercial', indicadores: [
            { id: 11, nombre: 'Ventas mensuales', meta: '100k', valor: '92k', estado: 'amarillo' },
            { id: 12, nombre: 'Tasa de conversión', meta: '2.5%', valor: '3.1%', estado: 'verde' }
          ]
        },
        {
          id: 2, nombre: 'Operaciones', indicadores: [
            { id: 21, nombre: 'Tiempo de respuesta', meta: '<24h', valor: '18h', estado: 'verde' },
            { id: 22, nombre: 'Incidentes críticos', meta: '0', valor: '1', estado: 'rojo' }
          ]
        }
      ]
    };

    // --- Construcción del documento (DOM) ---
    const documento = document.getElementById('documento');

    function clearDocument() { documento.innerHTML = ''; }

    function createPage() {
      const page = document.createElement('section');
      page.className = 'page';

      // header
      const header = document.createElement('div'); header.className = 'header';
      header.innerHTML = `<div>${ejemplo.titulo}</div><div>${ejemplo.fecha}</div>`;
      page.appendChild(header);

      // footer
      const footer = document.createElement('div'); footer.className = 'footer';
      footer.innerHTML = `<div>Generado por: ${ejemplo.autor}</div><div class="page-number">Página</div>`;
      page.appendChild(footer);

      // content
      const content = document.createElement('div'); content.className = 'content';
      page.appendChild(content);

      return { page, content };
    }

    function buildCover() {
      const { page, content } = createPage();
      page.querySelector('.header').style.display = 'none';
      page.querySelector('.footer').style.display = 'none';

      const cover = document.createElement('div');

      cover.className = 'cover-hero';
      const primeraPagina = document.createElement('div');
      primeraPagina.style.width = 'calc(100% - 20mm)'; // Ancho ajustado para márgenes
      primeraPagina.style.height = '277mm'; // Altura A4 menos márgenes
      primeraPagina.style.margin = '10mm';
      // primeraPagina.style.borderRadius = '5mm';
      primeraPagina.style.border = '1px solid #000';
      primeraPagina.style.borderRadius = '3mm';
      // primeraPagina.style.backgroundImage = 'url("../img/imagenEdificios.webp")';
      primeraPagina.style.backgroundImage = 'url("../dist/images/Fondomy.png")';
      primeraPagina.style.backgroundSize = 'contain';
      primeraPagina.style.backgroundPosition = 'center';
      primeraPagina.style.pageBreakAfter = 'always';

      const segundaLeyenda = document.createElement('h2');
      segundaLeyenda.innerHTML = empresa;
      segundaLeyenda.style.textAlign = 'center';
      segundaLeyenda.style.fontFamily = 'Abel, Helvetica, Arial, sans-serif';
      segundaLeyenda.style.fontSize = '35pt';
      segundaLeyenda.style.color = 'black';
      segundaLeyenda.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5), -2px -2px 4px rgba(255, 255, 255, 0.3)';
      segundaLeyenda.style.marginTop = '550px'; // Ajusta según necesites
      primeraPagina.appendChild(segundaLeyenda);
      cover.appendChild(primeraPagina);

      // contenido.appendChild(primeraPagina);

      // === Fondo dinámico ===
      // cover.style.width = "100%";
      // cover.style.height = "100%";  // ocupa toda la hoja A4
      // cover.style.minHeight = "1300px"; // altura estándar A4 a 96dpi
      // cover.style.minWidth = "794px";   // ancho estándar A4 a 96dpi

      // cover.style.backgroundImage = "url('/dist/images/Fondomy.png')";
      // cover.style.backgroundSize = "cover";
      // cover.style.backgroundPosition = "center";
      // cover.style.backgroundPositionX = "100%";
      // cover.style.backgroundRepeat = "no-repeat";

      // cover.style.padding = "80px";   // margen interior para que el texto no toque bordes
      // cover.style.display = "flex";
      // cover.style.flexDirection = "column";
      // cover.style.justifyContent = "center";
      // cover.style.alignItems = "center";

      // cover.style.padding = "120px 40px";    // para centrar mejor el contenido
      // cover.style.textAlign = "center";      // centrar texto
      // cover.style.color = "#003366";         // buen contraste
      // cover.style.position = "relative";

      // (opcional) Overlay para mejorar legibilidad


  //     cover.innerHTML = `
  //   <div style="
  //     position:absolute;
  //     inset:0;
  //     background:rgba(255,255,255,0.65);
  //     backdrop-filter: blur(3px);
  //   "></div>

  //   <div style="position:relative; z-index:2;">
  //     <div class="cover-title">${ejemplo.titulo}</div>
  //     <div class="cover-sub">${ejemplo.subtitulo}</div>
  //     <div class="cover-meta">${ejemplo.fecha} — ${ejemplo.autor}</div>
  //   </div>
  // `;

      content.appendChild(cover);
      documento.appendChild(page);
    }

    function buildTOC() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Índice';
      content.appendChild(h);

      const ul = document.createElement('ul'); ul.className = 'toc-list';
      // Generamos entradas acordes a las secciones previstas
      const entradas = ['Resumen Ejecutivo', 'Indicadores Globales', 'Indicadores por Sector', 'Análisis de Cumplimientos', 'Anexos'];
      entradas.forEach((e, i) => {
        const li = document.createElement('li'); li.textContent = `${i + 1}. ${e}`;
        ul.appendChild(li);
      });
      content.appendChild(ul);
      documento.appendChild(page);
    }

    function buildResumen() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Resumen Ejecutivo';
      content.appendChild(h);

      const metrics = document.createElement('div'); metrics.className = 'metrics';
      const m1 = document.createElement('div'); m1.className = 'metric'; m1.innerHTML = `<div class="label">Cumplimiento global</div><div class="value">${ejemplo.resumen.cumplimientoGlobal}</div>`;
      const m2 = document.createElement('div'); m2.className = 'metric'; m2.innerHTML = `<div class="label">Promedio histórico</div><div class="value">${ejemplo.resumen.promedioHistorico}</div>`;
      const m3 = document.createElement('div'); m3.className = 'metric'; m3.innerHTML = `<div class="label">Δ vs mes anterior</div><div class="value">${ejemplo.resumen.deltaMes}</div>`;
      metrics.appendChild(m1); metrics.appendChild(m2); metrics.appendChild(m3);
      content.appendChild(metrics);

      // ejemplo de grafico simple (placeholder)
      const graf = document.createElement('div'); graf.style.marginTop = '12px'; graf.innerHTML = '<div style="height:140px;border:1px dashed #ddd;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#999">[Gráfico aquí]</div>';
      content.appendChild(graf);

      documento.appendChild(page);
    }

    function buildIndicadoresGlobales() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Indicadores Globales';
      content.appendChild(h);

      // tabla de ejemplo
      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr><th>Indicador</th><th>Meta</th><th>Valor</th><th>Estado</th></tr></thead>
        <tbody>
          <tr><td>Ventas mensuales</td><td>100k</td><td>92k</td><td>AMARILLO</td></tr>
          <tr><td>Tasa de conversión</td><td>2.5%</td><td>3.1%</td><td>VERDE</td></tr>
        </tbody>
      `;
      content.appendChild(table);
      documento.appendChild(page);
    }

    function buildSectores() {
      ejemplo.sectores.forEach(sec => {
        const { page, content } = createPage();
        const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = `Indicadores - ${sec.nombre}`;
        content.appendChild(h);

        const table = document.createElement('table');
        const rows = sec.indicadores.map(ind => `
          <tr>
            <td>${ind.nombre}</td>
            <td>${ind.meta}</td>
            <td>${ind.valor}</td>
            <td>${ind.estado.toUpperCase()}</td>
          </tr>
        `).join('');
        table.innerHTML = `<thead><tr><th>Indicador</th><th>Meta</th><th>Valor</th><th>Estado</th></tr></thead><tbody>${rows}</tbody>`;
        content.appendChild(table);

        documento.appendChild(page);
      });
    }

    function buildAnexos() {
      const { page, content } = createPage();
      const h = document.createElement('h2'); h.className = 'section-title'; h.textContent = 'Anexos';
      content.appendChild(h);

      const p = document.createElement('p'); p.textContent = 'Listado completo de mediciones y notas metodológicas.';
      content.appendChild(p);

      documento.appendChild(page);
    }

    // Cuando se arma el documento numeramos las páginas (footer .page-number)
    function numerarPaginas() {
      const pages = [...document.querySelectorAll('.page')];
      pages.forEach((p, idx) => {
        const el = p.querySelector('.page-number');
        if (el) el.textContent = `Página ${idx + 1} de ${pages.length}`;
      });
    }

    // Build completo
    function buildDocument() {
      clearDocument();
      buildCover();
      buildTOC();
      buildResumen();
      buildIndicadoresGlobales();
      buildSectores();
      buildAnexos();
      numerarPaginas();
    }

    // Exportar a PDF usando html2pdf
    async function exportPDF() {
      // Clonar el nodo para no afectar la vista
      const node = documento.cloneNode(true);

      // Opciones de html2pdf
      const opt = {
        margin: [18, 12, 18, 12], // mm [top, left, bottom, right]
        filename: `Informe_myResultIQ_${new Date().toISOString().slice(0, 10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      // html2pdf requiere que el nodo esté en el DOM en algunos navegadores; lo insertamos oculto temporalmente
      const holder = document.createElement('div'); holder.style.position = 'fixed'; holder.style.left = '-9999px'; holder.style.top = '-9999px'; holder.appendChild(node);
      document.body.appendChild(holder);
      try {
        await html2pdf().set(opt).from(node).save();
      } catch (e) {
        console.error('Error generando PDF', e);
        alert('Error generando PDF — ver consola');
      } finally {
        document.body.removeChild(holder);
      }
    }

    // Abrir vista previa en nueva ventana (serializamos el HTML del documento)
    function previewNewWindow() {
      const w = window.open('about:blank', '_blank');
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>Preview</title>` +
        '<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">' +
        '<style>body{margin:0;padding:0;background:#ddd}.page{margin:12px auto}</style></head><body>' + documento.innerHTML + '</body></html>';
      w.document.open(); w.document.write(html); w.document.close();
    }

    // Eventos
    document.getElementById('btn-build').addEventListener('click', () => { buildDocument(); window.scrollTo(0, 0); });
    document.getElementById('btn-pdf').addEventListener('click', () => { exportPDF(); });
    document.getElementById('btn-preview').addEventListener('click', () => { previewNewWindow(); });

    // Auto-build initial
    buildDocument();
  </script>
</body>

</html>