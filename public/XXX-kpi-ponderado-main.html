<!DOCTYPE html>
<html lang="es">

<head>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>myResultIQ | Ponderaci√≥n de Entidades e Indicadores</title>
  <!--begin::Primary Meta Tags-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="title" content="AdminLTE v4 | Dashboard" />
  <meta name="author" content="ColorlibHQ" />
  <meta name="description"
    content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS." />
  <meta name="keywords"
    content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard" />
  <!--end::Primary Meta Tags-->

  <!--begin::Fonts-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
    integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" />
  <!--end::Fonts-->

  <!--begin::Third Party Plugin(OverlayScrollbars)-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
    integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous" />
  <!--end::Third Party Plugin(OverlayScrollbars)-->

  <!--begin::Third Party Plugin(Bootstrap Icons)-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous" />
  <!--end::Third Party Plugin(Bootstrap Icons)-->

  <!--begin::Required Plugin(AdminLTE)-->
  <link rel="stylesheet" href="../css/estilos-custom.css">
  <!--end::Required Plugin(AdminLTE)-->

  <!-- apexcharts -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
    integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />

  <!-- jsvectormap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
    integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- AdminLTE se basa en Bootstrap, as√≠ que hay que incluirlo primero:-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!--  Bootstrap Icons (Para que <i class="bi bi-..."> funcione) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!--  AdminLTE CSS (Estilos del template)-->
  <link rel="stylesheet" href="../css/adminlte.css" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">

  <style>
    /* Contenedor de cada nodo */
    .node-container {
      border-left: 2px solid #dee2e6;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* Cabecera con √≠cono y t√≠tulo */
    .node-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* √çcono de nodo */
    .node-header i {
      width: 16px;
      text-align: center;
    }

    /* Input de peso */
    .weight-input {
      width: 75px;
      text-align: right;
    }

    /* Barra de progreso */
    .progress {
      height: 6px;
      background-color: #e9ecef;
      border-radius: 3px;
      margin-top: 4px;
    }

    .progress-bar {
      height: 100%;
      transition: width 0.3s ease;
    }

    /* Mensaje de error */
    .error-msg {
      font-size: 0.8rem;
      color: var(--bs-danger);
      margin-top: 4px;
    }

    /* Colores diferenciados */
    .node-sector .node-header {
      background-color: #f0f8ff;
      /* celeste suave */
      font-weight: 600;
    }

    .node-indicador .node-header {
      background-color: #fff;
    }

    /* Sangr√≠a seg√∫n nivel */
    .children-container {
      margin-left: 20px;
      margin-top: 0.5rem;
    }
  </style>


</head>

<body>

  <h2>Ponderaci√≥n de Entidades e Indicadores</h2>
  <div id="treeContainer" class="list-group"></div>

  <script>

    // üé≤üé≤üé≤ Arma el √°rbol
    async function fetchData() {
      const response = await fetch('/api/arbol-jstree');
      const flatNodes = await response.json();

      const sectores = flatNodes.filter(n => n.type === 'sector');
      const indicadores = flatNodes.filter(n => n.type === 'indicador');

      const sectorMap = {};
      sectores.forEach(s => {
        sectorMap[s.id] = {
          ...s,
          children: [],
          weight: Number(s.weight) || 0,  // usar porcentaje real de la BD
          value: 0
        };
      });

      // Asignar sectores hijos
      sectores.forEach(s => {
        if (s.parent !== "#") {
          if (sectorMap[s.parent]) {
            sectorMap[s.parent].children.push(sectorMap[s.id]);
            sectorMap[s.id].parentNode = sectorMap[s.parent];
          }
        }
      });

      // Asignar indicadores a sectores
      indicadores.forEach(ind => {
        const parentSector = sectorMap[ind.parent];
        if (parentSector) {
          const indNode = {
            ...ind,
            weight: Number(ind.weight) || 0, // usar porcentaje real de la BD
            value: 0,
            children: [],
            parentNode: parentSector
          };
          parentSector.children.push(indNode);
        }
      });

      // Buscar ra√≠ces
      const roots = sectores
        .filter(s => s.parent === "#")
        .map(s => sectorMap[s.id]);

      return {
        id: 'root',
        name: 'Organizaci√≥n',
        weight: 100,
        value: 0,
        children: roots,
        parentNode: null
      };
    }

    // üé≤üé≤üé≤ Guarda % en base de datos
    async function updateWeightInDB(nodeId, type, newWeight) {
      try {
        let url;
        let body;

        if (type === 'sector') {
          url = `/api/sectores/${nodeId}`;
          body = { sector_porcentual: newWeight };
        } else if (type === 'indicador') {
          url = `/api/indicadores/${nodeId}`;
          body = { peso_porcentual: newWeight };
        } else {
          console.warn("Tipo de nodo desconocido:", type);
          return;
        }

        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`Error al actualizar en la BD: ${response.statusText}`);
        }

        console.log(`‚úÖ Peso actualizado para ${type} ${nodeId}: ${newWeight}%`);
      } catch (err) {
        console.error("‚ùå No se pudo actualizar en la BD:", err);
      }
    }


    // üé≤üé≤üé≤ Calcula valores y verifica pesos
    function calculateValues(node) {
      if (node.children && node.children.length > 0) {
        let total = 0;
        node.children.forEach(child => {
          calculateValues(child);
          total += (child.value || 0) * (child.weight || 0) / 100;
        });
        node.value = total;
      }
    }


    function checkWeights(parentNode) {
      let sum = 0;
      if (!parentNode.children) return true;
      parentNode.children.forEach(c => {
        sum += Number(c.weight) || 0;
      });
      return Math.abs(sum - 100) < 0.001;
    }


    function buildTree(node, parentNode = null) {
      node.parentNode = parentNode;
      const container = document.createElement('div');
      container.className = 'list-group-item node-container node-' + node.type; // usa estilo AdminLTE/list-group

      // Cabecera con input y nombre
      const header = document.createElement('div');
      header.className = 'node-header';

      // √çcono por tipo
      const icon = document.createElement('i');
      icon.className = node.type === 'sector' ? 'fas fa-sitemap' : 'fas fa-chart-line';
      header.appendChild(icon);

      if (node.id !== 'root') {
        const weightInput = document.createElement('input');
        weightInput.type = 'number';
        weightInput.min = 0;
        weightInput.max = 100;
        weightInput.step = 0.01; // Permite decimales
        weightInput.value = node.weight.toFixed(2);
        weightInput.className = 'form-control form-control-sm weight-input';
        weightInput.title = 'Peso relativo (%)';
        header.appendChild(weightInput);

        weightInput.addEventListener('change', async () => {
          let val = Number(weightInput.value);
          if (isNaN(val) || val < 0) val = 0;
          if (val > 100) val = 100;
          node.weight = val;

          // Recalcular valores
          calculateValues(getRootNode(node));

          // Control de 100%
          if (!checkWeights(node.parentNode)) {
            node.parentNode._errorMsg.style.display = 'block';
          } else {
            node.parentNode._errorMsg.style.display = 'none';
          }

          // Guardar en BD
          try {
            await fetch(`/api/update-weight`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: node.id,
                type: node.type, // 'sector' o 'indicador'
                weight: val
              })
            });
          } catch (err) {
            console.error('Error guardando en BD', err);
          }

          refreshUI();
        });

        node._weightInput = weightInput;
      }

      const title = document.createElement('span');
      title.textContent = node.name || node.text;
      header.appendChild(title);

      container.appendChild(header);

      // Barra de progreso
      const progress = document.createElement('div');
      progress.className = 'progress';
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      bar.style.width = `${node.value?.toFixed(1) || 0}%`;
      // progress.appendChild(bar);
      // container.appendChild(progress);

      // Mensaje de error (solo para nodos con hijos)
      if (node.children && node.children.length > 0) {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-msg';
        errorMsg.textContent = 'La suma de los pesos de este nivel debe ser 100%';
        errorMsg.style.display = checkWeights(node) ? 'none' : 'block';
        container.appendChild(errorMsg);
        node._errorMsg = errorMsg;
      }

      // Hijos recursivos
      if (node.children && node.children.length > 0) {
        const childrenContainer = document.createElement('div');
        node.children.forEach(child => {
          childrenContainer.appendChild(buildTree(child, node));
        });
        container.appendChild(childrenContainer);
      }

      node._progressBar = bar;
      return container;
    }

    function refreshUI() {
      function updateNode(node) {
        if (node._progressBar) { node._progressBar.style.width = `${node.value?.toFixed(1) || 0}%`; }
        if (node._weightInput) { node._weightInput.value = node.weight.toFixed(2); }
        if (node._errorMsg) node._errorMsg.style.display = checkWeights(node) ? 'none' : 'block';
        if (node.children && node.children.length > 0) { node.children.forEach(updateNode); }
      }
      updateNode(window.treeRoot);
    }

    function getRootNode(node) {
      while (node.parentNode) {
        node = node.parentNode;
      }
      return node;
    }

    // MAIN
    (async () => {
      window.treeRoot = await fetchData();
      calculateValues(window.treeRoot);
      const container = document.getElementById('treeContainer');
      container.innerHTML = '';
      container.appendChild(buildTree(window.treeRoot));
    })();
  </script>


</body>

</html>