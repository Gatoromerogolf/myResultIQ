<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>√Årbol de Indicadores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" rel="stylesheet">
    <style>
        #tree {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="p-4">

<div class="container">
    <h3>üìä Indicadores por Estructura</h3>
    <div id="tree"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="indicadoresModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Indicadores</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Responsable</th>
            </tr>
          </thead>
          <tbody id="tablaIndicadores"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
    // Datos de ejemplo
    const indicadores = [
        { id: 'ind1', nombre: 'Tiempo de ciclo de compra', responsable: 'Juan', nodo: 'u1' },
        { id: 'ind2', nombre: 'Nivel de satisfacci√≥n del cliente', responsable: 'Ana', nodo: 'u1' },
        { id: 'ind3', nombre: 'Tasa de rotaci√≥n del personal', responsable: 'Luis', nodo: 'u2' },
        { id: 'ind4', nombre: 'Rentabilidad operativa', responsable: 'Mar√≠a', nodo: 'u2' },
        { id: 'ind5', nombre: 'Margen bruto', responsable: 'Jos√©', nodo: 'u3' },
        { id: 'ind6', nombre: 'Productividad operativa', responsable: 'Laura', nodo: 'u3' },
    ];

    const estructura = [
        { id: 'a1', parent: '#', text: '√Årea Funcional A', type: 'area' },
        { id: 'u1', parent: 'a1', text: 'Unidad 1', type: 'unidad' },
        { id: 'u2', parent: 'a1', text: 'Unidad 2', type: 'unidad' },
        { id: 'u3', parent: 'a1', text: 'Unidad 3', type: 'unidad' },
    ];

    // Calcular indicadores acumulados por nodo
    function contarIndicadores(nodoId) {
        const hijos = $('#tree').jstree().get_node(nodoId).children_d;
        const idsNodos = [nodoId, ...hijos];
        return indicadores.filter(ind => idsNodos.includes(ind.nodo));
    }

    // Agregar cantidades al texto de cada nodo
    function actualizarContadores() {
        estructura.forEach(nodo => {
            const total = contarIndicadores(nodo.id).length;
            nodo.text = nodo.text.split(' (')[0] + ` (${total})`;
        });
    }

    actualizarContadores();

    // Inicializar jsTree
    $('#tree').jstree({
        core: {
            data: estructura
        }
    });

    // Evento al hacer click en un nodo
    $('#tree').on("select_node.jstree", function (e, data) {
        const lista = contarIndicadores(data.node.id);
        const tbody = document.getElementById("tablaIndicadores");
        tbody.innerHTML = '';
        lista.forEach(ind => {
            tbody.innerHTML += `<tr>
                <td>${ind.id}</td>
                <td>${ind.nombre}</td>
                <td>${ind.responsable}</td>
            </tr>`;
        });
        new bootstrap.Modal(document.getElementById('indicadoresModal')).show();
    });
</script>

</body>
</html>
